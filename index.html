
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMS Guru Rizal - V17 (Ultimate Integrated)</title>

    <!-- 1. LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a' }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- EXCEL EXPORT LIBRARY -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <!-- MathJax Config -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        /* BASE UI TWEAKS */
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        
        .hidden-section { display: none !important; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); }
        
        /* LOADER */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #2563eb; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* MATH GRID */
        .math-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 8px; max-height: 120px; overflow-y: auto; padding: 4px; }
        .math-btn { 
            padding: 8px; background: #fff; border: 1px solid #cbd5e1; border-radius: 8px; 
            cursor: pointer; font-family: 'Times New Roman', serif; font-style: italic; font-size: 1.1em; 
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .math-btn:hover { background: #eff6ff; border-color: #3b82f6; color: #1d4ed8; transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* TOOLS & ACCORDION */
        .tool-btn { padding: 8px; border-radius: 8px; color: #475569; background: white; border: 1px solid #e2e8f0; transition: all 0.2s; cursor: pointer; }
        .tool-btn:hover { background: #eff6ff; color: #2563eb; border-color: #bfdbfe; }
        
        .custom-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: #2563eb; }
        
        .accordion-content { transition: max-height 0.3s ease-out, opacity 0.3s ease-out; max-height: 0; opacity: 0; overflow: hidden; }
        .accordion-content.open { max-height: 500px; opacity: 1; }
        .rotate-180 { transform: rotate(180deg); }

        /* EXAM SPECIFIC STYLES */
        .question-card { border-left: 4px solid #e5e7eb; }
        .nav-btn { transition: all 0.2s; }
        .nav-btn.active { background-color: #2563eb; color: white; border-color: #2563eb; }
        .nav-btn.answered { background-color: #10b981; color: white; border-color: #10b981; }
        .nav-btn.doubt { background-color: #f59e0b; color: white; border-color: #f59e0b; }
        
        /* Calculator Modal */
        .calculator-modal { z-index: 9999; }
		
		/* FIX: SweetAlert Paling Depan (di atas modal z-9000) */
        .swal2-container { z-index: 20000 !important; }
        /* Style Tab Piket */
        .piket-tab-btn {
            border-bottom: 2px solid transparent;
            color: #64748b; /* slate-500 */
            transition: all 0.3s;
        }
        .piket-tab-btn.active {
            border-bottom: 2px solid #2563eb; /* brand-600 */
            color: #2563eb;
            font-weight: 700;
        }
    </style>

    <script>window.app = window.app || {};</script>
        <script>
            // Mencegah Klik Kanan
            document.addEventListener('contextmenu', event => event.preventDefault());

            // Mencegah Tombol Shortcut Inspect Element
            document.onkeydown = function(e) {
                // F12
                if(e.keyCode == 123) { 
                    return false; 
                }
                // Ctrl+Shift+I (Inspect)
                if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { 
                    return false; 
                }
                // Ctrl+Shift+C (Element Inspector)
                if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) { 
                    return false; 
                }
                // Ctrl+Shift+J (Console)
                if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) { 
                    return false; 
                }
                // Ctrl+U (View Source)
                if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { 
                    return false; 
                }
            }
        </script>
</head>
<body class="bg-slate-50 text-slate-800 font-sans antialiased h-screen flex flex-col overflow-hidden">

    <!-- GLOBAL LOADER -->
    <div id="global-loader" class="fixed inset-0 bg-white z-[9999] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="loader mb-4"></div>
        <h2 class="text-xl font-bold text-brand-700 text-center px-4" id="loader-text">Memuat Sistem...</h2>
    </div>

    <!-- 1. VIEW: LOGIN (Shared Entry Point) -->
    <section id="view-login" class="flex-1 flex items-center justify-center bg-gradient-to-br from-slate-900 via-brand-900 to-slate-900 hidden-section overflow-y-auto">
        <div class="bg-white/95 backdrop-blur-md p-10 rounded-3xl shadow-2xl w-full max-w-md m-4 border border-white/20">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-brand-50 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-inner">
                    <i class="fa-solid fa-graduation-cap text-5xl text-brand-600"></i>
                </div>
                <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">Guru Rizal LMS</h1>
                <p class="text-slate-500 mt-2 font-medium">Portal Pembelajaran Digital</p>
            </div>
            <form id="login-form" class="space-y-5">
                <div class="relative">
                    <i class="fa-solid fa-envelope absolute left-4 top-4 text-slate-400"></i>
                    <input type="email" id="login-email" class="w-full border border-slate-200 pl-12 p-3.5 rounded-xl focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition bg-slate-50 focus:bg-white" placeholder="Email Address" required>
                </div>
                <div class="relative">
                    <i class="fa-solid fa-lock absolute left-4 top-4 text-slate-400"></i>
                    <input type="password" id="login-password" class="w-full border border-slate-200 pl-12 p-3.5 rounded-xl focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition bg-slate-50 focus:bg-white" placeholder="Password" required>
                </div>
                <button type="submit" class="w-full bg-brand-600 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-brand-200 hover:bg-brand-700 hover:shadow-brand-300 transition transform active:scale-[0.98]">MASUK</button>
            </form>
            <div class="mt-8 text-center border-t pt-6">
                <button id="btn-dev-regist" class="text-xs text-brand-600 hover:text-brand-800 hover:underline font-semibold flex items-center justify-center w-full gap-2">
                    <i class="fa-solid fa-code"></i> Mode Developer: Register Admin
                </button>
            </div>
        </div>
    </section>

    <!-- 2. VIEW: ADMIN DASHBOARD (Only for Guru/Admin) -->
    <div id="layout-dashboard" class="flex h-full hidden-section">
        <aside class="w-72 bg-white border-r border-slate-200 shadow-xl flex flex-col z-30 hidden md:flex">
            <div class="p-6 border-b border-slate-100 flex items-center gap-3 bg-brand-600 text-white">
                <i class="fa-solid fa-shapes text-2xl"></i>
                <div><h2 class="font-bold text-lg tracking-tight">Guru Rizal</h2><span id="sidebar-role" class="text-[10px] bg-black/20 px-2 py-0.5 rounded-full font-bold uppercase tracking-wider border border-white/10">ADMIN</span></div>
            </div>
            <nav id="sidebar-menu" class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar"></nav>
            
            <!-- AUTHOR SECTION -->
            <div class="p-4 border-t border-slate-100 bg-slate-50 text-xs text-slate-500">
                <div class="mb-4">
                    <p class="font-bold text-slate-700 uppercase mb-1">Author Aplikasi</p>
                    <p><i class="fa-solid fa-user mr-2 text-brand-500"></i>Rizal Aminulloh</p>
                    <p><i class="fa-solid fa-envelope mr-2 text-brand-500"></i>aminulloh18@gmail.com</p>
                    <p><i class="fa-brands fa-whatsapp mr-2 text-brand-500"></i>085974525352</p>
                </div>
                
                <div class="flex items-center mb-3 gap-3 p-2 rounded-lg bg-white border border-slate-200 shadow-sm">
                    <div class="w-8 h-8 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center font-bold border border-brand-200" id="user-initial">U</div>
                    <div class="overflow-hidden"><p id="sidebar-nama" class="truncate font-bold text-sm text-slate-700">User</p><p class="text-[10px] text-green-600 font-bold flex items-center gap-1"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Online</p></div>
                </div>
                <button onclick="window.app.logout()" class="w-full text-left text-red-600 font-bold text-sm p-2 hover:bg-red-50 rounded-lg flex items-center justify-between transition border border-transparent hover:border-red-100">
                    <span>Keluar</span> <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-slate-50 overflow-hidden relative">
            <header class="bg-white shadow-sm p-4 md:hidden flex justify-between z-20 items-center sticky top-0">
                <button onclick="window.app.toggleSidebar()" class="text-slate-600 p-2 hover:bg-slate-100 rounded-lg transition">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
                <span class="font-bold text-brand-600 text-lg">LMS V17</span>
            </header>

            <div id="main-content-area" class="flex-1 overflow-y-auto p-6 lg:p-8 space-y-8">
                
                <!-- PAGE: DASHBOARD -->
                <div id="page-dashboard" class="hidden-section space-y-6 fade-in">
                    <!-- HEADER DASHBOARD BARU -->
                    <div class="flex flex-col md:flex-row justify-between items-end md:items-center gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Dashboard Admin</h2>
                            <p class="text-sm text-slate-500 font-bold">
                                Periode Aktif: <span id="lbl-periode-aktif" class="text-brand-600 bg-brand-50 px-2 py-1 rounded">Loading...</span>
                            </p>
                        </div>
                        <button onclick="window.app.openSchoolConfig()" class="bg-slate-800 text-white px-4 py-2 rounded-xl font-bold text-sm shadow hover:bg-black transition flex items-center gap-2">
                            <i class="fa-solid fa-gear"></i> ATUR PERIODE
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition group">
                            <div class="flex justify-between items-start mb-2">
                                <div class="p-3 rounded-xl bg-blue-50 text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition"><i class="fa-solid fa-users text-xl"></i></div>
                            </div>
                            <div class="text-3xl font-bold text-slate-800" id="stat-users">0</div>
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total Siswa</div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition group">
                             <div class="flex justify-between items-start mb-2">
                                <div class="p-3 rounded-xl bg-purple-50 text-purple-600 group-hover:bg-purple-600 group-hover:text-white transition"><i class="fa-solid fa-box-archive text-xl"></i></div>
                            </div>
                            <div class="text-3xl font-bold text-slate-800" id="stat-soal">0</div>
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">Bank Soal</div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition group">
                            <div class="flex justify-between items-start mb-2">
                                <div class="p-3 rounded-xl bg-green-50 text-green-600 group-hover:bg-green-600 group-hover:text-white transition"><i class="fa-solid fa-clock text-xl"></i></div>
                            </div>
                            <div class="text-3xl font-bold text-slate-800" id="stat-ujian">0</div>
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">Ujian Aktif</div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition group">
                            <div class="flex justify-between items-start mb-2">
                                <div class="p-3 rounded-xl bg-orange-50 text-orange-600 group-hover:bg-orange-600 group-hover:text-white transition"><i class="fa-solid fa-star text-xl"></i></div>
                            </div>
                            <div class="text-3xl font-bold text-slate-800" id="stat-nilai">0</div>
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">Rata-rata Nilai</div>
                        </div>
                    </div>
                    <!-- WIDGET JADWAL GURU HARI INI -->
                    <div id="widget-jadwal-guru" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <i class="fa-solid fa-calendar-day text-brand-600"></i> Jadwal Mengajar Hari Ini
                            </h3>
                            <span class="text-xs font-bold bg-brand-50 text-brand-700 px-3 py-1 rounded-full border border-brand-100" id="lbl-hari-ini">Senin</span>
                        </div>
                        
                        <!-- Container Card Jadwal -->
                        <div id="list-jadwal-guru-dashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="col-span-full text-center text-slate-400 py-6 italic">Memuat jadwal...</div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 h-80 relative">
                        <canvas id="chart-main"></canvas>
                    </div>
                </div>

                                <!-- PAGE: ATUR JADWAL (ADMIN) -->
                <div id="page-atur-jadwal" class="hidden-section space-y-6 fade-in">
                    <!-- Header & Config Button -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center">
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">Atur Jadwal Pelajaran</h2>
                            <p class="text-sm text-slate-500">Kelola jam KBM dan jadwal guru per kelas.</p>
                        </div>
                        <button onclick="window.app.openModalConfigKBM()" class="bg-slate-800 text-white px-5 py-2.5 rounded-xl shadow hover:bg-black transition font-bold text-sm flex items-center gap-2">
                            <i class="fa-solid fa-clock"></i> Konfigurasi Jam
                        </button>
                    </div>

                    <!-- Main Content: Input Jadwal -->
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <!-- Filter Panel -->
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 h-fit lg:col-span-1">
                            <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Pilih Hari</label>
                            <select id="jadwal-hari" class="w-full border p-3 rounded-xl font-bold text-slate-700 mb-4 bg-slate-50" onchange="window.app.loadJadwalGrid()">
                                <option value="Senin">Senin</option>
                                <option value="Selasa">Selasa</option>
                                <option value="Rabu">Rabu</option>
                                <option value="Kamis">Kamis</option>
                                <option value="Jumat">Jumat</option>
                                <option value="Sabtu">Sabtu</option>
                            </select>

                            <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Pilih Kelas</label>
                            <select id="jadwal-kelas" class="w-full border p-3 rounded-xl font-bold text-slate-700 class-selector-full" onchange="window.app.loadJadwalGrid()">
                                <!-- Auto Filled -->
                            </select>
                            
                            <div class="mt-6 p-4 bg-blue-50 rounded-xl text-blue-800 text-xs leading-relaxed border border-blue-100">
                                <i class="fa-solid fa-info-circle mr-1"></i> <b>Tips:</b><br>
                                Pilih Hari dan Kelas untuk melihat atau mengedit jadwal. Klik tombol <b>Edit</b> pada baris jam untuk menetapkan guru.
                            </div>
                        </div>

                        <!-- Schedule Grid -->
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 lg:col-span-3 overflow-hidden min-h-[400px]">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-50 font-bold text-slate-600 uppercase text-xs">
                                    <tr>
                                        <th class="p-4 w-16 text-center">Jam</th>
                                        <th class="p-4 w-32">Waktu</th>
                                        <th class="p-4">Mata Pelajaran & Guru</th>
                                        <th class="p-4 text-right w-24">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-jadwal" class="divide-y divide-slate-100">
                                    <tr><td colspan="4" class="p-10 text-center text-slate-400">Silakan pilih kelas untuk memuat jadwal.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- MODAL KONFIGURASI JAM (KBM) -->
                <div id="modal-config-kbm" class="fixed inset-0 bg-black/60 z-[9000] hidden flex items-center justify-center p-4 modal-overlay backdrop-blur-sm">
                    <div class="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl">
                        <div class="flex justify-between items-center mb-4 border-b pb-4">
                            <h3 class="font-bold text-xl text-slate-800">Setting Jam Pelajaran</h3>
                            <button onclick="window.app.closeModal('modal-config-kbm')" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
                        </div>
                        <div class="space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2">
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase">Jumlah Jam Per Hari</label>
                                <input type="number" id="cfg-jml-jam" class="w-full border p-2 rounded-lg mt-1 font-bold" value="10" onchange="window.app.renderConfigInputs()">
                            </div>
                            <div id="cfg-slots-container" class="space-y-2">
                                <!-- Input jam generate disini -->
                            </div>
                        </div>
                        <div class="pt-4 mt-4 border-t flex justify-end">
                            <button onclick="window.app.saveConfigKBM()" class="bg-brand-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-brand-700 transition">SIMPAN KONFIGURASI</button>
                        </div>
                    </div>
                </div>

                <!-- MODAL EDIT JADWAL ITEM -->
                <div id="modal-edit-jadwal" class="fixed inset-0 bg-black/60 z-[9000] hidden flex items-center justify-center p-4 modal-overlay backdrop-blur-sm">
                    <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl relative">

                        <!-- TOMBOL CLOSE -->
                        <button 
                            type="button" 
                            onclick="document.getElementById('modal-edit-jadwal').classList.add('hidden')" 
                            class="absolute top-3 right-3 text-slate-400 hover:text-slate-600">
                            <i class="fa-solid fa-xmark text-xl"></i>
                        </button>

                        <h3 class="font-bold text-lg mb-4 text-slate-800">Set Jadwal Guru</h3>

                        <form id="form-edit-jadwal" class="space-y-4">
                            <input type="hidden" id="ej-jam">
                            
                            <div class="bg-slate-50 p-3 rounded-lg text-xs font-bold text-slate-600 border mb-2">
                                <span id="ej-info">Senin, Jam ke-1 (07:00 - 07:45)</span>
                            </div>

                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase">Mata Pelajaran</label>
                                <select id="ej-mapel" class="w-full border p-2.5 rounded-xl text-sm mt-1 bg-white">
                                    <!-- Standard Mapel List di JS -->
                                </select>
                            </div>

                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase">Guru Pengampu</label>
                                <select id="ej-guru" class="w-full border p-2.5 rounded-xl text-sm mt-1 bg-white">
                                    <option value="">-- Pilih Guru --</option>
                                </select>
                            </div>

                            <div class="flex gap-2 pt-2">
                                <button type="button" onclick="window.app.deleteJadwalItem()" class="px-4 py-2 bg-red-100 text-red-600 rounded-xl font-bold hover:bg-red-200">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                                <button type="submit" class="flex-1 py-2 bg-brand-600 text-white rounded-xl font-bold hover:bg-brand-700">
                                    SIMPAN
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- PAGE: BANK SOAL -->
                <div id="page-bank-soal" class="hidden-section space-y-6 fade-in">
                    <div class="flex justify-between items-center bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">Bank Soal & Materi</h2>
                            <p class="text-sm text-slate-500">Kelola database soal ujian.</p>
                        </div>
                        <button onclick="window.app.openModalSoal()" class="bg-brand-600 text-white px-5 py-2.5 rounded-xl shadow-lg shadow-brand-200 hover:bg-brand-700 hover:shadow-brand-300 transition transform active:scale-95 font-bold text-sm flex items-center gap-2">
                            <i class="fa-solid fa-circle-plus"></i> Buat Soal Baru
                        </button>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 grid grid-cols-1 md:grid-cols-4 gap-4">
                        <!-- Dynamic Filters (Manual Trigger) -->
                        <select id="filter-soal-mapel" class="border p-2.5 rounded-xl text-sm focus:ring-2 focus:ring-brand-500 outline-none bg-white">
                            <option value="">-- Pilih Mapel --</option>
                        </select>
                        <select id="filter-soal-materi" class="border p-2.5 rounded-xl text-sm focus:ring-2 focus:ring-brand-500 outline-none bg-white">
                             <option value="">-- Pilih Materi --</option>
                        </select>
                        <select id="filter-soal-kelas" class="border p-2.5 rounded-xl text-sm focus:ring-2 focus:ring-brand-500 outline-none"><option value="">Semua Jenjang</option><option value="X">Kelas X</option><option value="XI">Kelas XI</option><option value="XII">Kelas XII</option></select>
                        <button onclick="window.app.loadSoal()" class="bg-slate-800 text-white rounded-xl font-bold text-sm hover:bg-slate-900 transition shadow-md flex items-center justify-center gap-2"><i class="fa-solid fa-search"></i> CARI SOAL</button>
                    </div>
                    <div id="list-soal-container" class="space-y-4 min-h-[200px]">
                        <div class="text-center p-10 text-slate-400 bg-slate-50 rounded-xl border border-dashed border-slate-300">
                            <i class="fa-solid fa-filter text-4xl mb-3 opacity-30"></i>
                            <p>Silakan pilih filter dan klik tombol <b>Cari Soal</b> untuk menampilkan data.</p>
                        </div>
                    </div>
                </div>

                <!-- PAGE: SESI UJIAN -->
                <div id="page-sesi-ujian" class="hidden-section space-y-6 fade-in">
                    <div class="flex justify-between items-center bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                        <h2 class="text-xl font-bold text-slate-800">Jadwal & Token</h2>
                        <button onclick="window.app.openModalSesi()" class="bg-purple-600 text-white px-5 py-2.5 rounded-xl shadow-lg hover:bg-purple-700 font-bold text-sm flex items-center gap-2 transition"><i class="fa-solid fa-stopwatch"></i> Buat Sesi</button>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                        <table class="w-full text-sm text-left"><thead class="bg-slate-50 font-bold text-slate-600 uppercase text-xs"><tr><th class="p-4">Mapel</th><th class="p-4">Target</th><th class="p-4 text-center">Token</th><th class="p-4 text-center">Durasi</th><th class="p-4 text-center">Batas Curang</th><th class="p-4 text-center">Status</th><th class="p-4 text-right">Aksi</th></tr></thead><tbody id="tbody-sesi" class="divide-y divide-slate-100"></tbody></table>
                    </div>
                </div>

                <!-- PAGE: USERS -->
                <div id="page-users" class="hidden-section space-y-6 fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-center bg-white p-5 rounded-2xl shadow-sm border border-slate-100 gap-4">
                        <h2 class="text-xl font-bold text-slate-800 mr-auto">Data Pengguna</h2>
                        <div class="flex gap-2 w-full md:w-auto">
                            <select id="filter-user-jenjang" class="border rounded-lg px-3 py-2 text-sm font-bold text-slate-600"><option value="">Jenjang</option><option value="X">Kelas X</option><option value="XI">Kelas XI</option><option value="XII">Kelas XII</option><option value="GURU">GURU</option><option value="ADMIN">ADMIN</option><option value="piket">Petugas Piket</option></select>
                            <select id="filter-user-kelas" class="border rounded-lg px-3 py-2 text-sm w-32 bg-white class-selector-full"></select>
                            <button onclick="window.app.loadUsers()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-slate-900 transition flex items-center gap-2"><i class="fa-solid fa-search"></i> CARI USER</button>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.app.deleteBulkUsers()" class="bg-red-100 text-red-600 px-4 py-2 rounded-lg font-bold text-sm border border-red-200 hover:bg-red-200 transition" title="Hapus Terpilih"><i class="fa-solid fa-trash"></i></button>
                            <button onclick="window.app.openModalImport()" class="bg-green-100 text-green-600 px-4 py-2 rounded-lg font-bold text-sm border border-green-200 hover:bg-green-200 transition" title="Import CSV"><i class="fa-solid fa-file-csv"></i></button>
                            <button onclick="window.app.openModalUser()" class="bg-brand-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow hover:bg-brand-700 transition" title="Tambah Manual"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden min-h-[300px]">
                        <table class="w-full text-sm text-left"><thead class="bg-slate-50 font-bold text-slate-600 uppercase text-xs"><tr><th class="p-4 w-10 text-center"><input type="checkbox" onchange="window.app.toggleSelectAll(this)" class="custom-checkbox"></th><th class="p-4">Nama</th><th class="p-4">Email</th><th class="p-4">Role</th><th class="p-4">Kelas</th><th class="p-4 text-right">Aksi</th></tr></thead><tbody id="tbody-users" class="divide-y divide-slate-100">
                            <tr><td colspan="6" class="p-10 text-center text-slate-400">Silakan gunakan filter dan klik tombol Cari User.</td></tr>
                        </tbody></table>
                    </div>
                </div>

                <!-- PAGE: MANAJEMEN KELAS -->
                <div id="page-kelas" class="hidden-section space-y-6 fade-in">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center">
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">Manajemen Kelas</h2>
                            <p class="text-sm text-slate-500">Atur daftar kelas, wali kelas, guru mapel, dan siswa.</p>
                        </div>
                        <!-- Paste SEBELUM tombol Tambah Kelas -->
                        <button onclick="window.app.openModalPromote()" class="bg-indigo-600 text-white px-5 py-2.5 rounded-xl shadow-lg hover:bg-indigo-700 font-bold text-sm flex items-center gap-2 transition mr-2">
                            <i class="fa-solid fa-stairs"></i> Kenaikan Kelas
                        </button>
                        <!-- Batas tombol baru -->
                        <button id="btn-add-kelas" onclick="window.app.openModalKelas()" class="bg-brand-600 text-white px-5 py-2.5 rounded-xl shadow-lg hover:bg-brand-700 font-bold text-sm flex items-center gap-2 transition">
                            <i class="fa-solid fa-plus"></i> Tambah Kelas
                        </button>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-3 bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-50 font-bold text-slate-600 uppercase text-xs">
                                    <tr>
                                        <th class="p-4 w-10"></th> <!-- Kolom Toggle -->
                                        <th class="p-4">Nama Kelas</th>
                                        <th class="p-4">Jenjang</th>
                                        <th class="p-4">Wali Kelas</th>
                                        <th class="p-4 text-center">Jml Siswa</th>
                                        <th class="p-4 text-right">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-kelas" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- PAGE: NILAI -->
                <div id="page-nilai" class="hidden-section space-y-6 fade-in">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col xl:flex-row gap-4 items-center">
                        <div class="mr-auto">
                             <h2 class="text-xl font-bold text-slate-800">Rekap Nilai</h2>
                             <p class="text-xs text-slate-500">Gunakan filter Token untuk hasil spesifik.</p>
                        </div>
                        
                        <div class="flex flex-wrap gap-2 w-full xl:w-auto justify-end items-center">
                            <!-- Filter Token/Sesi (PENTING) -->
                            <select id="filter-nilai-token" class="border p-2.5 rounded-xl text-sm font-bold text-brand-700 bg-brand-50 w-48">
                                <option value="">-- Pilih Token --</option>
                            </select>

                            <select id="filter-nilai-jenjang" class="border p-2.5 rounded-xl text-sm font-bold text-slate-600"><option value="">Jenjang</option><option value="X">Kelas X</option><option value="XI">Kelas XI</option><option value="XII">Kelas XII</option></select>
                            <select id="filter-nilai-kelas" class="border p-2.5 rounded-xl text-sm w-32 bg-white class-selector-full"></select>
                            
                            <button onclick="window.app.loadNilai()" class="bg-slate-800 text-white px-5 py-2.5 rounded-xl font-bold shadow hover:bg-black transition flex items-center gap-2"><i class="fa-solid fa-search"></i> CARI</button>
                            
                            <div class="w-px h-8 bg-slate-300 mx-1"></div>
                            
                            <button onclick="window.app.exportNilaiToExcel()" class="bg-green-600 text-white px-5 py-2.5 rounded-xl font-bold shadow hover:bg-green-700 transition flex items-center gap-2">
                                <i class="fa-solid fa-file-excel"></i> EXPORT
                            </button>
							<button onclick="window.app.analyzeSoal()" class="bg-purple-100 text-purple-700 px-5 py-2.5 rounded-xl font-bold shadow-sm hover:bg-purple-200 transition flex items-center gap-2">
								<i class="fa-solid fa-chart-pie"></i> ANALISIS
							</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden min-h-[300px]">
                        <table class="w-full text-sm text-left"><thead class="bg-slate-50 font-bold text-slate-600 uppercase text-xs"><tr><th class="p-4">Tanggal</th><th class="p-4">Token</th><th class="p-4">Nama</th><th class="p-4">Kelas</th><th class="p-4">Mapel</th><th class="p-4 text-center">Nilai</th><th class="p-4 text-right">Aksi</th></tr></thead><tbody id="tbody-nilai" class="divide-y divide-slate-100">
                             <tr><td colspan="6" class="p-10 text-center text-slate-400">Silakan pilih filter dan klik tombol Cari.</td></tr>
                        </tbody></table>
                    </div>
                </div>
                
                <!-- PAGE: PRESENSI -->
                <div id="page-presensi" class="hidden-section space-y-6 fade-in">
                     <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col md:flex-row gap-4 items-center">
                        <div class="mr-auto">
                            <h2 class="text-xl font-bold text-slate-800">Presensi Kelas</h2>
                            <p class="text-sm text-slate-500">Catat kehadiran siswa per pertemuan.</p>
                        </div>
                        <div class="flex flex-wrap gap-2 items-center">
                            <input type="date" id="presensi-tgl" class="border p-2.5 rounded-xl text-sm font-bold text-slate-600">
                            <select id="presensi-kelas" class="border p-2.5 rounded-xl text-sm w-32 bg-white class-selector-full"></select>
                            <select id="presensi-mapel" class="border p-2.5 rounded-xl text-sm bg-white">
                                <!-- Standard Mapel List -->
                            </select>
                            <button onclick="window.app.loadPresensiData()" class="bg-brand-600 text-white px-5 py-2.5 rounded-xl font-bold shadow hover:bg-brand-700 transition">BUKA</button>
                        </div>
                     </div>
                     
                     <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 font-bold text-slate-600 uppercase text-xs">
                                <tr>
                                    <th class="p-4 w-10 text-center">No</th>
                                    <th class="p-4">Nama Siswa</th>
                                    <th class="p-4 text-center w-64">Kehadiran</th>
                                    <th class="p-4">Keterangan (Opsional)</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-presensi" class="divide-y divide-slate-100">
                                <tr><td colspan="4" class="p-10 text-center text-slate-400">Pilih Tanggal, Kelas, Mapel, lalu klik tombol Buka.</td></tr>
                            </tbody>
                        </table>
                     </div>
                     
                     <div class="flex justify-end hidden gap-3" id="wrap-btn-simpan-presensi">
						<!-- Tombol Hapus (Kiri) -->
						<button id="btn-hapus-presensi" onclick="window.app.deletePresensi()" class="hidden bg-red-100 text-red-600 px-5 py-3 rounded-xl font-bold shadow-sm hover:bg-red-200 transition items-center gap-2 mr-auto border border-red-200">
							<i class="fa-solid fa-trash-can"></i> RESET DATA
						</button>
						
						<!-- Tombol Simpan (Kanan) -->
						<button onclick="window.app.savePresensi()" class="bg-green-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:bg-green-700 transition flex items-center gap-2">
							<i class="fa-solid fa-save"></i> SIMPAN DATA PRESENSI
						</button>
					</div>
                </div>

                <!-- PAGE: REKAP ABSENSI (NEW) -->
                <div id="page-rekap-absensi" class="hidden-section space-y-6 fade-in">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col md:flex-row gap-4 items-center">
                        <div class="mr-auto">
                            <h2 class="text-xl font-bold text-slate-800">Rekapitulasi Absensi</h2>
                            <p class="text-sm text-slate-500">Ringkasan kehadiran siswa per semester.</p>
                        </div>
                        <div class="flex flex-wrap gap-2 items-center">
                            <select id="rekap-absen-kelas" class="border p-2.5 rounded-xl text-sm w-32 bg-white class-selector-full"></select>
                            <select id="rekap-absen-mapel" class="border p-2.5 rounded-xl text-sm bg-white"></select>
                            <button onclick="window.app.loadRekapAbsensi()" class="bg-slate-800 text-white px-5 py-2.5 rounded-xl font-bold shadow hover:bg-black transition">LIHAT REKAP</button>
                            <button onclick="window.app.exportRekapAbsensi()" class="bg-green-600 text-white px-5 py-2.5 rounded-xl font-bold shadow hover:bg-green-700 transition"><i class="fa-solid fa-file-excel"></i></button>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-x-auto"> 
                        <table class="w-full text-sm text-left whitespace-nowrap"> <!-- Tambah whitespace-nowrap biar rapi -->
                            <thead class="bg-slate-50 font-bold text-slate-600 uppercase text-xs">
                                <tr id="rekap-header-row"> 
                                    
                                </tr>
                            </thead>
                            <tbody id="tbody-rekap-absen" class="divide-y divide-slate-100">
                                <tr><td colspan="7" class="p-10 text-center text-slate-400">Pilih Kelas dan Mapel untuk melihat data.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- PAGE: AGENDA GURU / JURNAL (UPDATED WITH TABLE) -->
                <div id="page-agenda" class="hidden-section space-y-6 fade-in">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col md:flex-row gap-4 items-center">
                        <div class="mr-auto">
                            <h2 class="text-xl font-bold text-slate-800">Jurnal Mengajar</h2>
                            <p class="text-sm text-slate-500">Agenda kegiatan belajar mengajar harian.</p>
                        </div>
                        <div class="flex flex-wrap gap-2 items-center">
                            <select id="filter-agenda-kelas" class="border p-2.5 rounded-xl text-sm w-32 bg-white class-selector-full"></select>
                            <button onclick="window.app.loadAgenda()" class="bg-slate-800 text-white px-5 py-2.5 rounded-xl font-bold shadow hover:bg-black transition flex items-center gap-2"><i class="fa-solid fa-search"></i> Cari</button>
                            <button onclick="window.app.exportAgenda()" class="bg-green-600 text-white px-5 py-2.5 rounded-xl font-bold shadow hover:bg-green-700 transition flex items-center gap-2"><i class="fa-solid fa-file-excel"></i> Export</button>
                            <button onclick="window.app.openModalAgenda()" class="bg-brand-600 text-white px-5 py-2.5 rounded-xl shadow-lg hover:bg-brand-700 font-bold text-sm flex items-center gap-2 transition">
                                <i class="fa-solid fa-plus"></i> Isi Jurnal
                            </button>
                        </div>
                    </div>
                     <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden min-h-[300px]">
                         <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 font-bold text-slate-600 uppercase text-xs">
                                <tr>
                                    <th class="p-4">Tanggal</th>
                                    <th class="p-4">Kelas</th>
                                    <th class="p-4">Mapel (Jam)</th>
                                    <th class="p-4 w-1/3">Materi / Tugas</th>
                                    <th class="p-4 text-center">Kehadiran</th>
                                    <th class="p-4 text-center">Bukti</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-agenda" class="divide-y divide-slate-100">
                                <tr><td colspan="6" class="p-10 text-center text-slate-400">Silakan klik tombol Cari untuk menampilkan data jurnal.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                                <!-- PAGE: KEGIATAN KELAS (FEED GURU) -->
                <div id="page-kegiatan" class="hidden-section space-y-6 fade-in">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Posting Kegiatan Kelas</h2>
                        <div class="flex gap-4 mb-4">
                            <select id="kegiatan-kelas" class="border p-3 rounded-xl w-48 bg-white font-bold text-sm class-selector-full"></select>
                            <textarea id="kegiatan-text" class="flex-1 border p-3 rounded-xl text-sm resize-none focus:ring-2 focus:ring-brand-500 outline-none" rows="2" placeholder="Bagikan materi, pengumuman, atau info tugas..."></textarea>
                        </div>
                        <!-- INPUT LINK BARU DISINI -->
                        <input type="text" id="kegiatan-link" class="w-full border p-3 rounded-xl text-sm mb-4 focus:ring-2 focus:ring-brand-500 outline-none bg-slate-50" placeholder="Sisipkan Link / URL (Contoh: Google Drive, Youtube, Quizizz)...">

                        <div class="flex justify-between items-center">
                            <div class="flex gap-2">
                                <button onclick="window.app.triggerImageUpload('kegiatan-img')" class="text-brand-600 hover:bg-brand-50 p-2 rounded-lg text-sm font-bold"><i class="fa-solid fa-image"></i> Foto</button>
                                <input type="hidden" id="kegiatan-img">
                            </div>
                            <button onclick="window.app.postKegiatan()" class="bg-brand-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-brand-700 transition">POSTING</button>
                        </div>
                        <div id="preview-kegiatan-img" class="mt-2 h-32 w-32 bg-cover bg-center rounded-lg hidden"></div>
                    </div>
                                    <!-- Filter Timeline -->
                    <div class="flex items-center justify-between px-2">
                        <h3 class="font-bold text-slate-500 text-sm">Timeline Kegiatan</h3>
                        <select id="filter-feed-guru" class="border p-2 rounded-lg text-xs bg-white font-bold text-slate-600 shadow-sm" onchange="window.app.loadKegiatanGuru()">
                            <!-- Opsi kelas akan muncul otomatis -->
                        </select>
                    </div>
                    <div id="feed-container-guru" class="space-y-4"></div>
                </div>

                <!-- PAGE: NILAI HARIAN (NEW) -->
                <div id="page-nilai-harian" class="hidden-section space-y-6 fade-in">
                    <!-- Tab Navigation for Daily Grades -->
                    <div class="flex space-x-2 border-b border-slate-200">
                        <button onclick="window.app.switchNilaiHarianTab('input')" id="tab-btn-input" class="px-6 py-3 font-bold text-sm text-brand-600 border-b-2 border-brand-600 transition">Input Nilai</button>
                        <button onclick="window.app.switchNilaiHarianTab('activity')" id="tab-btn-activity" class="px-6 py-3 font-bold text-sm text-slate-500 hover:text-slate-700 transition">Poin Keaktifan</button>
                    </div>

                    <!-- VIEW 1: INPUT NILAI TUGAS -->
                    <div id="view-nh-input" class="space-y-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <!-- ID Hidden untuk Edit -->
                            <input type="hidden" id="nh-id">
                            <h2 class="text-lg font-bold text-slate-800 mb-4">Form Input Nilai Tugas</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div><label class="text-xs font-bold uppercase text-slate-500">Kelas</label><select id="nh-kelas" class="w-full border p-2.5 rounded-xl text-sm bg-white mt-1 class-selector-full" onchange="window.app.loadSiswaForInput()"></select></div>
                                <div><label class="text-xs font-bold uppercase text-slate-500">Mapel</label><select id="nh-mapel" class="w-full border p-2.5 rounded-xl text-sm bg-white mt-1"></select></div>
                                <div><label class="text-xs font-bold uppercase text-slate-500">Tanggal</label><input type="date" id="nh-tgl" class="w-full border p-2.5 rounded-xl text-sm mt-1"></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div><label class="text-xs font-bold uppercase text-slate-500">Jenis Tugas</label><input id="nh-jenis" class="w-full border p-2.5 rounded-xl text-sm mt-1" placeholder="ex: UH 1 / Tugas 1"></div>
                                <div><label class="text-xs font-bold uppercase text-slate-500">Materi/BAB</label><input id="nh-materi" class="w-full border p-2.5 rounded-xl text-sm mt-1" placeholder="ex: Aljabar"></div>
                                <div><label class="text-xs font-bold uppercase text-slate-500">Poin Maks</label><input type="number" id="nh-max" class="w-full border p-2.5 rounded-xl text-sm mt-1" value="100"></div>
                            </div>
                            
                            <div id="nh-siswa-container" class="bg-slate-50 p-4 rounded-xl border border-slate-200 hidden">
                                <h4 class="font-bold text-sm text-slate-700 mb-3">Input Nilai Siswa</h4>
                                <div id="nh-list-siswa" class="space-y-2 grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2"></div>
                                <div class="mt-4 text-right">
                                    <button onclick="window.app.saveNilaiHarian()" class="bg-brand-600 text-white px-6 py-2 rounded-xl font-bold shadow hover:bg-brand-700 transition">SIMPAN NILAI</button>
                                </div>
                            </div>
                            <!-- KODE BARU: BANK NILAI HARIAN -->
                            <div id="nh-bank-section" class="hidden mt-8 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                <header class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4 border-b border-slate-100 pb-4">
                                    <div>
                                        <h2 class="text-xl font-bold text-slate-800">Bank Nilai: <span id="nh-bank-title" class="text-brand-600"></span></h2>
                                        <p class="text-xs text-slate-500">Riwayat penilaian tugas di kelas ini.</p>
                                    </div>
                                </header>
                                
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm text-left">
                                        <thead class="bg-slate-50 font-bold text-slate-600 uppercase text-xs">
                                            <tr>
                                                <th class="p-4">Tanggal</th>
                                                <th class="p-4">Jenis</th>
                                                <th class="p-4">Mapel</th>
                                                <th class="p-4">Materi/BAB</th>
                                                <th class="p-4 text-center">Rata-rata</th>
                                                <th class="p-4 text-right">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="nh-bank-body" class="divide-y divide-slate-100">
                                            <!-- Data akan masuk sini -->
                                        </tbody>
                                    </table>
                                    <p id="nh-bank-empty" class="hidden text-center text-slate-400 p-8">Belum ada data nilai untuk kelas ini.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- VIEW 2: POIN KEAKTIFAN -->
                    <div id="view-nh-activity" class="hidden space-y-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-bold text-slate-800">Manajemen Poin Keaktifan</h2>
                                <select id="nh-activity-kelas" class="border p-2 rounded-lg text-sm w-48 class-selector-full" onchange="window.app.loadActivityPoints()"></select>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="border rounded-xl p-4 bg-yellow-50 border-yellow-100">
                                    <h3 class="font-bold text-yellow-800 text-sm mb-2"><i class="fa-solid fa-lightbulb"></i> Panduan Poin</h3>
                                    <ul class="text-xs text-yellow-700 space-y-1 ml-4 list-disc">
                                        <li><b>+2 Poin:</b> Menjawab pertanyaan faktual.</li>
                                        <li><b>+3 Poin:</b> Bertanya / Berpendapat.</li>
                                        <li><b>+5 Poin:</b> Maju ke depan / Membantu teman.</li>
                                    </ul>
                                </div>
                                <div>
                                    <div id="nh-activity-list" class="max-h-[400px] overflow-y-auto custom-scrollbar space-y-2">
                                        <p class="text-center text-slate-400 py-10">Pilih kelas untuk memuat data.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PAGE: LEGER NILAI (NEW) -->
                <div id="page-leger" class="hidden-section space-y-6 fade-in">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <header class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                            <div>
                                <h2 class="text-xl font-bold text-slate-800">Leger Nilai Siswa</h2>
                                <p class="text-sm text-slate-500">Rekapitulasi nilai tugas (skala 100) & ujian harian.</p>
                            </div>
                            <div class="flex gap-2">
                                <select id="leger-kelas" class="border p-2.5 rounded-xl text-sm font-bold text-slate-600 w-40 class-selector-full"></select>
                                <select id="leger-mapel" class="border p-2.5 rounded-xl text-sm w-48 bg-white"></select>
                                <button onclick="window.app.loadLegerData()" class="bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-bold shadow hover:bg-indigo-700 transition">LIHAT LEGER</button>
                                <button onclick="window.app.exportLeger()" class="bg-green-600 text-white px-5 py-2.5 rounded-xl font-bold shadow hover:bg-green-700 transition flex items-center gap-2">
                                    <i class="fa-solid fa-file-excel"></i> EXPORT
                                </button>
                            </div>
                        </header>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm border-collapse border border-slate-200">
                                <thead class="bg-slate-50 text-slate-700 font-bold uppercase text-xs">
                                    <tr id="leger-head-row"> <!-- TAMBAHKAN ID DISINI -->
                                        <th class="p-3 border border-slate-200 text-center w-10">No</th>
                                        <th class="p-3 border border-slate-200 text-left w-64 sticky left-0 bg-slate-50">Nama Siswa</th>
                                        <th class="p-3 border border-slate-200 text-center bg-blue-50 text-blue-700">Rata-rata Tugas</th>
                                        <th class="p-3 border border-slate-200 text-center bg-purple-50 text-purple-700">Rata-rata Ujian</th>
                                        <th class="p-3 border border-slate-200 text-center bg-green-100 text-green-800">Nilai Akhir</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-leger" class="divide-y divide-slate-100">
                                    <tr><td colspan="5" class="p-8 text-center text-slate-400">Pilih Kelas dan Mapel untuk melihat data.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- PAGE: PIKET DASHBOARD (NEW) -->
                <div id="page-piket" class="hidden-section space-y-6 fade-in">
                                    <!-- HEADER & TAB NAVIGASI -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800"> Piket Terpadu</h2>
                                <p class="text-sm text-slate-500">Pusat kontrol kedisiplinan dan kehadiran harian.</p>
                            </div>
                            <div class="bg-red-50 text-red-600 px-4 py-2 rounded-lg font-bold text-xs border border-red-100">
                                MODE PETUGAS
                            </div>
                        </div>
                        
                        <!-- Tab Menu -->
                        <div class="flex gap-6 border-b border-slate-200">
                            <button onclick="window.app.switchPiketTab('pelanggaran')" id="tab-piket-pelanggaran" class="piket-tab-btn active pb-3 px-2 text-sm font-medium">
                                <i class="fa-solid fa-triangle-exclamation mr-1"></i> Pelanggaran Siswa
                            </button>
                            <button onclick="window.app.switchPiketTab('absensi')" id="tab-piket-absensi" class="piket-tab-btn pb-3 px-2 text-sm font-medium">
                                <i class="fa-solid fa-clipboard-user mr-1"></i> Rekap Absensi & GTK
                            </button>
                        </div>
                    </div>

                    <div id="view-piket-pelanggaran" class="animate-fade-in">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6"> 
                            <!-- KOLOM KIRI: FORM INPUT -->
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 lg:col-span-1 h-fit">
                                <h3 class="font-bold text-lg mb-4 text-slate-700 flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation text-red-500"></i> Input Pelanggaran</h3>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="text-xs font-bold text-slate-500 uppercase">Kelas</label>
                                        <select id="piket-kelas" class="w-full border p-3 rounded-xl mt-1 class-selector-full bg-white" onchange="window.app.loadSiswaPiket()"></select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-slate-500 uppercase">Nama Siswa</label>
                                        <select id="piket-siswa" class="w-full border p-3 rounded-xl mt-1 bg-white disabled:bg-slate-100" disabled>
                                            <option value="">-- Pilih Kelas Dulu --</option>
                                        </select>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="text-xs font-bold text-slate-500 uppercase">Kategori</label>
                                            <select id="piket-kategori" onchange="window.app.renderJenisPelanggaran()" class="w-full border p-3 rounded-xl mt-1 bg-white">
                                                <option value="">-- Pilih --</option>
                                                <option value="A">Berat (A)</option>
                                                <option value="B">Sedang (B)</option>
                                                <option value="C">Ringan (C)</option>
                                                <option value="D">Telat (D)</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs font-bold text-slate-500 uppercase">Jenis</label>
                                            <select id="piket-jenis" class="w-full border p-3 rounded-xl mt-1 bg-white disabled:bg-slate-100" disabled>
                                                <option value="">-</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-slate-500 uppercase">Catatan (Opsional)</label>
                                        <textarea id="piket-catatan" class="w-full border p-3 rounded-xl mt-1 h-20 text-sm" placeholder="Kronologi singkat..."></textarea>
                                    </div>
                                    <!-- Cari tombol SIMPAN DATA di page-piket, lalu paste kode ini DI ATASNYA -->

                                    <div>
                                        <label class="text-xs font-bold text-slate-500 uppercase">Bukti Foto (Opsional)</label>
                                        
                                        <!-- Input File Tersembunyi -->
                                        <input type="file" id="piket-foto-input" accept="image/*" capture="environment" class="hidden" onchange="window.app.handlePiketFoto(this)">
                                        
                                        <!-- Tombol Upload -->
                                        <div class="flex gap-2 mt-1">
                                            <button onclick="document.getElementById('piket-foto-input').click()" class="w-full bg-slate-100 text-slate-600 border border-slate-200 py-3 rounded-xl text-xs font-bold hover:bg-slate-200 flex items-center justify-center gap-2 transition active:scale-95">
                                                <i class="fa-solid fa-camera"></i> Ambil / Upload Bukti
                                            </button>
                                        </div>

                                        <!-- Hidden Input buat nyimpen string Base64 -->
                                        <input type="hidden" id="piket-foto-base64">

                                        <!-- Preview Gambar -->
                                        <div id="piket-foto-preview" class="mt-2 h-32 bg-slate-50 rounded-xl bg-cover bg-center hidden border border-slate-200 relative group shadow-inner">
                                            <!-- Tombol Hapus Foto -->
                                            <button onclick="window.app.clearPiketFoto()" class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-7 h-7 flex items-center justify-center text-xs shadow-md hover:bg-red-600 transition transform hover:scale-110">
                                                <i class="fa-solid fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <button onclick="window.app.simpanPelanggaran()" class="w-full bg-red-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-red-700 transition transform active:scale-95">
                                        SIMPAN DATA
                                    </button>
                                </div>
                            </div>

                            <!-- KOLOM KANAN: RIWAYAT HARI INI -->
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 lg:col-span-2">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-lg text-slate-700"> Pelanggaran Hari Ini</h3>
                                    <button onclick="window.app.loadHistoryPiket()" class="text-xs font-bold text-brand-600 hover:underline"><i class="fa-solid fa-rotate"></i> Refresh</button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm text-left">
                                        <thead class="bg-slate-50 font-bold text-slate-600 uppercase text-xs">
                                            <tr>
                                                <th class="px-4 py-3">Jam</th>
                                                <th class="px-4 py-3">Siswa</th>
                                                <th class="px-4 py-3">Pelanggaran</th>
                                                <th class="px-4 py-3 text-center">Poin</th>
                                                <th class="px-4 py-3 text-center">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="piket-history-body" class="divide-y divide-slate-100">
                                            <tr><td colspan="5" class="p-8 text-center text-slate-400">Memuat data...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                                <!-- SECTION BARU: REKAPITULASI & LAPORAN -->
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mt-6 w-full col-span-full min-h-[400px]">
                                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                                    <div>
                                        <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                                            <i class="fa-solid fa-file-invoice text-brand-600"></i> Rekapitulasi Pelanggaran
                                        </h3>
                                        <p class="text-sm text-slate-500">Filter data untuk laporan bulanan atau per siswa.</p>
                                    </div>
                                    <button onclick="window.app.exportRekapPiket()" class="bg-green-600 text-white px-5 py-2.5 rounded-xl font-bold shadow hover:bg-green-700 transition flex items-center gap-2">
                                        <i class="fa-solid fa-file-excel"></i> DOWNLOAD EXCEL
                                    </button>
                                </div>

                                <!-- Filter Toolbar -->
                                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-6 grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
                                    <div>
                                        <label class="text-[10px] font-bold text-slate-500 uppercase">Dari Tanggal</label>
                                        <input type="date" id="filter-piket-start" class="w-full border p-2 rounded-lg text-sm font-bold text-slate-600">
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-bold text-slate-500 uppercase">Sampai Tanggal</label>
                                        <input type="date" id="filter-piket-end" class="w-full border p-2 rounded-lg text-sm font-bold text-slate-600">
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-bold text-slate-500 uppercase">Kelas</label>
                                        <select id="filter-piket-kelas" class="w-full border p-2 rounded-lg text-sm bg-white class-selector-full" onchange="window.app.loadSiswaFilterPiket()"></select>
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-bold text-slate-500 uppercase">Siswa (Opsional)</label>
                                        <select id="filter-piket-siswa" class="w-full border p-2 rounded-lg text-sm bg-white disabled:bg-slate-100" disabled>
                                            <option value="">Semua Siswa</option>
                                        </select>
                                    </div>
                                    <button onclick="window.app.loadRekapPiketData()" class="bg-slate-800 text-white py-2 rounded-lg font-bold hover:bg-black transition shadow">
                                        <i class="fa-solid fa-search mr-1"></i> TAMPILKAN
                                    </button>
                                </div>

                                <!-- Tabel Rekap -->
                                <div class="overflow-x-auto rounded-lg border border-slate-200">
                                    <table class="w-full text-sm text-left">
                                        <thead class="bg-slate-100 font-bold text-slate-700 uppercase text-xs">
                                            <tr>
                                                <th class="px-4 py-3">Tanggal</th>
                                                <th class="px-4 py-3">Nama Siswa</th>
                                                <th class="px-4 py-3">Kelas</th>
                                                <th class="px-4 py-3">Pelanggaran</th>
                                                <th class="px-4 py-3">Catatan</th>
                                                <th class="px-4 py-3 text-center">Poin</th>
                                                <th class="px-4 py-3">Petugas</th>
                                                <th class="px-4 py-3 text-right">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbody-rekap-piket" class="divide-y divide-slate-100 bg-white">
                                            <tr><td colspan="7" class="p-8 text-center text-slate-400">Silakan atur filter tanggal dan klik Tampilkan.</td></tr>
                                        </tbody>
                                        <tfoot class="bg-slate-50 font-bold text-slate-700 border-t border-slate-200">
                                            <tr>
                                                <td colspan="5" class="px-4 py-3 text-right">TOTAL POIN PERIODE INI:</td>
                                                <td class="px-4 py-3 text-center text-red-600 text-lg" id="total-poin-rekap">0</td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- VIEW 2: ABSENSI & GTK (FITUR BARU) -->
                    <div id="view-piket-absensi" class="hidden animate-fade-in space-y-6">
                        
                                        <!-- A. AREA INPUT DATA HARIAN -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            
                            <!-- KOLOM KIRI: FORM INPUT -->
                            <div class="space-y-6">
                                <!-- 1. Form Siswa (Existing) -->
                                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                    <h3 class="font-bold text-lg mb-4 text-slate-700 flex items-center gap-2">
                                        <i class="fa-solid fa-user-graduate text-blue-600"></i> Input Siswa Absen
                                    </h3>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="text-[10px] font-bold text-slate-500 uppercase">Tanggal</label>
                                            <input type="date" id="absen-piket-tgl" class="w-full border p-2 rounded-lg font-bold text-slate-700 bg-slate-50 text-sm" onchange="window.app.refreshPiketTables()">
                                        </div>
                                        <div>
                                            <label class="text-[10px] font-bold text-slate-500 uppercase">Kelas</label>
                                            <select id="absen-piket-kelas" class="w-full border p-2 rounded-lg bg-white class-selector-full text-sm" onchange="window.app.loadSiswaAbsenPiket()"></select>
                                        </div>
                                        <div>
                                            <label class="text-[10px] font-bold text-slate-500 uppercase">Nama Siswa</label>
                                            <select id="absen-piket-siswa" class="w-full border p-2 rounded-lg bg-white disabled:bg-slate-100 text-sm" disabled>
                                                <option value="">-- Pilih Kelas Dulu --</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Keterangan</label>
                                            <div class="flex gap-2">
                                                <label class="flex-1 cursor-pointer bg-blue-50 p-2 rounded border border-blue-100 hover:bg-blue-100 text-center"><input type="radio" name="absen-status" value="S" class="accent-blue-600"> <span class="text-xs font-bold text-blue-700">Sakit</span></label>
                                                <label class="flex-1 cursor-pointer bg-yellow-50 p-2 rounded border border-yellow-100 hover:bg-yellow-100 text-center"><input type="radio" name="absen-status" value="I" class="accent-yellow-600"> <span class="text-xs font-bold text-yellow-700">Izin</span></label>
                                                <label class="flex-1 cursor-pointer bg-red-50 p-2 rounded border border-red-100 hover:bg-red-100 text-center"><input type="radio" name="absen-status" value="A" class="accent-red-600"> <span class="text-xs font-bold text-red-700">Alpha</span></label>
                                            </div>
                                        </div>
                                        <button onclick="window.app.simpanAbsenPiket()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold shadow hover:bg-blue-700 transition text-sm">
                                            <i class="fa-solid fa-plus mr-1"></i> SIMPAN SISWA
                                        </button>
                                    </div>
                                </div>

                                <!-- 2. Form GTK (NEW FITUR) -->
                                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                    <h3 class="font-bold text-lg mb-4 text-slate-700 flex items-center gap-2">
                                        <i class="fa-solid fa-chalkboard-user text-purple-600"></i> Input GTK Absen
                                    </h3>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="text-[10px] font-bold text-slate-500 uppercase">Nama Guru / Tendik</label>
                                            <select id="absen-gtk-nama" class="w-full border p-2 rounded-lg bg-white text-sm">
                                                <option value="">Loading...</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Keterangan</label>
                                            <div class="grid grid-cols-2 gap-2">
                                                <label class="cursor-pointer bg-blue-50 p-2 rounded border border-blue-100 hover:bg-blue-100 text-center"><input type="radio" name="gtk-status" value="Sakit" class="accent-blue-600"> <span class="text-xs font-bold text-blue-700">Sakit</span></label>
                                                <label class="cursor-pointer bg-yellow-50 p-2 rounded border border-yellow-100 hover:bg-yellow-100 text-center"><input type="radio" name="gtk-status" value="Izin" class="accent-yellow-600"> <span class="text-xs font-bold text-yellow-700">Izin</span></label>
                                                <label class="cursor-pointer bg-red-50 p-2 rounded border border-red-100 hover:bg-red-100 text-center"><input type="radio" name="gtk-status" value="Alpha" class="accent-red-600"> <span class="text-xs font-bold text-red-700">Alpha</span></label>
                                                <label class="cursor-pointer bg-purple-50 p-2 rounded border border-purple-100 hover:bg-purple-100 text-center"><input type="radio" name="gtk-status" value="Dinas" class="accent-purple-600"> <span class="text-xs font-bold text-purple-700">Dinas</span></label>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Status Tugas</label>
                                            <div class="flex gap-2">
                                                <label class="flex-1 cursor-pointer bg-green-50 p-2 rounded border border-green-100 hover:bg-green-100 text-center"><input type="radio" name="gtk-tugas" value="Ada" class="accent-green-600" checked> <span class="text-xs font-bold text-green-700">Ada Tugas</span></label>
                                                <label class="flex-1 cursor-pointer bg-slate-50 p-2 rounded border border-slate-200 hover:bg-slate-100 text-center"><input type="radio" name="gtk-tugas" value="Tidak Ada" class="accent-slate-600"> <span class="text-xs font-bold text-slate-700">Tidak Ada</span></label>
                                            </div>
                                        </div>
                                        <button onclick="window.app.simpanAbsenGtk()" class="w-full bg-purple-600 text-white py-2 rounded-lg font-bold shadow hover:bg-purple-700 transition text-sm">
                                            <i class="fa-solid fa-plus mr-1"></i> SIMPAN GTK
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- KOLOM KANAN: TABEL DATA HARI INI -->
                            <div class="lg:col-span-2 space-y-6">
                                <!-- Tabel Siswa -->
                                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="font-bold text-lg text-slate-700">Daftar Siswa Tidak Hadir</h3>
                                        <span class="text-xs font-bold bg-slate-100 px-2 py-1 rounded text-slate-500" id="lbl-date-siswa">-</span>
                                    </div>
                                    <div class="overflow-x-auto rounded-lg border border-slate-100 max-h-60 overflow-y-auto custom-scrollbar">
                                        <table class="w-full text-sm text-left">
                                            <thead class="bg-slate-50 font-bold text-slate-600 uppercase text-xs sticky top-0">
                                                <tr><th class="p-3">Nama</th><th class="p-3">Kelas</th><th class="p-3 text-center">Ket</th><th class="p-3 text-right">Aksi</th></tr>
                                            </thead>
                                            <tbody id="tbody-absen-piket-today" class="divide-y divide-slate-100"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Tabel GTK (NEW) -->
                                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="font-bold text-lg text-slate-700">Daftar GTK Tidak Hadir</h3>
                                        <span class="text-xs font-bold bg-slate-100 px-2 py-1 rounded text-slate-500" id="lbl-date-gtk">-</span>
                                    </div>
                                    <div class="overflow-x-auto rounded-lg border border-slate-100 max-h-60 overflow-y-auto custom-scrollbar">
                                        <table class="w-full text-sm text-left">
                                            <thead class="bg-slate-50 font-bold text-slate-600 uppercase text-xs sticky top-0">
                                                <tr><th class="p-3">Nama GTK</th><th class="p-3 text-center">Ket</th><th class="p-3">Status Tugas</th><th class="p-3 text-right">Aksi</th></tr>
                                            </thead>
                                            <tbody id="tbody-absen-gtk-today" class="divide-y divide-slate-100">
                                                <tr><td colspan="4" class="p-4 text-center text-slate-400">Belum ada data GTK.</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- B. REKAPITULASI & LAPORAN (EXPORT) -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                            <div class="flex flex-col md:flex-row justify-between items-start gap-4 mb-6 border-b border-slate-100 pb-4">
                                <div>
                                    <h3 class="font-bold text-lg text-slate-800"><i class="fa-solid fa-file-excel text-green-600 mr-2"></i>Laporan Harian Terpadu</h3>
                                    <p class="text-xs text-slate-500">Pilih tanggal lalu klik Proses Data. Data GTK & Siswa akan ditarik otomatis.</p>
                                </div>
                                
                                <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                                    <input type="date" id="rekap-piket-tgl" class="border p-2 rounded-lg font-bold text-slate-700 bg-slate-50 text-sm">
                                    <button onclick="window.app.prosesRekapHarian()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-blue-700 transition text-sm flex items-center justify-center gap-2">
                                        <i class="fa-solid fa-sync"></i> PROSES DATA
                                    </button>
                                    <button onclick="window.app.exportLaporanPiket()" id="btn-download-rekap" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-green-700 transition text-sm flex items-center justify-center gap-2 opacity-50 cursor-not-allowed" disabled>
                                        <i class="fa-solid fa-download"></i> DOWNLOAD EXCEL
                                    </button>
                                </div>
                            </div>

                            <!-- AREA DATA GTK (READONLY / AUTO-FILLED) -->
                            <div id="area-input-gtk" class="hidden animate-fade-in mb-8">
                                <div class="bg-slate-50 p-5 rounded-xl border border-slate-200">
                                    <h4 class="font-bold text-sm text-slate-700 uppercase mb-4 flex items-center gap-2">
                                        <i class="fa-solid fa-chalkboard-user"></i> Ringkasan Kehadiran GTK
                                    </h4>
                                    <!-- Statistik Angka GTK -->
                                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                                        <div><label class="text-[10px] font-bold">Total GTK</label><input type="number" id="gtk-total" value="50" class="w-full border p-2 rounded text-sm font-bold text-center"></div>
                                        <div><label class="text-[10px] font-bold text-green-600">Hadir</label><input type="number" id="gtk-hadir" value="0" readonly class="w-full border p-2 rounded text-sm font-bold text-center text-green-600 border-green-200 bg-green-100"></div>
                                        <div><label class="text-[10px] font-bold text-blue-600">Sakit</label><input type="number" id="gtk-sakit" value="0" readonly class="w-full border p-2 rounded text-sm font-bold text-center text-blue-600 border-blue-200 bg-blue-50"></div>
                                        <div><label class="text-[10px] font-bold text-yellow-600">Izin</label><input type="number" id="gtk-izin" value="0" readonly class="w-full border p-2 rounded text-sm font-bold text-center text-yellow-600 border-yellow-200 bg-yellow-50"></div>
                                        <div><label class="text-[10px] font-bold text-red-600">Alpha</label><input type="number" id="gtk-alpha" value="0" readonly class="w-full border p-2 rounded text-sm font-bold text-center text-red-600 border-red-200 bg-red-50"></div>
                                    </div>
                                    <p class="text-[10px] text-slate-400 italic">*Data dihitung otomatis dari inputan harian GTK.</p>
                                </div>
                            </div>

                            <!-- Preview Tabel Rekap Kelas -->
                            <div class="overflow-x-auto rounded-lg border border-slate-200">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-slate-800 text-white font-bold text-xs uppercase">
                                        <tr>
                                            <th class="p-3 w-10 text-center">No</th>
                                            <th class="p-3">Kelas</th>
                                            <th class="p-3 text-center">Jml Siswa</th>
                                            <th class="p-3 text-center bg-green-700">Hadir</th>
                                            <th class="p-3 text-center bg-blue-700">Sakit</th>
                                            <th class="p-3 text-center bg-yellow-700">Izin</th>
                                            <th class="p-3 text-center bg-red-700">Alpha</th>
                                            <th class="p-3 text-center">% Hadir</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-rekap-harian-piket" class="divide-y divide-slate-200 bg-white">
                                        <tr><td colspan="8" class="p-8 text-center text-slate-400 italic">Silakan pilih tanggal dan klik tombol "PROSES DATA".</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 3. VIEW: STUDENT PORTAL (Only for Siswa) -->
    <div id="view-student-portal" class="hidden-section h-full bg-slate-100 flex flex-col min-h-screen">
              <!-- NAVIGASI BAWAH SISWA -->
        <div id="nav-bottom-student"
            class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around p-3 z-50 shadow-lg">

            <button onclick="window.app.navStudent('home')" class="flex flex-col items-center text-slate-400 hover:text-brand-600 transition" id="btn-nav-home">
                <i class="fa-solid fa-house text-xl mb-1"></i>
                <span class="text-[10px] font-bold">Beranda</span>
            </button>
            <button onclick="window.app.navStudent('exam')" class="flex flex-col items-center text-slate-400 hover:text-brand-600 transition" id="btn-nav-exam">
                <i class="fa-solid fa-pen-to-square text-xl mb-1"></i>
                <span class="text-[10px] font-bold">Ujian</span>
            </button>
            <button onclick="window.app.logout()" class="flex flex-col items-center text-red-400 hover:text-red-600 transition">
                <i class="fa-solid fa-right-from-bracket text-xl mb-1"></i>
                <span class="text-[10px] font-bold">Keluar</span>
            </button>
        </div>
                <!-- 3a. Student Home (Feed & Leaderboard) -->
        <div id="student-home-screen" class="flex-1 p-4 max-w-lg mx-auto w-full space-y-6 overflow-y-auto pb-24 hidden-section">
            <!-- KARTU PELANGGARAN (HANYA MUNCUL JIKA ADA POIN) -->
            <div id="stu-card-pelanggaran" class="hidden bg-white border-l-4 border-red-500 rounded-xl p-5 shadow-sm mb-4 relative overflow-hidden">
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <h3 class="font-bold text-red-600 text-sm uppercase tracking-wide mb-1">Catatan Kedisiplinan</h3>
                        <p class="text-xs text-slate-500 mb-2">Total Poin Pelanggaran Kamu:</p>
                        <div class="text-4xl font-extrabold text-slate-800" id="stu-poin-pelanggaran">0</div>
                    </div>
                    <div class="text-right">
                        <span id="stu-status-sanksi" class="bg-red-100 text-red-700 px-3 py-1 rounded-lg text-xs font-bold border border-red-200">
                            AMAN
                        </span>
                        <div class="mt-2 text-[10px] text-slate-400 font-bold uppercase">Status Sanksi</div>
                    </div>
                </div>
                <!-- Background Icon -->
                <i class="fa-solid fa-triangle-exclamation absolute -bottom-2 -right-2 text-6xl text-red-50 opacity-50 z-0"></i>
            </div>
            <!-- 1. KARTU POIN & LEVEL (BARU) -->
            <div class="bg-gradient-to-r from-yellow-400 to-orange-500 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
                <div class="absolute -right-6 -bottom-6 w-32 h-32 bg-white/20 rounded-full blur-2xl"></div>
                
                <!-- Header Nama -->
                <div class="relative z-10 border-b border-white/20 pb-4 mb-4">
                    <h2 class="text-xl font-bold">Halo, <span id="stu-home-name">Siswa</span></h2>
                    <p class="opacity-90 text-sm" id="stu-home-class">Kelas -</p>
                </div>

                <!-- Poin & Level -->
                <div class="relative z-10 flex justify-between items-center">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <h3 class="font-bold text-yellow-100 text-xs uppercase tracking-wider">Poin Keaktifan</h3>
                            <!-- Badge Level -->
                            <span id="stu-level-badge" class="bg-white/25 px-2 py-0.5 rounded text-[10px] font-bold border border-white/20 shadow-sm">PEMULA</span>
                        </div>
                        <div class="text-5xl font-extrabold tracking-tight" id="stu-total-points">0</div>
                    </div>
                    <div class="bg-white/20 p-4 rounded-full backdrop-blur-sm shadow-inner border border-white/30">
                        <i class="fa-solid fa-star text-4xl text-yellow-100 drop-shadow-md"></i>
                    </div>
                </div>
                <p class="relative z-10 text-[10px] text-yellow-100 mt-3 italic flex items-center gap-1">
                    <i class="fa-solid fa-circle-info"></i> Aktif di kelas untuk naik level!
                </p>
            </div>

            <!-- 2. RIWAYAT NILAI (BARU) -->
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-700 mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-clock-rotate-left text-brand-600"></i> Riwayat Nilai
                </h3>
                <div id="stu-grade-history" class="space-y-1 max-h-64 overflow-y-auto custom-scrollbar">
                    <!-- Data akan masuk lewat Javascript -->
                    <p class="text-xs text-slate-400 text-center py-4">Memuat data...</p>
                </div>
            </div>

            <!-- 3. LEADERBOARD (YANG LAMA TETAP ADA) -->
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-700 mb-3 flex items-center gap-2"><i class="fa-solid fa-trophy text-yellow-500"></i> Top 3 Nilai Tertinggi</h3>
                <div id="leaderboard-container" class="space-y-3">
                    <p class="text-xs text-slate-400 text-center py-2">Belum ada data nilai.</p>
                </div>
            </div>

            <!-- 4. FEED KELAS (YANG LAMA TETAP ADA) -->
            <div>
                <h3 class="font-bold text-slate-700 mb-3 ml-1">Materi & Info Kelas</h3>
                <div id="student-feed-container" class="space-y-4 pb-10">
                    <div class="text-center p-8 text-slate-400"><i class="fa-solid fa-ghost text-2xl mb-2"></i><br>Belum ada postingan guru.</div>
                </div>
            </div>
        </div>
        <!-- 3a. Token Screen -->
        <div id="student-token-screen" class="flex-1 flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl shadow-xl max-w-md w-full overflow-hidden">
                <div class="bg-brand-600 p-8 text-center">
                    <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center mx-auto mb-4 text-white text-3xl"><i class="fa-solid fa-user-graduate"></i></div>
                    <h2 class="text-2xl font-bold text-white">Halo, <span id="stu-name">Siswa</span>!</h2>
                    <p class="text-brand-100 text-sm mt-1" id="stu-class">Kelas -</p>
                </div>
                <div class="p-8 space-y-6">
                    <div class="text-center space-y-2">
                        <h3 class="font-bold text-slate-800 text-lg">Siap Ujian Hari Ini?</h3>
                        <p class="text-slate-500 text-sm">Masukkan token ujian yang diberikan oleh guru pengawas.</p>
                    </div>
                    <div class="space-y-3">
                        <input type="text" id="inp-student-token" placeholder="MASUKKAN TOKEN" class="w-full text-center font-mono text-2xl font-bold tracking-widest p-4 border-2 border-slate-200 rounded-xl focus:border-brand-500 focus:ring-0 outline-none uppercase">
                        <button onclick="window.app.studentCheckToken()" class="w-full bg-brand-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-brand-700 transition transform active:scale-95">MULAI UJIAN</button>
                    </div>
                    <button onclick="window.app.logout()" class="w-full text-slate-400 font-bold text-sm hover:text-red-500">Keluar Akun</button>
                </div>
            </div>
        </div>

        <!-- 3b. Exam Screen (Fullscreen) -->
        <div id="student-exam-screen" class="hidden-section flex-1 flex flex-col h-screen bg-slate-50 relative">
            <!-- Header -->
            <header class="bg-white border-b px-6 py-4 flex justify-between items-center shadow-sm z-20">
                <div>
                    <h1 class="font-bold text-lg text-slate-800" id="ex-title">Ujian</h1>
                    <p class="text-xs text-slate-500" id="ex-subtitle">Paket A</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right"><p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Sisa Waktu</p><div id="ex-timer" class="text-2xl font-mono font-bold text-brand-600 leading-none">00:00:00</div></div>
                    <button onclick="window.app.finishExam()" class="bg-slate-800 text-white px-6 py-2.5 rounded-lg font-bold text-sm hover:bg-black transition shadow-lg">SELESAI</button>
                </div>
            </header>

            <!-- Body -->
            <div class="flex-1 flex overflow-hidden relative">
                <!-- Question Area -->
                <main class="flex-1 overflow-y-auto p-6 lg:p-10 scroll-smooth" id="ex-main">
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 min-h-[60vh]">
                            <div class="flex justify-between items-start mb-6 pb-4 border-b border-slate-100">
                                <h2 class="text-lg font-bold text-slate-800">Soal Nomor <span id="ex-q-no">1</span></h2>
                                <label class="flex items-center gap-2 cursor-pointer bg-yellow-50 px-3 py-1.5 rounded-lg border border-yellow-100 hover:bg-yellow-100 transition">
                                    <input type="checkbox" id="ex-doubt" class="accent-yellow-500 w-4 h-4" onchange="window.app.markDoubt()">
                                    <span class="text-sm font-bold text-yellow-700">Ragu-ragu</span>
                                </label>
                            </div>
                            
                            <!-- Question Content -->
                            <div id="ex-q-content" class="prose max-w-none mb-8 text-slate-700 text-lg">Loading...</div>
                            
                            <!-- Options -->
                            <div id="ex-options" class="space-y-3"></div>
                        </div>
                        
                        <!-- Nav Buttons -->
                        <div class="flex justify-between mt-6">
                            <button onclick="window.app.navQuestion(-1)" class="px-6 py-3 bg-white border border-slate-200 text-slate-600 font-bold rounded-xl hover:bg-slate-50 transition shadow-sm">Sebelumnya</button>
                            <button onclick="window.app.navQuestion(1)" class="px-6 py-3 bg-brand-600 text-white font-bold rounded-xl hover:bg-brand-700 transition shadow-lg shadow-brand-200">Selanjutnya</button>
                        </div>
                    </div>
                </main>

                <!-- Sidebar Navigation -->
                <aside class="w-80 bg-white border-l border-slate-200 flex flex-col z-10 hidden lg:flex shadow-xl">
                    <div class="p-5 border-b bg-slate-50">
                        <h3 class="font-bold text-slate-700 text-sm uppercase tracking-wide text-center">Navigasi Soal</h3>
                    </div>
                    <div class="flex-1 overflow-y-auto p-5">
                        <div id="ex-nav-grid" class="grid grid-cols-5 gap-3"></div>
                    </div>
                    <div class="p-5 border-t bg-slate-50 text-xs text-slate-500 space-y-2">
                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-brand-600"></div> Saat Ini</div>
                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-green-500"></div> Sudah Dijawab</div>
                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-yellow-400"></div> Ragu-ragu</div>
                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-slate-200"></div> Belum Dijawab</div>
                    </div>
                </aside>
            </div>

            <!-- Anti Cheat Warning -->
            <div id="cheat-overlay" class="absolute inset-0 bg-red-600/95 z-50 hidden flex flex-col items-center justify-center text-white text-center p-8">
                <i class="fa-solid fa-triangle-exclamation text-6xl mb-4 animate-bounce"></i>
                <h2 class="text-4xl font-bold mb-2">PERINGATAN KERAS!</h2>
                <p class="text-xl mb-8 max-w-lg">Anda terdeteksi keluar dari area ujian atau mencoba berpindah tab. <br>Ini adalah pelanggaran ke-<span id="violation-count" class="font-bold text-yellow-300 text-3xl">1</span>.</p>
                <p class="text-sm opacity-80 mb-8">Jika mencapai batas maksimal, ujian akan otomatis dihentikan.</p>
                <button onclick="document.getElementById('cheat-overlay').classList.add('hidden')" class="bg-white text-red-600 px-8 py-3 rounded-full font-bold hover:bg-slate-100 transition shadow-xl">KEMBALI KE UJIAN</button>
            </div>
            
            <!-- Calculator Modal (Floating) -->
            <div id="calculator-modal" class="hidden absolute top-20 right-80 bg-white shadow-2xl rounded-xl w-72 z-50 border border-slate-300">
                <div class="flex justify-between items-center p-3 bg-slate-100 rounded-t-xl border-b">
                    <span class="text-sm font-bold text-slate-600">Kalkulator</span>
                    <button onclick="document.getElementById('calculator-modal').classList.add('hidden')" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-4">
                    <input type="text" id="calc-display" class="w-full p-3 mb-3 text-right text-xl font-mono bg-slate-50 border rounded-lg" readonly>
                    <div class="grid grid-cols-4 gap-2">
                         <button onclick="window.app.calcInput('C')" class="p-3 bg-red-100 text-red-600 rounded font-bold">C</button>
                         <button onclick="window.app.calcInput('/')" class="p-3 bg-slate-100 rounded font-bold">/</button>
                         <button onclick="window.app.calcInput('*')" class="p-3 bg-slate-100 rounded font-bold">x</button>
                         <button onclick="window.app.calcInput('-')" class="p-3 bg-slate-100 rounded font-bold">-</button>
                         <button onclick="window.app.calcInput('7')" class="p-3 bg-white border rounded font-bold">7</button>
                         <button onclick="window.app.calcInput('8')" class="p-3 bg-white border rounded font-bold">8</button>
                         <button onclick="window.app.calcInput('9')" class="p-3 bg-white border rounded font-bold">9</button>
                         <button onclick="window.app.calcInput('+')" class="p-3 bg-slate-100 rounded font-bold row-span-2 h-full flex items-center justify-center">+</button>
                         <button onclick="window.app.calcInput('4')" class="p-3 bg-white border rounded font-bold">4</button>
                         <button onclick="window.app.calcInput('5')" class="p-3 bg-white border rounded font-bold">5</button>
                         <button onclick="window.app.calcInput('6')" class="p-3 bg-white border rounded font-bold">6</button>
                         <button onclick="window.app.calcInput('1')" class="p-3 bg-white border rounded font-bold">1</button>
                         <button onclick="window.app.calcInput('2')" class="p-3 bg-white border rounded font-bold">2</button>
                         <button onclick="window.app.calcInput('3')" class="p-3 bg-white border rounded font-bold">3</button>
                         <button onclick="window.app.calcInput('=')" class="p-3 bg-brand-600 text-white rounded font-bold row-span-2 h-full flex items-center justify-center">=</button>
                         <button onclick="window.app.calcInput('0')" class="p-3 bg-white border rounded font-bold col-span-2">0</button>
                         <button onclick="window.app.calcInput('.')" class="p-3 bg-white border rounded font-bold">.</button>
                    </div>
                </div>
            </div>
            <!-- Calculator Toggle Button -->
            <button onclick="document.getElementById('calculator-modal').classList.toggle('hidden')" class="absolute bottom-8 right-8 w-14 h-14 bg-slate-800 text-white rounded-full shadow-xl flex items-center justify-center text-xl hover:bg-slate-900 z-40" title="Buka Kalkulator">
                <i class="fa-solid fa-calculator"></i>
            </button>

        </div>
        
        <!-- 3c. Result Screen -->
        <div id="student-result-screen" class="hidden-section flex-1 flex items-center justify-center p-4 bg-white">
            <div class="max-w-md w-full text-center space-y-6 animate-fade-in">
                <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto text-green-600 text-4xl shadow-sm">
                    <i class="fa-solid fa-check"></i>
                </div>
                <div>
                    <h2 class="text-3xl font-bold text-slate-800">Ujian Selesai!</h2>
                    <p class="text-slate-500 mt-2">Terima kasih telah mengerjakan dengan jujur.</p>
                </div>
                <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Nilai Kamu</p>
                    <div class="text-5xl font-extrabold text-brand-600" id="res-score">0</div>
                </div>
                <button onclick="window.app.logout()" class="w-full bg-slate-800 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-black transition">
                    KELUAR (LOGOUT)
                </button>
            </div>
        </div>
    </div>

    <!-- MODALS (ADMIN) -->
    
    <!-- Modal Soal -->
    <div id="modal-soal" class="fixed inset-0 bg-black/60 z-[9000] hidden flex items-center justify-center p-4 modal-overlay backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-5xl max-h-[95vh] flex flex-col shadow-2xl animate-fade-in">
            <div class="p-5 border-b flex justify-between font-bold bg-slate-50 rounded-t-2xl items-center">
                <span class="text-lg text-slate-800"><i class="fa-solid fa-pen-to-square text-brand-600 mr-2"></i> Editor Bank Soal</span>
                <button onclick="window.app.closeModal('modal-soal')" class="w-8 h-8 rounded-full hover:bg-red-100 hover:text-red-500 transition flex items-center justify-center"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 space-y-6 custom-scrollbar">
                <form id="form-soal" class="space-y-6">
                    <input type="hidden" id="soal-id">
                    <input type="file" id="global-file-input" accept="image/*" class="hidden" onchange="window.app.handleFileUpload(this)">
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                        <div><label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Mapel</label><input id="inp-mapel" class="w-full border-slate-200 border p-3 rounded-xl text-sm font-bold focus:ring-2 focus:ring-brand-500 outline-none" placeholder="Matematika Wajib" required></div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Materi / BAB</label><input id="inp-materi" class="w-full border-slate-200 border p-3 rounded-xl text-sm focus:ring-2 focus:ring-brand-500 outline-none" placeholder="Integral Tentu" required></div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Jenjang</label><select id="inp-kelas" class="w-full border-slate-200 border p-3 rounded-xl text-sm focus:ring-2 focus:ring-brand-500 outline-none"><option value="X">Kelas X</option><option value="XI">Kelas XI</option><option value="XII">Kelas XII</option></select></div>
                    </div>
                    <div class="grid grid-cols-2 gap-5">
                        <div><label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Jenis Soal</label><select id="inp-jenis" class="w-full border-slate-200 border p-3 rounded-xl text-sm font-bold bg-brand-50 focus:ring-2 focus:ring-brand-500 outline-none" onchange="window.app.renderOptionInputs()"><option value="PG">Pilihan Ganda</option><option value="PG_KOMPLEKS">PG Kompleks</option><option value="BENAR_SALAH">Benar / Salah</option><option value="ESSAY">Essay / Uraian</option></select></div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Level Kognitif</label><select id="inp-taksonomi" class="w-full border-slate-200 border p-3 rounded-xl text-sm focus:ring-2 focus:ring-brand-500 outline-none"><option value="C1">C1 - Mengingat</option><option value="C2">C2 - Memahami</option><option value="C3">C3 - Menerapkan</option><option value="C4">C4 - Analisis</option><option value="C5">C5 - Evaluasi</option><option value="C6">C6 - Mencipta</option></select></div>
                    </div>
                    <div class="border border-slate-200 rounded-xl overflow-hidden shadow-sm">
                        <div class="bg-slate-50 p-2 border-b flex gap-2 items-center px-4">
                            <span class="text-xs font-bold text-slate-400 uppercase mr-2">Tools:</span>
                            <button type="button" onclick="window.app.openMathModal('inp-tanya')" class="tool-btn" title="Insert Rumus Matematika">
                                <i class="fa-solid fa-square-root-variable text-lg text-brand-600"></i> <span class="ml-1 text-xs font-bold">Insert Math</span>
                            </button>
                            <div class="h-6 w-px bg-slate-300 mx-2"></div>
                            <div class="flex-1 flex gap-2 items-center">
                                <input type="text" id="inp-img-url" placeholder="Link Gambar (https://...)" class="flex-1 border border-slate-200 p-2 rounded-lg text-xs focus:ring-1 focus:ring-brand-500 outline-none" onchange="window.app.refreshPreview('inp-tanya', 'preview-tanya')">
                                <button type="button" onclick="window.app.triggerImageUpload('inp-img-url')" class="tool-btn bg-blue-50 text-blue-600 border-blue-100 hover:bg-blue-100" title="Upload Gambar"><i class="fa-solid fa-upload mr-2"></i> Upload</button>
                            </div>
                        </div>
                        <textarea id="inp-tanya" rows="5" class="w-full border-0 p-5 text-base font-serif focus:ring-0 outline-none resize-y" placeholder="Ketik pertanyaan soal disini..." oninput="window.app.refreshPreview('inp-tanya', 'preview-tanya')"></textarea>
                    </div>
                    <div class="bg-slate-50 p-5 rounded-xl border border-slate-200">
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">LIVE PREVIEW</p>
                        <div id="preview-tanya" class="prose max-w-none text-slate-800 font-serif min-h-[40px]"></div>
                    </div>
                    <div id="container-options" class="pt-6 space-y-4 border-t border-slate-100"></div>
                </form>
            </div>
            <div class="p-5 border-t bg-slate-50 flex justify-end gap-3 rounded-b-2xl">
                <button onclick="window.app.closeModal('modal-soal')" class="px-6 py-3 text-slate-600 font-bold hover:bg-slate-200 rounded-xl transition">Batal</button>
                <button onclick="window.app.saveSoal()" class="bg-brand-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-brand-700 shadow-lg shadow-brand-200 transition transform active:scale-95 flex items-center gap-2"><i class="fa-solid fa-save"></i> SIMPAN SOAL</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Math Palette -->
    <div id="modal-math"
  class="fixed inset-0 bg-black/50 z-[9000] hidden flex items-center justify-center p-4 backdrop-blur-sm">

  <div
    class="bg-white rounded-2xl w-full max-w-7xl max-h-[90vh] shadow-2xl animate-fade-in flex flex-col">

    <!-- HEADER -->
    <div class="p-5 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
      <h3 class="font-bold text-slate-700 flex items-center gap-2 text-lg">
        <i class="fa-solid fa-calculator text-brand-500"></i>
        Sisipkan Simbol Matematika
      </h3>
      <button
        onclick="window.app.closeModal('modal-math')"
        class="text-slate-400 hover:text-red-500 text-2xl font-bold leading-none">
        &times;
      </button>
    </div>

    <!-- BODY -->
    <div class="p-6 overflow-y-auto flex-1 custom-scrollbar">

      <!-- GRID SIMBOL -->
      <div class="grid grid-cols-8 md:grid-cols-10 lg:grid-cols-12 gap-3">
                    <button class="math-btn" onclick="window.app.insertMath('x^{n}')">$x^n$</button>
                    <button class="math-btn" onclick="window.app.insertMath('x_{n}')">$x_n$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\frac{a}{b}')">$\frac{a}{b}$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\sqrt{x}')">$\sqrt{x}$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\sqrt[n]{x}')">$\sqrt[n]{x}$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\overline{AB}')">$\overline{AB}$</button>
                    <button class="math-btn" onclick="window.app.insertMath('|x|')">$|x|$</button>
                    <button class="math-btn" onclick="window.app.insertMath('+')">+</button>
                    <button class="math-btn" onclick="window.app.insertMath('-')"></button>
                    <button class="math-btn" onclick="window.app.insertMath('\\times')">$\times$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\div')">$\div$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\pm')">$\pm$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\cdot')">$\cdot$</button>
                    <button class="math-btn" onclick="window.app.insertMath('=')">=</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\neq')">$\neq$</button>
                    <button class="math-btn" onclick="window.app.insertMath('<')"><</button>
                    <button class="math-btn" onclick="window.app.insertMath('>')">></button>
                    <button class="math-btn" onclick="window.app.insertMath('\\leq')">$\leq$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\geq')">$\geq$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\approx')">$\approx$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\propto')">$\propto$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\sum')">$\sum$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\int')">$\int$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\iint')">$\iint$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\oint')">$\oint$</button>
                    <button class="math-btn" onclick="window.app.insertMath('f(x)')">$f(x)$</button>
                    <button class="math-btn" onclick="window.app.insertMath('f^{\\prime}(x)')">$f'(x)$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\frac{dy}{dx}')">$\frac{dy}{dx}$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\frac{\\partial}{\\partial x}')">$\frac{\partial}{\partial x}$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\in')">$\in$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\notin')">$\notin$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\subset')">$\subset$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\subseteq')">$\subseteq$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\cup')">$\cup$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\cap')">$\cap$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\emptyset')">$\emptyset$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\land')">$\land$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\lor')">$\lor$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\lnot')">$\lnot$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\Rightarrow')">$\Rightarrow$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\Leftrightarrow')">$\Leftrightarrow$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\rightarrow')">$\rightarrow$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\leftarrow')">$\leftarrow$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\Rightarrow')">$\Rightarrow$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\mapsto')">$\mapsto$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\leftrightarrow')">$\leftrightarrow$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\triangle')">$\triangle$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\angle')">$\angle$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\perp')">$\perp$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\parallel')">$\parallel$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\circ')">$\circ$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\bar{x}')">$\bar{x}$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\hat{p}')">$\hat{p}$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\sigma')">$\sigma$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\mu')">$\mu$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\Sigma')">$\Sigma$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\alpha')">$\alpha$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\beta')">$\beta$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\gamma')">$\gamma$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\delta')">$\delta$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\epsilon')">$\epsilon$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\theta')">$\theta$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\lambda')">$\lambda$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\pi')">$\pi$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\rho')">$\rho$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\phi')">$\phi$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\omega')">$\omega$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\Delta')">$\Delta$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\Theta')">$\Theta$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\Lambda')">$\Lambda$</button>
                    <button class="math-btn" onclick="window.app.insertMath('\\Omega')">$\Omega$</button>
                    <br><br>

                                        <!-- Pilihan Ordo Matriks -->
                                    <!-- Pilih Ordo Matrix -->
                    <div class="flex items-center gap-2 mt-3">
                        <input id="matrix-rows" type="number" min="1" placeholder="m" 
                            class="w-16 p-2 border rounded-lg text-center" />
                        <span class="font-bold"></span>
                        <input id="matrix-cols" type="number" min="1" placeholder="n" 
                            class="w-16 p-2 border rounded-lg text-center" />
                    </div>

                    <!-- Button Insert Matrix -->
                    <button class="math-btn mt-2" onclick="window.app.insertEmptyMatrix()">
                        Matriks m  n
                    </button>

                    <script>
                    window.app.insertEmptyMatrix = function () {
                        const m = parseInt(document.getElementById("matrix-rows").value);
                        const n = parseInt(document.getElementById("matrix-cols").value);

                        if (!m || !n || m <= 0 || n <= 0) {
                            alert("Isi ordo matriks dengan benar (m  n)");
                            return;
                        }

                        let rows = [];

                        for (let i = 0; i < m; i++) {
                            let cols = [];
                            for (let j = 0; j < n; j++) {
                                cols.push(" ");
                            }
                            rows.push(cols.join(" & "));
                        }

                        const latex = `\\begin{bmatrix} ${rows.join(" \\\\ ")} \\end{bmatrix}`;

                        window.app.insertMath(latex);
                    };
                    </script>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal User -->
    <div id="modal-user" class="fixed inset-0 bg-black/60 z-[9000] hidden flex items-center justify-center p-4 modal-overlay backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-md p-8 shadow-2xl">
            <h3 class="font-bold text-xl mb-6 text-slate-800" id="modal-user-title">Kelola User</h3>
            <form id="form-user" class="space-y-5">
                <input type="hidden" id="user-edit-id">
                <div><label class="text-xs font-bold text-slate-500 uppercase">Nama Lengkap</label><input id="user-nama" class="w-full border p-3 rounded-xl mt-1 focus:ring-2 focus:ring-brand-500 outline-none" required></div>
                <div><label class="text-xs font-bold text-slate-500 uppercase">Email</label><input id="user-email" class="w-full border p-3 rounded-xl mt-1 focus:ring-2 focus:ring-brand-500 outline-none" required></div>
                <div><label class="text-xs font-bold text-slate-500 uppercase">Password</label><input id="user-pass" class="w-full border p-3 rounded-xl mt-1 focus:ring-2 focus:ring-brand-500 outline-none" placeholder="Biarkan kosong jika tidak diubah"></div>
                <div class="grid grid-cols-2 gap-4">
                                        <!-- MAPEL DIAMPU - MUNCUL HANYA UNTUK GURU -->
                    <div id="wrap-mapel" class="hidden">
                        <label class="text-xs font-bold text-slate-500 uppercase">Mapel Diampu</label>
                        <select id="user-mapel" multiple
                            class="w-full border p-3 rounded-xl mt-1 bg-white">
                            <option value="Matematika">Matematika</option>
                    <option value="Matematika Tingkat Lanjut">Matematika Tingkat Lanjut</option>

                    <option value="Biologi">Biologi</option>

                    <option value="Fisika">Fisika</option>
                    <option value="Kimia">Kimia</option>

                    <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                    <option value="Bahasa Indonesia Tingkat Lanjut">Bahasa Indonesia Tingkat Lanjut</option>

                    <option value="Bahasa Inggris">Bahasa Inggris</option>
                    <option value="Bahasa Inggris Tingkat Lanjut">Bahasa Inggris Tingkat Lanjut</option>

                    <option value="PPKn">Pendidikan Pancasila dan Kewarganegaraan</option>

                    <option value="Ekonomi">Ekonomi</option>
                    <option value="Geografi">Geografi</option>
                    <option value="Sosiologi">Sosiologi</option>
                    <option value="Sejarah">Sejarah</option>
                    <option value="Antropologi">Antropologi</option>

                    <option value="Bahasa Prancis">Bahasa Prancis</option>
                    <option value="Bahasa Jerman">Bahasa Jerman</option>
                    <option value="Bahasa Jepang">Bahasa Jepang</option>
                    <option value="Bahasa Mandarin">Bahasa Mandarin</option>
                    <option value="Bahasa Korea">Bahasa Korea</option>
                    <option value="Bahasa Arab">Bahasa Arab</option>

                    <option value="Produk Kreatif dan Kewirausahaan">
                        Produk atau Projek Kreatif dan Kewirausahaan SMK dan MAK
                    </option>

                        </select>
                    </div>

                    <!-- OPSIONAL: NIP GURU -->
                    <div id="wrap-nip" class="hidden">
                        <label class="text-xs font-bold text-slate-500 uppercase">NIP (Opsional)</label>
                        <input id="user-nip" class="w-full border p-3 rounded-xl mt-1 focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>

                    <div><label class="text-xs font-bold text-slate-500 uppercase">Role</label><select id="user-role" class="w-full border p-3 rounded-xl mt-1"><option value="siswa">Siswa</option><option value="guru">Guru</option><option value="admin">Admin</option><option value="piket">Petugas Piket</option></select></div>
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Kelas</label>
                        <select id="user-kelas" class="w-full border p-3 rounded-xl mt-1 bg-white class-selector-single"></select>
                    </div>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="window.app.closeModal('modal-user')" class="flex-1 py-3 bg-slate-100 font-bold rounded-xl text-slate-600">Batal</button>
                    <button type="submit" class="flex-1 py-3 bg-brand-600 text-white font-bold rounded-xl shadow hover:bg-brand-700">SIMPAN</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Tambah/Edit Kelas -->
    <div id="modal-kelas" class="fixed inset-0 bg-black/60 z-[9000] hidden flex items-center justify-center p-4 modal-overlay backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-md p-8 shadow-2xl">
            <h3 class="font-bold text-xl mb-6 text-slate-800">Data Kelas</h3>
            <form id="form-kelas" class="space-y-5">
                <input type="hidden" id="kelas-id">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Nama Kelas</label>
                    <input id="inp-kelas-nama" class="w-full border p-3 rounded-xl mt-1 font-bold focus:ring-2 focus:ring-brand-500 outline-none" placeholder="Contoh: X-RPL-1" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">Jenjang</label>
                        <select id="inp-kelas-jenjang" class="w-full border p-3 rounded-xl mt-1 bg-white"><option value="X">Kelas X</option><option value="XI">Kelas XI</option><option value="XII">Kelas XII</option></select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">Jurusan/Mapel Utama</label>
                        <input id="inp-kelas-jurusan" class="w-full border p-3 rounded-xl mt-1" placeholder="IPA/IPS/RPL">
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Wali Kelas (Guru)</label>
                    <select id="inp-kelas-wali" class="w-full border p-3 rounded-xl mt-1 bg-white"><option value="">-- Pilih Guru --</option></select>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="window.app.closeModal('modal-kelas')" class="flex-1 py-3 bg-slate-100 font-bold rounded-xl text-slate-600">Batal</button>
                    <button type="submit" class="flex-1 py-3 bg-brand-600 text-white font-bold rounded-xl shadow hover:bg-brand-700">SIMPAN</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Atur Guru Mapel -->
    <div id="modal-atur-guru" class="fixed inset-0 bg-black/60 z-[9000] hidden flex items-center justify-center p-4 modal-overlay backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-3xl max-h-[90vh] flex flex-col shadow-2xl">
            <div class="p-5 border-b flex justify-between font-bold bg-slate-50 rounded-t-2xl items-center">
                <span class="text-lg text-slate-800" id="title-atur-guru">Atur Guru Pengampu</span>
                <button onclick="window.app.closeModal('modal-atur-guru')" class="w-8 h-8 rounded-full hover:bg-red-100 hover:text-red-500 transition flex items-center justify-center"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 custom-scrollbar">
                <input type="hidden" id="atur-guru-kelas-id">
                <div id="container-atur-guru" class="space-y-3"></div>
            </div>
            <div class="p-5 border-t bg-slate-50 flex justify-end gap-3 rounded-b-2xl">
                <button onclick="window.app.closeModal('modal-atur-guru')" class="px-6 py-3 text-slate-600 font-bold hover:bg-slate-200 rounded-xl transition">Batal</button>
                <button onclick="window.app.saveGuruMapel()" class="bg-brand-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-brand-700 shadow-lg transition transform active:scale-95">SIMPAN PERUBAHAN</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Agenda (New) -->
    <div id="modal-agenda" class="fixed inset-0 bg-black/60 z-[9000] hidden flex items-center justify-center p-4 modal-overlay backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-3xl max-h-[90vh] flex flex-col shadow-2xl">
            <div class="p-5 border-b flex justify-between font-bold bg-slate-50 rounded-t-2xl items-center">
                <span class="text-lg text-slate-800"><i class="fa-solid fa-book-open text-brand-600 mr-2"></i> Jurnal Mengajar</span>
                <button onclick="window.app.closeModal('modal-agenda')" class="w-8 h-8 rounded-full hover:bg-red-100 hover:text-red-500 transition flex items-center justify-center"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 custom-scrollbar">
                <form id="form-agenda" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                         <div><label class="text-xs font-bold text-slate-500 uppercase">Tanggal</label><input type="date" id="ag-tgl" class="w-full border p-2.5 rounded-xl text-sm font-bold mt-1" onchange="window.app.calculateAbsensiForAgenda()"></div>
                         <div><label class="text-xs font-bold text-slate-500 uppercase">Kelas</label><select id="ag-kelas" class="w-full border p-2.5 rounded-xl text-sm bg-white mt-1 class-selector-full" onchange="window.app.calculateAbsensiForAgenda()"></select></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                         <div><label class="text-xs font-bold text-slate-500 uppercase">Mapel</label><select id="ag-mapel" class="w-full border p-2.5 rounded-xl text-sm bg-white mt-1" onchange="window.app.calculateAbsensiForAgenda()"></select></div>
                         <div><label class="text-xs font-bold text-slate-500 uppercase">Jam Ke-</label><input type="text" id="ag-jam" class="w-full border p-2.5 rounded-xl text-sm mt-1" placeholder="ex: 1-3"></div>
                    </div>
                    
                    <!-- Auto-filled attendance summary -->
                    <div class="bg-blue-50 border border-blue-100 p-3 rounded-xl flex justify-between items-center text-sm text-blue-800">
                        <div class="font-bold flex items-center gap-2"><i class="fa-solid fa-user-check"></i> Kehadiran:</div>
                        <div class="flex gap-3 text-xs font-mono" id="ag-attendance-summary">
                            <span>H: -</span> <span>S: -</span> <span>I: -</span> <span>A: -</span>
                        </div>
                    </div>

                    <div><label class="text-xs font-bold text-slate-500 uppercase">Materi Pembelajaran</label><textarea id="ag-materi" class="w-full border p-3 rounded-xl mt-1 text-sm h-20" placeholder="Topik/Materi yang diajarkan..."></textarea></div>
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Tugas / PR</label><textarea id="ag-tugas" class="w-full border p-3 rounded-xl mt-1 text-sm h-16" placeholder="Tugas untuk siswa..."></textarea></div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-xs font-bold text-slate-500 uppercase">Bukti Kegiatan (Foto)</label>
                            <input type="file" id="ag-foto-file" accept="image/*" class="w-full text-xs mt-1" onchange="window.app.handleAgendaFoto(this)">
                            <input type="hidden" id="ag-foto-base64">
                            <div id="ag-foto-preview" class="mt-2 h-20 bg-slate-100 rounded-lg bg-cover bg-center"></div>
                        </div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase">Link Dokumen (Opsional)</label><input type="text" id="ag-link" class="w-full border p-2.5 rounded-xl text-sm mt-1" placeholder="Link GDrive/Youtube..."></div>
                    </div>
                </form>
            </div>
            <div class="p-5 border-t bg-slate-50 flex justify-end gap-3 rounded-b-2xl">
                <button onclick="window.app.closeModal('modal-agenda')" class="px-6 py-3 text-slate-600 font-bold hover:bg-slate-200 rounded-xl transition">Batal</button>
                <button onclick="window.app.saveAgenda()" class="bg-brand-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-brand-700 shadow-lg transition">SIMPAN JURNAL</button>
            </div>
        </div>
    </div>

    <!-- Modal Roster (Masukin Siswa) -->
    <div id="modal-roster" class="fixed inset-0 bg-black/60 z-[9000] hidden flex items-center justify-center p-4 modal-overlay backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-3xl p-6 shadow-2xl flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <div>
                    <h3 class="font-bold text-xl text-slate-800">Atur Siswa</h3>
                    <p class="text-sm text-brand-600 font-bold" id="roster-kelas-title">Kelas: -</p>
                </div>
                <button onclick="window.app.closeModal('modal-roster')" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="grid grid-cols-2 gap-6 flex-1 overflow-hidden">
                <div class="flex flex-col bg-slate-50 p-4 rounded-xl border">
                    <h4 class="font-bold text-xs uppercase text-slate-500 mb-2">Siswa Belum Ada Kelas / Lainnya</h4>
                    <input type="text" id="search-siswa-avail" placeholder="Cari nama..." class="border p-2 rounded-lg text-xs mb-2 w-full" onkeyup="window.app.filterRoster('avail')">
                    <div id="list-siswa-avail" class="flex-1 overflow-y-auto space-y-2 custom-scrollbar pr-2"></div>
                </div>
                <div class="flex flex-col bg-brand-50 p-4 rounded-xl border border-brand-100">
                    <h4 class="font-bold text-xs uppercase text-brand-600 mb-2">Siswa Terdaftar di Sini</h4>
                    <input type="text" id="search-siswa-reg" placeholder="Cari nama..." class="border p-2 rounded-lg text-xs mb-2 w-full" onkeyup="window.app.filterRoster('reg')">
                    <div id="list-siswa-reg" class="flex-1 overflow-y-auto space-y-2 custom-scrollbar pr-2"></div>
                </div>
            </div>
            <p class="text-[10px] text-slate-400 mt-3 italic">*Klik tombol panah di samping nama untuk memindahkan siswa.</p>
        </div>
    </div>

    <!-- Modal Sesi -->
    <div id="modal-sesi" class="fixed inset-0 bg-black/60 z-[9000] hidden flex items-center justify-center p-4 modal-overlay backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-md p-8 shadow-2xl">
            <h3 class="font-bold text-xl mb-6 text-slate-800">Setting Sesi Ujian</h3>
            <form id="form-sesi" class="space-y-5">
                <input type="hidden" id="sesi-id">
                <div><label class="text-xs font-bold text-slate-500 uppercase">Mapel</label><input id="sesi-mapel" class="w-full border p-3 rounded-xl mt-1 font-bold"></div>
                <div><label class="text-xs font-bold text-slate-500 uppercase">Filter Materi (Opsional)</label><input id="sesi-materi" class="w-full border p-3 rounded-xl mt-1"></div>
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Target Peserta</label>
                    <div class="flex gap-2">
                        <select id="sesi-jenjang" class="border p-2 rounded-lg text-sm w-1/3 bg-white"><option value="">Semua</option><option value="X">Kelas X</option><option value="XI">Kelas XI</option><option value="XII">Kelas XII</option></select>
                        <input id="sesi-kelas-spesifik" placeholder="Kelas Khusus (ex: X-1)" class="border p-2 rounded-lg text-sm w-2/3">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Durasi (Menit)</label><input type="number" id="sesi-durasi" value="60" class="w-full border p-3 rounded-xl mt-1"></div>
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Jml Soal</label><input type="number" id="sesi-jml" value="20" class="w-full border p-3 rounded-xl mt-1"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Max Kesempatan</label><input type="number" id="sesi-attempt" value="1" class="w-full border p-3 rounded-xl mt-1"></div>
                    <div><label class="text-xs font-bold text-red-500 uppercase">Batas Curang</label><input type="number" id="sesi-max-curang" value="3" class="w-full border p-3 rounded-xl mt-1 border-red-200 bg-red-50"></div>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="window.app.closeModal('modal-sesi')" class="flex-1 py-3 bg-slate-100 font-bold rounded-xl text-slate-600">Batal</button>
                    <button type="button" onclick="window.app.generateSesi()" class="flex-1 py-3 bg-purple-600 text-white font-bold rounded-xl shadow hover:bg-purple-700">GENERATE/UPDATE</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Import (File Input) -->
    <div id="modal-import" class="fixed inset-0 bg-black/60 z-[9000] hidden flex items-center justify-center p-4 modal-overlay backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-lg p-8 shadow-2xl">
            <h3 class="font-bold text-xl mb-4 text-slate-800">Import User (CSV)</h3>
            <div class="bg-yellow-50 border border-yellow-100 p-3 rounded-lg mb-4 text-xs text-yellow-800">Format: <code>Nama,Email,Password,Role,Kelas</code></div>
            
            <!-- FILE UPLOAD AREA -->
            <div class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:bg-slate-50 transition cursor-pointer group" onclick="document.getElementById('file-import-csv').click()">
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-brand-100 transition">
                    <i class="fa-solid fa-cloud-arrow-up text-2xl text-slate-400 group-hover:text-brand-600"></i>
                </div>
                <p class="font-bold text-slate-600">Klik untuk Upload CSV</p>
                <p class="text-xs text-slate-400 mt-1">atau drop file di sini</p>
                <input type="file" id="file-import-csv" accept=".csv" class="hidden" onchange="window.app.handleImportFileSelect(this)">
            </div>
            <div id="import-filename" class="text-center mt-4 text-sm font-bold text-brand-600 hidden"></div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="window.app.closeModal('modal-import')" class="px-6 py-3 bg-slate-100 rounded-xl font-bold text-slate-600 hover:bg-slate-200">Batal</button>
                <button onclick="window.app.processImport()" class="px-8 py-3 bg-green-600 text-white rounded-xl font-bold shadow hover:bg-green-700 flex items-center gap-2"><i class="fa-solid fa-upload"></i> PROSES</button>
            </div>
        </div>
    </div>
    <!-- MODAL KONFIGURASI SEKOLAH (TAHUN AJARAN) -->
    <div id="modal-school-config" class="fixed inset-0 bg-black/60 z-[9000] hidden flex items-center justify-center p-4 modal-overlay backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="font-bold text-xl mb-4 text-slate-800 border-b pb-2">Konfigurasi Sekolah</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Tahun Ajaran Aktif</label>
                    <select id="cfg-tahun" class="w-full border p-3 rounded-xl mt-1 font-bold text-slate-700 bg-white focus:ring-2 focus:ring-brand-500 outline-none">
                        <option value="2023/2024">2023/2024</option>
                        <option value="2024/2025">2024/2025</option>
                        <option value="2025/2026">2025/2026</option>
                        <option value="2026/2027">2026/2027</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Semester Aktif</label>
                    <select id="cfg-semester" class="w-full border p-3 rounded-xl mt-1 font-bold text-slate-700 bg-white focus:ring-2 focus:ring-brand-500 outline-none">
                        <option value="Ganjil">Ganjil</option>
                        <option value="Genap">Genap</option>
                    </select>
                </div>
                <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-100 text-xs text-yellow-800 leading-relaxed">
                    <i class="fa-solid fa-triangle-exclamation mr-1"></i> <b>Penting:</b><br>
                    Perubahan ini akan mempengaruhi semua data yang tampil (Nilai, Absensi, Jurnal, Pelanggaran). Data lama akan disembunyikan (diarsip), bukan dihapus.
                </div>
                <div class="flex gap-3 pt-2">
                    <button onclick="window.app.closeModal('modal-school-config')" class="flex-1 py-3 bg-slate-100 font-bold rounded-xl text-slate-600">Batal</button>
                    <button onclick="window.app.saveSchoolConfig()" class="flex-1 py-3 bg-brand-600 text-white font-bold rounded-xl shadow hover:bg-brand-700">SIMPAN</button>
                </div>
            </div>
        </div>
    </div>
    <!-- MODAL KENAIKAN KELAS MASSAL -->
    <div id="modal-promote" class="fixed inset-0 bg-black/60 z-[9000] hidden flex items-center justify-center p-4 modal-overlay backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-lg p-8 shadow-2xl">
            <h3 class="font-bold text-xl mb-2 text-slate-800">Proses Kenaikan Kelas</h3>
            <p class="text-sm text-slate-500 mb-6">Pindahkan semua siswa dari satu kelas ke kelas tingkat selanjutnya.</p>
            
            <div class="space-y-4">
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 flex items-center gap-4">
                    <div class="flex-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase">Dari Kelas (Sumber)</label>
                        <select id="prm-sumber" class="w-full border p-2 rounded-lg mt-1 font-bold bg-white class-selector-full"></select>
                    </div>
                    <div class="pt-4"><i class="fa-solid fa-arrow-right text-slate-400"></i></div>
                    <div class="flex-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase">Ke Kelas (Tujuan)</label>
                        <select id="prm-tujuan" class="w-full border p-2 rounded-lg mt-1 font-bold bg-white class-selector-full"></select>
                    </div>
                </div>

                <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-100 text-xs text-yellow-800">
                    <i class="fa-solid fa-circle-info mr-1"></i> <b>Info:</b><br>
                    Siswa di kelas <b>Sumber</b> akan dipindahkan ke kelas <b>Tujuan</b>. Data nilai & histori lama tetap aman tersimpan di arsip tahun ajaran sebelumnya.
                </div>
            </div>

            <div class="flex gap-3 pt-6">
                <button onclick="window.app.closeModal('modal-promote')" class="flex-1 py-3 bg-slate-100 font-bold rounded-xl text-slate-600">Batal</button>
                <button onclick="window.app.processPromote()" class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow hover:bg-indigo-700">PROSES PINDAH</button>
            </div>
        </div>
    </div>
        <!-- Modal Analisis Soal -->
    <div id="modal-analisis" class="hidden fixed inset-0 bg-black/60 z-[9000] flex items-center justify-center p-4 modal-overlay backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-2xl shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-5 border-b flex justify-between font-bold bg-slate-50 rounded-t-2xl items-center">
                <span class="text-lg text-slate-800">Analisis Butir Soal</span>
                <button onclick="window.app.closeModal('modal-analisis')" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 custom-scrollbar">
                <div id="analisis-container" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <!-- LOGIC SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDocs, getDoc, setDoc, addDoc, updateDoc, deleteDoc, query, where, orderBy, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyB5zXw31sraQnZ3fwFOtkP_O-ZmDWQxvfE", authDomain: "dashboardgururizal.firebaseapp.com", projectId: "dashboardgururizal", storageBucket: "dashboardgururizal.firebasestorage.app", messagingSenderId: "1067383843556", appId: "1:1067383843556:web:ea2bba08be02a5f5bedaf1" };
        
        const appMain = initializeApp(firebaseConfig, "Primary");
        const auth = getAuth(appMain);
        const db = getFirestore(appMain);

        const state = { user: null, profile: null, schoolConfig: { tahun: '2024/2025', semester: 'Ganjil' }, exam: { data: null, questions: [], answers: {}, timer: null, activeQ: 0, violations: 0 }, selectedUsers: [], pendingUploadTarget: null, activeInputId: null, currentNilaiData: [], currentRekapAbsen: [], currentAgendaData: [], currentLegerData: [], currentLegerColumns: [] };

        // --- KONFIGURASI DATA PELANGGARAN ---
        const DATA_PELANGGARAN = {
            "A": {
                label: " Pelanggaran Berat (50-100)",
                items: [
                    { id: "A1", label: "Membawa/Merokok/Vape", poin: 75 },
                    { id: "A2", label: "Narkoba/Miras", poin: 100 },
                    { id: "A3", label: "Tawuran/Perkelahian", poin: 100 },
                    { id: "A4", label: "Membawa Senjata Tajam", poin: 75 },
                    { id: "A5", label: "Bullying Fisik", poin: 75 },
                    { id: "A6", label: "Pelecehan Seksual", poin: 100 },
                    { id: "A7", label: "Mencuri", poin: 75 },
                    { id: "A8", label: "Merusak Fasilitas", poin: 75 },
                    { id: "A9", label: "Memalsukan TTD", poin: 50 },
                    { id: "A10", label: "Melawan/Mengancam Guru", poin: 100 }
                ]
            },
            "B": {
                label: " Pelanggaran Sedang (20-45)",
                items: [
                    { id: "B1", label: "Membolos", poin: 25 },
                    { id: "B2", label: "Keluar saat jam pelajaran", poin: 35 },
                    { id: "B3", label: "Mencontek", poin: 45 },
                    { id: "B4", label: "Main HP tanpa izin", poin: 20 },
                    { id: "B5", label: "Bullying Verbal/Ejekan", poin: 30 },
                    { id: "B6", label: "Pacaran berlebihan", poin: 30 },
                    { id: "B7", label: "Tidak mengerjakan tugas (berulang)", poin: 25 },
                    { id: "B8", label: "Berbohong pada guru", poin: 25 },
                    { id: "B9", label: "Tidak Upacara", poin: 20 }
                ]
            },
            "C": {
                label: " Pelanggaran Ringan (5-15)",
                items: [
                    { id: "C1", label: "Atribut tidak lengkap", poin: 5 },
                    { id: "C2", label: "Rambut tidak rapi", poin: 5 },
                    { id: "C3", label: "Tidak bawa buku", poin: 5 },
                    { id: "C4", label: "Makan di kelas", poin: 5 },
                    { id: "C5", label: "Berisik", poin: 5 },
                    { id: "C6", label: "Tidak menjaga kebersihan", poin: 10 },
                    { id: "C7", label: "Tidak sopan", poin: 5 }
                ]
            },
            "D": {
                label: " Keterlambatan",
                items: [
                    { id: "D1", label: "Telat 1-10 menit (1-2x)", poin: 5 },
                    { id: "D2", label: "Telat 1-10 menit (3x)", poin: 10 },
                    { id: "D3", label: "Telat 11-30 menit", poin: 15 },
                    { id: "D4", label: "Telat >30 menit (Bolos)", poin: 25 },
                    { id: "D5", label: "Telat Upacara", poin: 20 }
                ]
            }
        };

        const STANDARD_MAPEL_LIST = [
            "Matematika", "Matematika Tingkat Lanjut", "Biologi", "Fisika", "Kimia", 
            "Bahasa Indonesia", "Bahasa Indonesia Tingkat Lanjut", "Bahasa Inggris", "Bahasa Inggris Tingkat Lanjut", 
            "Sejarah", "Geografi", "Sosiologi", "Ekonomi", "PPKn", "Agama", "Penjas", "Seni Budaya", "Prakarya", "Informatika",
            "Bahasa Arab", "Bahasa Jepang", "Bahasa Jerman", "Bahasa Mandarin", "Bahasa Prancis", "Bahasa Korea"
        ];

        const ui = {
            el: (id) => document.getElementById(id),
            show: (id) => { const el = document.getElementById(id); if(el) el.classList.remove('hidden-section', 'hidden'); },
            hide: (id) => { const el = document.getElementById(id); if(el) el.classList.add('hidden'); },
            resetPages: () => { 
                ['view-login', 'layout-dashboard', 'view-student-portal', 'view-exam', 'page-dashboard', 'page-bank-soal', 'page-sesi-ujian', 'page-nilai', 'page-users', 'page-siswa-home', 'page-kelas', 'page-presensi', 'page-rekap-absensi', 'page-agenda','page-kegiatan', 'student-home-screen', 'page-nilai-harian','page-leger','page-piket','page-atur-jadwal'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.classList.add('hidden-section');
                }); 
            },
            loading: (on, text="Memuat Sistem...") => { 
                const l=document.getElementById('global-loader'); 
                const t=document.getElementById('loader-text');
                if(t) t.innerText = text;
                if(on){l.style.display='flex';setTimeout(()=>l.style.opacity='1',10);}
                else{l.style.opacity='0';setTimeout(()=>l.style.display='none',300);} 
            },
            toast: (m,i='success') => Swal.fire({icon:i,title:m,toast:true,position:'top-end',showConfirmButton:false,timer:1500})
        };
                // === TOGGLE SIDEBAR MOBILE ===
        window.app.toggleSidebar = () => {
            const sidebar = document.querySelector('aside');
            const overlayId = 'sidebar-overlay';
            
            // Cek apakah sedang terbuka (kita cek dari class 'hidden' di layar kecil)
            // Logika default Tailwind: hidden md:flex.
            // Kita akan paksa remove 'hidden' dan tambah styling absolute.
            
            if (sidebar.classList.contains('hidden')) {
                // Buka Sidebar
                sidebar.classList.remove('hidden');
                sidebar.classList.add('fixed', 'inset-y-0', 'left-0', 'z-40', 'w-72', 'shadow-2xl', 'transition-transform');
                
                // Buat Overlay Gelap di belakangnya agar fokus
                const overlay = document.createElement('div');
                overlay.id = overlayId;
                overlay.className = 'fixed inset-0 bg-black/50 z-30 transition-opacity fade-in md:hidden';
                overlay.onclick = window.app.toggleSidebar; // Klik luar untuk tutup
                document.body.appendChild(overlay);
            } else {
                // Tutup Sidebar
                sidebar.classList.add('hidden');
                sidebar.classList.remove('fixed', 'inset-y-0', 'left-0', 'z-40', 'shadow-2xl');
                
                // Hapus Overlay
                const overlay = document.getElementById(overlayId);
                if (overlay) overlay.remove();
            }
        };
                // Hapus Kegiatan
        window.app.deleteKegiatan = async (id) => {
            const r = await Swal.fire({
                title: 'Hapus Postingan?',
                text: "Tidak bisa dikembalikan.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Ya, Hapus'
            });
            
            if (r.isConfirmed) {
                ui.loading(true);
                try {
                    await deleteDoc(doc(db, 'data_kegiatan_kelas', id));
                    ui.toast('Terhapus');
                    window.app.loadKegiatanGuru(); // Reload feed
                } catch (e) {
                    Swal.fire('Error', e.message, 'error');
                }
                ui.loading(false);
            }
        };

        // Edit Teks Kegiatan
        window.app.editKegiatan = async (id, currentText) => {
            const { value: text } = await Swal.fire({
                title: 'Edit Postingan',
                input: 'textarea',
                inputLabel: 'Edit teks konten',
                inputValue: currentText,
                showCancelButton: true,
                inputValidator: (value) => {
                    if (!value) return 'Tulis sesuatu!'
                }
            });

            if (text) {
                ui.loading(true);
                try {
                    await updateDoc(doc(db, 'data_kegiatan_kelas', id), {
                        text: text,
                        updated_at: serverTimestamp()
                    });
                    ui.toast('Diupdate');
                    window.app.loadKegiatanGuru();
                } catch (e) {
                    Swal.fire('Error', e.message, 'error');
                }
                ui.loading(false);
            }
        };

                      window.app.navStudent = (tab) => {

            // Sembunyikan semua layar siswa
            ui.hide('student-home-screen');
            ui.hide('student-token-screen');
            ui.hide('student-exam-screen');
            ui.hide('student-result-screen');

            // Reset warna tombol nav
            document.getElementById('btn-nav-home').classList.remove('text-brand-600');
            document.getElementById('btn-nav-exam').classList.remove('text-brand-600');

                       // --- HOME ---
            if (tab === 'home') {
                ui.show('student-home-screen');
                document.getElementById('btn-nav-home').classList.add('text-brand-600');
                window.app.loadStudentHome();
            }

                        // --- EXAM TOKEN ---
            if (tab === 'exam') {
                ui.show('student-token-screen');
                document.getElementById('btn-nav-exam').classList.add('text-brand-600');
            }
        };

        // 2. UPDATE FUNGSI JAVASCRIPT: window.app.postKegiatan
        window.app.postKegiatan = async () => {
             const txt = ui.el('kegiatan-text').value;
             const cls = ui.el('kegiatan-kelas').value;
             const img = ui.el('kegiatan-img').value;
             const link = ui.el('kegiatan-link').value; // Ambil Link

             if(!txt && !img && !link) return Swal.fire('Gagal', 'Mohon isi teks, upload foto, atau masukkan link.', 'warning');

             ui.loading(true);
             try {
                 await addDoc(collection(db, 'data_kegiatan_kelas'), {
                     kelas: cls,
                     text: txt,
                     foto: img,
                     link: link, // Simpan Link
                     guru_id: auth.currentUser.uid,
                     guru_nama: state.profile.nama,
                     created_at: serverTimestamp()
                 });
                 ui.toast('Berhasil memposting');
                 // Reset Form
                 ui.el('kegiatan-text').value='';
                 ui.el('kegiatan-img').value='';
                 ui.el('kegiatan-link').value=''; // Reset Link
                 ui.el('preview-kegiatan-img').style.backgroundImage='';
                 ui.el('preview-kegiatan-img').classList.add('hidden');
                 window.app.loadKegiatanGuru();
             } catch(e) { console.error(e); }
             ui.loading(false);
        };

              // === FIX: LOAD KEGIATAN GURU (CLIENT-SIDE SORTING) ===
            window.app.loadKegiatanGuru = async () => {
                const c = ui.el('feed-container-guru');
                const fKelas = ui.el('filter-feed-guru').value;
                c.innerHTML = '<div class="text-center py-10 text-slate-400">Memuat timeline...</div>';

                try {
                let q = fKelas === 'ALL'
                    ? query(collection(db, 'data_kegiatan_kelas'), limit(30))
                    : query(collection(db, 'data_kegiatan_kelas'), where('kelas','==',fKelas));

                const snap = await getDocs(q);
                c.innerHTML = '';
                if(snap.empty){
                    c.innerHTML='<div class="text-center py-10 text-slate-400 italic">Belum ada kegiatan.</div>';
                    return;
                }

                let docs=[];
                snap.forEach(d=>docs.push({id:d.id,...d.data()}));
                docs.sort((a,b)=>(b.created_at?.seconds||0)-(a.created_at?.seconds||0));

                docs.forEach(d=>{
                    const time = d.created_at?.seconds
                    ? new Date(d.created_at.seconds*1000).toLocaleString()
                    : 'Baru saja';

                    const canDelete = state.profile.role==='admin' || d.guru_id===auth.currentUser.uid;

                    c.innerHTML+=`
                    <div class="bg-white p-5 rounded-2xl shadow-sm border mb-4">
                    <div class="flex justify-between mb-3">
                        <div>
                        <b>${d.guru_nama}</b>
                        <span class="text-xs text-slate-500">  ${d.kelas}</span>
                        <div class="text-[10px] text-slate-400">${time}</div>
                        </div>
                        ${canDelete?`<button onclick="window.app.deleteKegiatan('${d.id}')" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>`:''}
                    </div>
                    <p class="text-sm whitespace-pre-line">${d.text}</p>
                    ${d.link?`<a href="${d.link.startsWith('http')?d.link:'https://'+d.link}" target="_blank" class="text-blue-600 text-sm font-bold mt-2 inline-block">Buka Link</a>`:''}
                    ${d.foto?`<img src="${d.foto}" class="mt-3 rounded-xl" />`:''}
                    </div>`;
                });

                } catch(e){
                console.error(e);
                c.innerHTML='<div class="text-red-500 text-center">Gagal memuat kegiatan</div>';
                }
            };

                // === FIX: LOAD BERANDA SISWA (CLIENT-SIDE SORTING) ===
                    window.app.loadStudentHome = async () => {
            // 1. Set Header Nama Siswa
            ui.el('stu-home-name').innerText = state.profile.nama; 
            ui.el('stu-home-class').innerText = state.profile.kelas || '-';
            if(window.app.checkMyViolations) window.app.checkMyViolations(); 
            
            // --- PART A: POIN KEAKTIFAN REALTIME & LEVEL ---
            try {
                const userRef = doc(db, 'data_pengguna', auth.currentUser.uid);
                const userSnap = await getDoc(userRef);
                const currentData = userSnap.exists() ? userSnap.data() : state.profile;
                const points = currentData.poin_keaktifan || 0;

                const ptEl = ui.el('stu-total-points');
                if(ptEl) ptEl.innerText = points;

                let level = "PEMULA";
                if(points >= 50) level = "JUNIOR";
                if(points >= 100) level = "SENIOR";
                if(points >= 250) level = "SEPUH";
                if(points >= 500) level = "LEGEND";

                const badgeEl = ui.el('stu-level-badge');
                if(badgeEl) badgeEl.innerText = level;
            } catch (e) { console.error("Gagal load poin realtime", e); }

            // --- PART B: RIWAYAT NILAI GABUNGAN ---
            const gradeContainer = ui.el('stu-grade-history');
            if(gradeContainer) {
                gradeContainer.innerHTML = '<div class="loader mx-auto"></div>';
                try {
                    const combinedGrades = [];
                    const myUid = auth.currentUser.uid;
                    const myClass = state.profile.kelas;

                    // 1. Ambil Nilai Ujian
                    const examSnap = await getDocs(query(collection(db, 'data_nilaiujian'), where('userId', '==', myUid)));
                    examSnap.forEach(d => {
                        const dt = d.data();
                        combinedGrades.push({
                            type: 'UJIAN',
                            title: dt.mapel,
                            sub: "Ujian CBT",
                            score: dt.nilai,
                            dateObj: dt.timestamp ? dt.timestamp.toDate() : new Date(),
                            dateStr: dt.timestamp ? dt.timestamp.toDate().toLocaleDateString() : '-'
                        });
                    });

                    // 2. Ambil Nilai Tugas
                    if(myClass) {
                        const taskSnap = await getDocs(query(collection(db, 'data_nilai_harian'), where('kelas', '==', myClass)));
                        taskSnap.forEach(d => {
                            const dt = d.data();
                            if(dt.detail_nilai && Array.isArray(dt.detail_nilai)) {
                                const myScore = dt.detail_nilai.find(x => x.uid === myUid);
                                if(myScore) {
                                    const finalScore = myScore.nilai_skala !== undefined ? myScore.nilai_skala : myScore.nilai;
                                    combinedGrades.push({
                                        type: 'TUGAS',
                                        title: dt.jenis_tugas,
                                        sub: dt.mapel,
                                        score: finalScore,
                                        dateObj: new Date(dt.tanggal),
                                        dateStr: new Date(dt.tanggal).toLocaleDateString()
                                    });
                                }
                            }
                        });
                    }

                    combinedGrades.sort((a,b) => b.dateObj - a.dateObj);
                    gradeContainer.innerHTML = '';
                    if(combinedGrades.length === 0) {
                        gradeContainer.innerHTML = '<p class="text-xs text-slate-400 text-center py-4">Belum ada riwayat nilai.</p>';
                    } else {
                        combinedGrades.forEach(g => {
                            const isExam = g.type === 'UJIAN';
                            const colorClass = isExam ? 'bg-purple-100 text-purple-600' : 'bg-blue-100 text-blue-600';
                            const iconClass = isExam ? 'fa-laptop-code' : 'fa-book-open';
                            const scoreColor = g.score < 75 ? 'text-red-500' : 'text-green-600';

                            gradeContainer.innerHTML += `
                            <div class="flex items-center justify-between p-3 border-b border-slate-50 last:border-0 hover:bg-slate-50 transition">
                                <div class="flex items-center gap-3">
                                    <div class="w-9 h-9 rounded-lg ${colorClass} flex items-center justify-center text-sm shadow-sm">
                                        <i class="fa-solid ${iconClass}"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-bold text-slate-700 leading-tight">${g.title}</p>
                                        <p class="text-[10px] text-slate-400 font-medium uppercase tracking-wide mt-0.5">${g.sub}  ${g.dateStr}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-extrabold ${scoreColor}">${g.score}</div>
                                </div>
                            </div>`;
                        });
                    }
                } catch(e) { console.error(e); gradeContainer.innerHTML = '<p class="text-xs text-red-400 text-center">Gagal memuat nilai.</p>'; }
            }
            
            // --- PART C: LOAD FEED (GABUNGAN DATA LAMA & BARU) ---
            const feedC = ui.el('student-feed-container'); 
            if(feedC) {
                feedC.innerHTML = '<div class="loader mx-auto"></div>';
                try {
                    const myKelas = state.profile.kelas;
                    let allPosts = [];

                    // 1. Fetch NEW posts (data_kegiatan_kelas)
                    // Gunakan where saja untuk menghindari error index, sort client-side
                    const qNew = query(collection(db, 'data_kegiatan_kelas'), where('kelas', '==', myKelas));
                    const snapNew = await getDocs(qNew);
                    snapNew.forEach(d => {
                        const dat = d.data();
                        allPosts.push({
                            id: d.id,
                            ...dat,
                            timestamp_seconds: dat.created_at ? dat.created_at.seconds : 0,
                            displayImage: dat.foto || ''
                        });
                    });

                    // 2. Fetch OLD posts (data_kegiatan_kelas)
                    const qOld = query(collection(db, 'data_kegiatan_kelas'), where('kelas', '==', myKelas));
                    const snapOld = await getDocs(qOld);
                    snapOld.forEach(d => {
                        const dat = d.data();
                        allPosts.push({
                            id: d.id,
                            ...dat,
                            timestamp_seconds: dat.timestamp ? dat.timestamp.seconds : 0,
                            displayImage: dat.image || dat.foto || ''
                        });
                    });

                    // 3. Sort Descending (Terbaru diatas)
                    allPosts.sort((a,b) => b.timestamp_seconds - a.timestamp_seconds);

                    // 4. Render
                    feedC.innerHTML = ''; 
                    
                    if(allPosts.length === 0) {
                        feedC.innerHTML = '<div class="text-center p-8 text-slate-400"><i class="fa-solid fa-ghost text-2xl mb-2"></i><br>Belum ada postingan guru.</div>';
                    } else {
                        allPosts.forEach(d => { 
                            const timeStr = d.timestamp_seconds ? new Date(d.timestamp_seconds*1000).toLocaleDateString() : '-';
                            
                            let linkHtml = '';
                            if(d.link) {
                                const validLink = d.link.startsWith('http') ? d.link : 'https://' + d.link;
                                linkHtml = `
                                <div class="mt-3">
                                   <a href="${validLink}" target="_blank" class="inline-flex items-center gap-2 bg-blue-50 text-blue-600 px-4 py-2 rounded-xl text-sm font-bold border border-blue-100 hover:bg-blue-600 hover:text-white transition group">
                                       <i class="fa-solid fa-link group-hover:animate-pulse"></i> Buka Tautan Materi / Tugas
                                       <i class="fa-solid fa-arrow-up-right-from-square text-xs ml-1"></i>
                                   </a>
                                </div>`;
                            }

                            feedC.innerHTML += `
                            <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm mb-4">
                                <div class="flex items-center gap-3 mb-3 pb-3 border-b border-slate-50">
                                    <div class="w-10 h-10 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center font-bold text-sm border border-brand-200">
                                        <i class="fa-solid fa-chalkboard-user"></i>
                                    </div>
                                    <div>
                                        <p class="text-xs font-bold text-slate-700">${d.guru_nama || 'Guru'}</p>
                                        <p class="text-[10px] text-slate-400 flex items-center gap-1">
                                            <i class="fa-solid fa-clock"></i> ${timeStr}
                                        </p>
                                    </div>
                                </div>
                                <div class="text-sm text-slate-700 mb-3 whitespace-pre-line leading-relaxed">${d.text}</div>
                                ${linkHtml}
                                ${d.displayImage ? `<div class="mt-3"><img src="${d.displayImage}" class="w-full rounded-lg border shadow-sm" onclick="Swal.fire({imageUrl:'${d.displayImage}', showConfirmButton:false})"></div>` : ''}
                            </div>`; 
                        });
                    }
                } catch(e) { console.error(e); feedC.innerHTML = '<p class="text-center text-red-400">Gagal memuat info.</p>'; }
            }

            // Load Leaderboard
            try {
                const lbC = ui.el('leaderboard-container');
                if(lbC) {
                    const nSnap = await getDocs(query(collection(db, 'data_nilaiujian'), where('kelas', '==', state.profile.kelas)));
                    const scores = {};
                    nSnap.forEach(d => { 
                        const n = d.data(); 
                        if(!scores[n.nama]) scores[n.nama] = {total:0, count:0}; 
                        scores[n.nama].total += n.nilai; 
                        scores[n.nama].count++; 
                    });
                    const rank = Object.entries(scores)
                        .map(([k,v]) => ({nama:k, avg:Math.round(v.total/v.count)}))
                        .sort((a,b)=>b.avg - a.avg)
                        .slice(0,3);
                    lbC.innerHTML = ''; 
                    if(rank.length === 0) lbC.innerHTML = '<p class="text-xs text-slate-400 text-center">Belum ada data nilai.</p>';
                    rank.forEach((r,i) => {
                        const colors = ['bg-yellow-100 text-yellow-700 border-yellow-200', 'bg-slate-100 text-slate-700 border-slate-200', 'bg-orange-100 text-orange-700 border-orange-200'];
                        const icons = ['fa-trophy', 'fa-medal', 'fa-award'];
                        lbC.innerHTML += `
                        <div class="flex justify-between items-center bg-white p-3 rounded-lg border border-slate-100 shadow-sm mb-2">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full ${colors[i]} flex items-center justify-center border font-bold text-xs">
                                    <i class="fa-solid ${icons[i]}"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-700 truncate w-32">${r.nama}</span>
                            </div>
                            <span class="text-sm font-extrabold text-brand-600">${r.avg}</span>
                        </div>`; 
                    });
                }
            } catch(e) { console.error("Leaderboard error:", e); }
        };

        window.app.analyzeSoal = async () => {
            if(!state.currentNilaiData || state.currentNilaiData.length === 0) return Swal.fire('Info', 'Mohon cari data nilai terlebih dahulu (klik tombol Cari) agar bisa dianalisis.', 'info');
            
            ui.loading(true);
            const stats = {};
            
            // Hitung statistik jawaban per soal
            state.currentNilaiData.forEach(d => {
                if(d.detail && Array.isArray(d.detail)) {
                    d.detail.forEach((ans, idx) => {
                        const no = idx+1;
                        if(!stats[no]) stats[no] = {correct:0, total:0};
                        stats[no].total++;
                        if(ans.correct) stats[no].correct++;
                    });
                }
            });
            
            const c = ui.el('analisis-container'); c.innerHTML = '';
            
            // Tampilkan progress bar
            Object.keys(stats).sort((a,b)=>a-b).forEach(k => {
                const s = stats[k]; 
                const p = s.total > 0 ? Math.round((s.correct/s.total)*100) : 0;
                const color = p > 70 ? 'bg-green-500' : (p > 40 ? 'bg-yellow-500' : 'bg-red-500');
                
                c.innerHTML += `
                <div class="flex items-center gap-3 p-3 bg-slate-50 rounded border">
                    <span class="font-bold w-8 text-center text-sm">${k}</span>
                    <div class="flex-1 h-3 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full ${color}" style="width:${p}%"></div>
                    </div>
                    <span class="text-xs font-bold w-12 text-right">${p}%</span>
                </div>`;
            });
            
            ui.show('modal-analisis'); 
            ui.loading(false);
        };
                    window.app.loadLegerData = async () => {
            const kelas = ui.el('leger-kelas').value;
            const mapel = ui.el('leger-mapel').value;
            const tb = ui.el('tbody-leger');
            const thead = ui.el('leger-head-row'); 

            if(!kelas || !mapel) return Swal.fire('Filter', 'Pilih Kelas dan Mapel', 'warning');
            
            ui.loading(true, "Menyusun Leger...");
            tb.innerHTML = '';

            try {
                // 1. SIAPKAN STRUKTUR DATA
                const students = {}; // Map UID -> {nama, tugas:{}, ujian:{}}
                
                // Ambil Siswa
                const qUser = query(collection(db, 'data_pengguna'), where('kelas', '==', kelas));
                const snapUser = await getDocs(qUser);
                snapUser.forEach(d => {
                    const u = d.data();
                    if((u.role||'').toLowerCase() === 'siswa') {
                        students[d.id] = { nama: u.nama, tugas: {}, ujian: {} };
                    }
                });

                // 2. AMBIL DATA TUGAS HARIAN
                const tugasList = new Set(); 
                const qTugas = query(collection(db, 'data_nilai_harian'), where('kelas', '==', kelas), where('mapel', '==', mapel));
                const snapTugas = await getDocs(qTugas);
                
                snapTugas.forEach(d => {
                    const t = d.data();
                    const judulTugas = t.jenis_tugas; 
                    tugasList.add(judulTugas);

                    if(t.detail_nilai) {
                        t.detail_nilai.forEach(dn => {
                            if(students[dn.uid]) {
                                // Prioritaskan nilai_skala (0-100), fallback ke nilai asli
                                const val = dn.nilai_skala !== undefined ? dn.nilai_skala : dn.nilai;
                                students[dn.uid].tugas[judulTugas] = val;
                            }
                        });
                    }
                });

                // 3. AMBIL DATA UJIAN CBT
                const ujianList = []; 
                const qUjian = query(collection(db, 'data_nilaiujian'), where('kelas', '==', kelas), where('mapel', '==', mapel));
                const snapUjian = await getDocs(qUjian);
                
                snapUjian.forEach(d => {
                    const u = d.data();
                    const token = u.token || 'Unknown';
                    if(!ujianList.includes(token)) ujianList.push(token);
                    if(students[u.userId]) {
                        students[u.userId].ujian[token] = u.nilai;
                    }
                });

                // Sortir Header Kolom
                const arrTugas = Array.from(tugasList).sort();
                const arrUjian = ujianList.sort();

                // 4. DEFINISIKAN studentArray (FIXED: Didefinisikan DI SINI)
                const studentArray = Object.values(students).sort((a,b) => a.nama.localeCompare(b.nama));

                // 5. SIMPAN KE STATE UNTUK EXPORT & RENDER (FIXED: Pakai studentArray yang SUDAH didefinisikan)
                state.currentLegerColumns = { tugas: arrTugas, ujian: arrUjian };
                state.currentLegerData = studentArray.map(s => {
                    const row = { Nama: s.nama };
                    
                    // Hitung Rata-rata Tugas
                    let sumT = 0, cntT = 0;
                    arrTugas.forEach(t => { 
                        const val = s.tugas[t];
                        row[`Tugas_${t}`] = val !== undefined ? val : 0;
                        if(val !== undefined) { sumT += val; cntT++; }
                    });
                    
                    // Hitung Rata-rata Ujian
                    let sumU = 0, cntU = 0;
                    arrUjian.forEach(u => { 
                        const val = s.ujian[u];
                        row[`Ujian_${u}`] = val !== undefined ? val : 0; 
                        if(val !== undefined) { sumU += val; cntU++; }
                    });
                    
                    const avgTugas = cntT ? Math.round(sumT/cntT) : 0;
                    const avgUjian = cntU ? Math.round(sumU/cntU) : 0;
                    
                    // Logic Nilai Akhir (60:40)
                    let na = 0;
                    if(cntT > 0 && cntU > 0) na = Math.round((avgTugas * 0.6) + (avgUjian * 0.4));
                    else if (cntT > 0) na = Math.round(avgTugas);
                    else if (cntU > 0) na = Math.round(avgUjian);
                    
                    row['Rata_Tugas'] = avgTugas;
                    row['Rata_Ujian'] = avgUjian;
                    row['Nilai_Akhir'] = na;
                    
                    return row;
                });

                // 6. RENDER HEADER TABEL DINAMIS
                if(thead) {
                    let headerHTML = `
                        <th class="p-3 border border-slate-200 text-center w-10">No</th>
                        <th class="p-3 border border-slate-200 text-left w-64 sticky left-0 bg-slate-50">Nama Siswa</th>
                    `;
                    arrTugas.forEach(t => { headerHTML += `<th class="p-3 border text-center bg-blue-50 text-blue-700 text-xs">${t}</th>`; });
                    arrUjian.forEach(u => { headerHTML += `<th class="p-3 border text-center bg-purple-50 text-purple-700 text-xs">${u}</th>`; });
                    headerHTML += `<th class="p-3 border text-center bg-green-100 text-green-800">Nilai Rapor</th>`;
                    thead.innerHTML = headerHTML;
                }

                // 7. RENDER BODY TABEL (Looping state.currentLegerData yang sudah dihitung)
                if (state.currentLegerData.length === 0) {
                    tb.innerHTML = '<tr><td colspan="100%" class="p-6 text-center">Tidak ada siswa.</td></tr>';
                } else {
                    state.currentLegerData.forEach((row, i) => {
                        let rowHTML = `
                        <tr class="hover:bg-slate-50 border-b border-slate-100">
                            <td class="p-3 text-center border-r">${i+1}</td>
                            <td class="p-3 font-bold text-slate-700 border-r sticky left-0 bg-white">${row.Nama}</td>
                        `;

                        // Isi Kolom Tugas
                        arrTugas.forEach(t => {
                            const val = row[`Tugas_${t}`];
                            const display = val !== 0 ? val : '-'; // Tampilkan '-' jika 0 atau undefined (opsional)
                            rowHTML += `<td class="p-3 text-center border-r text-slate-600">${display}</td>`;
                        });

                        // Isi Kolom Ujian
                        arrUjian.forEach(u => {
                            const val = row[`Ujian_${u}`];
                            const display = val !== 0 ? val : '-';
                            rowHTML += `<td class="p-3 text-center border-r text-slate-600">${display}</td>`;
                        });

                        // Nilai Akhir
                        const na = row['Nilai_Akhir'];
                        rowHTML += `<td class="p-3 text-center font-bold text-lg ${na < 75 ? 'text-red-600':'text-green-600'} bg-slate-50">${na}</td></tr>`;
                        
                        tb.innerHTML += rowHTML;
                    });
                }

            } catch(e) { console.error(e); Swal.fire('Error', e.message, 'error'); }
            ui.loading(false);
        };
                window.app.exportLeger = () => {
            if (!state.currentLegerData || state.currentLegerData.length === 0) {
                return Swal.fire('Data Kosong', 'Silakan tampilkan leger terlebih dahulu.', 'warning');
            }

            const ws = XLSX.utils.json_to_sheet(state.currentLegerData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Leger Nilai");
            
            const kelas = ui.el('leger-kelas').value;
            const mapel = ui.el('leger-mapel').value;
            XLSX.writeFile(wb, `Leger_${kelas}_${mapel}.xlsx`);
        };

        // === FUNGSI TAMBAHAN UNTUK BENAR/SALAH DINAMIS (UPDATED WITH TOOLS) ===
        window.app.addBSRow = (text = '', ans = 'BENAR', img = '') => {
            const container = document.getElementById('bs-items-container');
            const id = Date.now() + Math.floor(Math.random() * 1000);
            const row = document.createElement('div');
            row.className = 'bs-row bg-white p-4 rounded-xl border border-slate-200 shadow-sm mb-3'; 
            
            row.innerHTML = `
                <div class="flex flex-col gap-3">
                    <div class="flex items-start gap-2">
                        <!-- Text Input Area -->
                        <div class="flex-1 group">
                            <div class="flex gap-2 mb-2">
                                <input type="text" id="bs-text-${id}" class="bs-text w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none text-sm transition" placeholder="Tulis pernyataan (bisa pakai LaTeX)..." value="${text.replace(/"/g, '&quot;')}" oninput="window.app.refreshPreview('bs-text-${id}', 'prev-bs-${id}')">
                                
                                <!-- Tools Buttons -->
                                <div class="flex gap-1">
                                    <button type="button" onclick="window.app.openMathModal('bs-text-${id}')" class="p-2.5 bg-slate-50 border border-slate-200 rounded-lg hover:bg-brand-50 hover:text-brand-600 hover:border-brand-200 transition" title="Sisipkan Rumus">
                                        <i class="fa-solid fa-calculator"></i>
                                    </button>
                                    <button type="button" onclick="window.app.triggerImageUpload('bs-img-${id}')" class="p-2.5 bg-slate-50 border border-slate-200 rounded-lg hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 transition" title="Upload Gambar">
                                        <i class="fa-solid fa-image"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <input type="hidden" id="bs-img-${id}" class="bs-img" value="${img}" onchange="window.app.refreshPreview('bs-text-${id}', 'prev-bs-${id}')">
                            
                            <!-- Live Preview Box -->
                            <div id="prev-bs-${id}" class="text-sm text-slate-800 min-h-[40px] p-3 bg-slate-50 border border-slate-100 rounded-lg prose max-w-none">
                                <span class="text-slate-400 italic text-xs">Pratinjau pernyataan akan muncul di sini...</span>
                            </div>
                        </div>

                        <!-- Delete Button -->
                        <button type="button" onclick="this.closest('.bs-row').remove()" class="text-slate-400 hover:text-red-500 p-2 transition self-start mt-2" title="Hapus Baris">
                            <i class="fa-solid fa-trash-can text-lg"></i>
                        </button>
                    </div>

                    <!-- Answer Key Selection -->
                    <div class="flex items-center gap-4 pt-2 border-t border-slate-100 mt-1">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Kunci Jawaban:</span>
                        <div class="flex gap-4">
                            <label class="flex items-center cursor-pointer group/radio">
                                <div class="relative flex items-center justify-center w-5 h-5 mr-2">
                                    <input type="radio" name="ans-${id}" value="BENAR" class="peer appearance-none w-5 h-5 border-2 border-slate-300 rounded-full checked:border-green-500 checked:bg-green-50 transition" ${ans === 'BENAR' ? 'checked' : ''}>
                                    <div class="absolute w-2.5 h-2.5 bg-green-500 rounded-full scale-0 peer-checked:scale-100 transition"></div>
                                </div>
                                <span class="text-sm font-bold text-slate-600 group-hover/radio:text-green-600 transition">Benar</span>
                            </label>
                            <label class="flex items-center cursor-pointer group/radio">
                                <div class="relative flex items-center justify-center w-5 h-5 mr-2">
                                    <input type="radio" name="ans-${id}" value="SALAH" class="peer appearance-none w-5 h-5 border-2 border-slate-300 rounded-full checked:border-red-500 checked:bg-red-50 transition" ${ans === 'SALAH' ? 'checked' : ''}>
                                    <div class="absolute w-2.5 h-2.5 bg-red-500 rounded-full scale-0 peer-checked:scale-100 transition"></div>
                                </div>
                                <span class="text-sm font-bold text-slate-600 group-hover/radio:text-red-600 transition">Salah</span>
                            </label>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(row);
            setTimeout(() => { window.app.refreshPreview(`bs-text-${id}`, `prev-bs-${id}`); }, 50);
        };

        window.app.generateClassOptions = (all=false) => {
            let html = all ? '<option value="">Semua Kelas</option>' : '<option value="" disabled selected>Pilih Kelas</option>';
            ['X','XI','XII'].forEach(j=>{ html += `<optgroup label="Kelas ${j}">`; for(let i=1; i<=11; i++) html += `<option value="${j}-${i}">${j}-${i}</option>`; html += `</optgroup>`; });
            return html;
        };

        window.app.closeModal = (id) => ui.hide(id);
        window.app.logout = () => Swal.fire({title:'Keluar?',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'}).then(r=>{if(r.isConfirmed)signOut(auth).then(()=>location.reload())});

        // === NAVIGASI MENU (UPDATED & FIXED) ===
        window.app.nav = async (page) => {
                  const sidebar = document.querySelector('aside');
            if (sidebar && sidebar.classList.contains('fixed')) {
                window.app.toggleSidebar();
            }
            ui.resetPages(); 
            
            // 1. Logika Tampilan Login/Portal vs Dashboard
            if(page === 'view-login' || page === 'view-exam') {
                document.getElementById('layout-dashboard').classList.add('hidden-section');
                ui.show(page);
            } else {
                ui.show('layout-dashboard'); 
                ui.show(page); 
            }
            if(page === 'page-atur-jadwal') {
                document.getElementById('jadwal-kelas').innerHTML = window.app.generateClassOptions(false);
                // Reset grid
                ui.el('tbody-jadwal').innerHTML = '<tr><td colspan="4" class="p-10 text-center text-slate-400">Silakan pilih kelas.</td></tr>';
            }
            
            // --- LOGIKA INIT PER HALAMAN ---

            // Halaman Users
            if(page === 'page-users') {
                 document.getElementById('filter-user-kelas').innerHTML = window.app.generateClassOptions(true);
            }
            // Tambahkan di dalam window.app.nav, setelah if(page === 'page-users')...
            if(page === 'page-piket') {
                const pk = ui.el('piket-kelas');
                if(pk) pk.innerHTML = window.app.generateClassOptions(false);
                
                // Tambahan: Isi juga dropdown filter di bagian Rekap
                const fk = ui.el('filter-piket-kelas');
                if(fk) fk.innerHTML = window.app.generateClassOptions(true); // true = ada opsi "Semua Kelas"
                
                // Set default tanggal hari ini di filter
                const today = new Date().toISOString().split('T')[0];
                if(ui.el('filter-piket-start')) ui.el('filter-piket-start').value = today;
                if(ui.el('filter-piket-end')) ui.el('filter-piket-end').value = today;

                window.app.loadHistoryPiket();
            }
            
            // Halaman Nilai
            if(page === 'page-nilai') {
                 document.getElementById('filter-nilai-kelas').innerHTML = window.app.generateClassOptions(true);
                 window.app.loadSesiForFilter();
            }
            
            // Halaman Lainnya (Simple Load)
            if(page === 'page-bank-soal') window.app.loadSoalFilters(); 
            if(page === 'page-sesi-ujian') window.app.loadSesi(); 
            if(page === 'page-kelas') window.app.loadMasterKelas(); 
            if(page === 'page-dashboard') window.app.loadStats();
                if(state.profile.role === 'guru') {
                    window.app.loadJadwalGuruHariIni();
                }
            
            // Halaman Kegiatan Kelas (FIX DUPLIKAT & TAMBAH FILTER)
            if(page === 'page-kegiatan') { 
                // Isi Dropdown Posting
                const postingKelas = document.getElementById('kegiatan-kelas');
                if(postingKelas) postingKelas.innerHTML = window.app.generateClassOptions(true); 
                
                // Isi Dropdown Filter Timeline (YANG BARU)
                const filterFeed = document.getElementById('filter-feed-guru');
                if(filterFeed) filterFeed.innerHTML = window.app.generateClassOptions(true);
                
                // Load Data
                window.app.loadKegiatanGuru(); 
            }

            // Fungsi Helper untuk Dropdown Presensi, Rekap, Agenda
            const initSelects = (prefix) => {
                 const elKelas = document.getElementById(`${prefix}-kelas`);
                 const elMapel = document.getElementById(`${prefix}-mapel`);
                 if(elKelas && elMapel) {
                     elKelas.innerHTML = window.app.generateClassOptions(false);
                     elMapel.innerHTML = '<option value="">-- Pilih Mapel --</option>';
                     STANDARD_MAPEL_LIST.forEach(m => elMapel.innerHTML += `<option value="${m}">${m}</option>`);
                 }
            };

            // Halaman Presensi
            if(page === 'page-presensi') {
                initSelects('presensi');
                ui.el('presensi-tgl').valueAsDate = new Date();
                ui.el('tbody-presensi').innerHTML = '<tr><td colspan="4" class="p-10 text-center text-slate-400">Pilih Tanggal, Kelas, Mapel, lalu klik tombol Buka.</td></tr>';
                ui.el('wrap-btn-simpan-presensi').classList.add('hidden');
            }
            
            // Halaman Rekap Absensi
            if(page === 'page-rekap-absensi') {
                initSelects('rekap-absen');
                ui.el('tbody-rekap-absen').innerHTML = '<tr><td colspan="7" class="p-10 text-center text-slate-400">Pilih Kelas dan Mapel untuk melihat data.</td></tr>';
            }
            
            // Halaman Agenda/Jurnal
            if(page === 'page-agenda') {
                document.getElementById('filter-agenda-kelas').innerHTML = window.app.generateClassOptions(true);
                // Dont load automatically to prevent heavy load
            }

            // Halaman Nilai Harian (NEW)
            if(page === 'page-nilai-harian') {
                const elNhKelas = document.getElementById('nh-kelas');
                if(elNhKelas) elNhKelas.innerHTML = window.app.generateClassOptions(false);
                
                const elNhActKelas = document.getElementById('nh-activity-kelas');
                if(elNhActKelas) elNhActKelas.innerHTML = window.app.generateClassOptions(false);
                
                const elMapel = document.getElementById('nh-mapel');
                if(elMapel) {
                    elMapel.innerHTML = '<option value="">-- Pilih Mapel --</option>';
                    STANDARD_MAPEL_LIST.forEach(m => elMapel.innerHTML += `<option value="${m}">${m}</option>`);
                }
                
                if(ui.el('nh-tgl')) ui.el('nh-tgl').valueAsDate = new Date();
                window.app.switchNilaiHarianTab('input'); // Default tab
            }

            // Halaman Leger (NEW)
            if(page === 'page-leger') {
                const elLegerKelas = document.getElementById('leger-kelas');
                if(elLegerKelas) elLegerKelas.innerHTML = window.app.generateClassOptions(false);
                
                const elLegerMapel = document.getElementById('leger-mapel');
                if(elLegerMapel) {
                    elLegerMapel.innerHTML = '<option value="">-- Pilih Mapel --</option>';
                    STANDARD_MAPEL_LIST.forEach(m => elLegerMapel.innerHTML += `<option value="${m}">${m}</option>`);
                }
            }
        };
        window.app.loadStats = async () => {
            try {
                const usersSnap = await getDocs(collection(db, 'data_pengguna'));
                ui.el('stat-users').innerText = usersSnap.size;
                const soalSnap = await getDocs(collection(db, 'data_soalujian'));
                ui.el('stat-soal').innerText = soalSnap.size;
                const ujianSnap = await getDocs(query(collection(db, 'data_sesiujian'), where('status', '==', 'aktif')));
                ui.el('stat-ujian').innerText = ujianSnap.size;
                
                // FIXED: Hitung rata-rata nilai SESUAI PERIODE AKTIF
                // Biar Dashboard angkanya valid sesuai tahun ajaran
                const nilaiSnap = await getDocs(collection(db, 'data_nilaiujian'));
                let total = 0; 
                let count = 0;
                
                nilaiSnap.forEach(d => { 
                    const dt = d.data();
                    // Filter Periode
                    const isCurrent = (dt.tahun_ajaran === state.schoolConfig.tahun && dt.semester === state.schoolConfig.semester);
                    const isLegacy = !dt.tahun_ajaran;
                    
                    if(isCurrent || isLegacy) {
                        total += dt.nilai;
                        count++;
                    }
                });
                
                const avg = count ? Math.round(total / count) : 0;
                ui.el('stat-nilai').innerText = avg;
            } catch (e) { console.error("Stats Error:", e); }
        }

        window.app.triggerImageUpload = (targetId) => { state.pendingUploadTarget = targetId; document.getElementById('global-file-input').click(); };
        
        window.app.handleFileUpload = (input) => {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const target = document.getElementById(state.pendingUploadTarget);
                    if(target) {
                        target.value = e.target.result;
                        target.dispatchEvent(new Event('input'));
                        const targetId = state.pendingUploadTarget;
                        if(targetId === 'inp-img-url') {
                             window.app.refreshPreview('inp-tanya', 'preview-tanya');
                        } else {
                             const parts = targetId.split('-');
                             if (parts.length >= 3) {
                                 const prefix = parts[0]; 
                                 const id = parts[2];
                                 window.app.refreshPreview(`${prefix}-text-${id}`, `prev-${prefix}-${id}`);
                             }
                        }
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
            input.value = '';
        };

        window.app.openModalSoal = () => { ui.el('form-soal').reset(); ui.el('soal-id').value=''; ui.show('modal-soal'); window.app.renderOptionInputs(); };
        
        window.app.openModalSoalEdit = async (id) => {
            ui.loading(true); const d = (await getDoc(doc(db,'data_soalujian',id))).data();
            ui.el('soal-id').value=id; ui.el('inp-mapel').value=d.mapel; ui.el('inp-materi').value=d.materi; ui.el('inp-kelas').value=d.kelas;
            ui.el('inp-jenis').value=d.jenis_soal; ui.el('inp-taksonomi').value=d.taksonomi; ui.el('inp-tanya').value=d.pertanyaan; ui.el('inp-img-url').value=d.gambar||'';
            window.app.renderOptionInputs(); 
            if (d.jenis_soal === 'BENAR_SALAH') {
                const container = document.getElementById('bs-items-container');
                if (container) container.innerHTML = ''; 
                if (d.pilihanJawaban && Array.isArray(d.pilihanJawaban)) {
                     d.pilihanJawaban.forEach(item => {
                        window.app.addBSRow(item.teksOpsi, item.kunci, item.gambar || ''); 
                     });
                } else {
                    window.app.addBSRow();
                }
            }
            else if(d.jenis_soal !== 'ESSAY'){ 
                const k=document.querySelectorAll('.key-selector'), t=document.querySelectorAll('.opt-text'), img=document.querySelectorAll('.opt-img'); 
                d.opsi.forEach((o,i)=>{ 
                    if(t[i])t[i].value=o.text; 
                    if(img[i])img[i].value=o.img||''; 
                    if(d.kunci.includes(o.label) && k[i])k[i].checked=true; 
                }); 
            }
            window.app.refreshPreview('inp-tanya', 'preview-tanya'); ui.show('modal-soal'); ui.loading(false);
        };

        window.app.saveSoal = async () => {
            ui.loading(true); const id=ui.el('soal-id').value, typ=ui.el('inp-jenis').value;
            const dt = {mapel:ui.el('inp-mapel').value, materi:ui.el('inp-materi').value, kelas:ui.el('inp-kelas').value, jenis_soal:typ, taksonomi:ui.el('inp-taksonomi').value, pertanyaan:ui.el('inp-tanya').value, gambar:ui.el('inp-img-url').value, timestamp:serverTimestamp()};
            
            if(typ === 'BENAR_SALAH') {
                const rows = document.querySelectorAll('.bs-row');
                const opsi = [];
                rows.forEach((row, idx) => {
                    const textInput = row.querySelector('.bs-text');
                    const imgInput = row.querySelector('.bs-img');
                    const checkedRadio = row.querySelector('input[type="radio"]:checked');
                    if(textInput && checkedRadio) {
                         const text = textInput.value;
                         const img = imgInput ? imgInput.value : '';
                         const ans = checkedRadio.value;
                         if(text.trim() || img) { 
                             opsi.push({ opsiId: (idx + 1).toString(), teksOpsi: text, gambar: img, kunci: ans });
                         }
                    }
                });
                if(opsi.length === 0) { ui.loading(false); return Swal.fire('Error', 'Minimal isi satu pernyataan', 'warning'); }
                dt.pilihanJawaban = opsi;
                dt.kunci = opsi.map(o => o.kunci); 
            }
            else if(typ !== 'ESSAY'){ 
                const k=[], o=[]; 
                document.querySelectorAll('.key-selector').forEach((e,i)=>{ 
                    if(e.checked)k.push(e.value); 
                    const txt=document.querySelectorAll('.opt-text')[i]?.value||''; 
                    const img=document.querySelectorAll('.opt-img')[i]?.value||''; 
                    o.push({label:e.value,text:txt,img:img}); 
                }); 
                dt.kunci=k; dt.opsi=o; 
                if(!k.length){ui.loading(false);return Swal.fire('Error','Pilih Kunci','warning');} 
            }
            
            if(id) await updateDoc(doc(db,'data_soalujian',id),dt); else await addDoc(collection(db,'data_soalujian'),dt);
            window.app.closeModal('modal-soal'); window.app.loadSoal(); ui.toast('Tersimpan'); ui.loading(false);
        };

        window.app.deleteSoal = async (id) => { if((await Swal.fire({title:'Hapus?',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'})).isConfirmed){ await deleteDoc(doc(db,'data_soalujian',id)); window.app.loadSoal(); } };
        
        // === LOAD SOAL FILTERS (LIGHTWEIGHT) ===
        window.app.loadSoalFilters = async () => {
             try {
                 const s = await getDocs(collection(db,'data_soalujian'));
                 const mapels = new Set();
                 const materis = new Set();
                 s.forEach(d => { const data = d.data(); if(data.mapel) mapels.add(data.mapel); if(data.materi) materis.add(data.materi); });
                 const selMapel = ui.el('filter-soal-mapel');
                 const selMateri = ui.el('filter-soal-materi');
                 selMapel.innerHTML = '<option value="">-- Pilih Mapel --</option>';
                 selMateri.innerHTML = '<option value="">-- Pilih Materi --</option>';
                 Array.from(mapels).sort().forEach(m => selMapel.innerHTML += `<option value="${m}">${m}</option>`);
                 Array.from(materis).sort().forEach(m => selMateri.innerHTML += `<option value="${m}">${m}</option>`);
             } catch(e) { console.error(e); }
        };

        // === UPDATED: MANUAL TRIGGER LOAD SOAL ===
        window.app.loadSoal = async () => {
            const fMapel = ui.el('filter-soal-mapel').value;
            const fMateri = ui.el('filter-soal-materi').value;
            const fKelas = ui.el('filter-soal-kelas').value;

            ui.loading(true, "Mencari data soal...");
            const l=ui.el('list-soal-container'); 
            
            let q = query(collection(db,'data_soalujian'), orderBy('timestamp','desc'));
            if(fMapel) q = query(collection(db,'data_soalujian'), where('mapel', '==', fMapel)); 

            const s = await getDocs(q); 
            l.innerHTML='';
            let count = 0;

            s.forEach(d => {
                const dt = d.data();
                if(fMapel && dt.mapel !== fMapel) return;
                if(fMateri && dt.materi !== fMateri) return;
                if(fKelas && dt.kelas !== fKelas) return;

                count++;
                l.innerHTML+=`<div class="bg-white p-5 rounded-xl border shadow-sm flex justify-between hover:shadow-md transition"><div><h4 class="font-bold text-brand-700 text-lg">${dt.mapel}</h4><span class="text-xs bg-slate-100 px-2 py-1 rounded font-bold">${dt.jenis_soal}</span> <span class="text-slate-400 text-sm ml-2">${dt.materi}</span><p class="text-sm text-slate-600 mt-2 truncate w-96">${dt.pertanyaan}</p></div><div class="flex gap-2"><button onclick="window.app.openModalSoalEdit('${d.id}')" class="bg-blue-50 text-blue-600 p-3 rounded-lg hover:bg-blue-100"><i class="fa-solid fa-pen-to-square"></i></button><button onclick="window.app.deleteSoal('${d.id}')" class="bg-red-50 text-red-600 p-3 rounded-lg hover:bg-red-100"><i class="fa-solid fa-trash-can"></i></button></div></div>`; 
            });

            if(count === 0) l.innerHTML='<div class="text-center p-4 text-slate-400">Tidak ada soal ditemukan dengan filter ini.</div>';
            ui.loading(false);
        };

        window.app.renderOptionInputs = () => {
            const t=ui.el('inp-jenis').value, c=ui.el('container-options'); c.innerHTML=''; 
            if(t==='ESSAY') return;
            if(t==='BENAR_SALAH') {
                c.innerHTML = `<div class="md:col-span-2"><label class="block text-sm font-bold text-slate-500 uppercase mb-2">Daftar Pernyataan & Kunci Jawaban</label><div id="bs-items-container" class="space-y-3"></div><button type="button" onclick="window.app.addBSRow()" class="mt-3 text-sm text-brand-600 font-bold hover:text-brand-800 flex items-center p-2 border border-dashed border-brand-300 rounded-lg hover:bg-brand-50 w-full justify-center transition"><i class="fa-solid fa-plus mr-2"></i> Tambah Pernyataan</button></div>`;
                setTimeout(() => window.app.addBSRow(), 0);
                return;
            }
            ['A','B','C','D','E'].forEach((l, idx)=>{ const iId=`opt-text-${idx}`, mId=`opt-img-${idx}`, pId=`prev-opt-${idx}`; c.innerHTML+=`<div class="flex flex-col gap-2 mb-4 bg-slate-50 p-3 rounded-lg border border-slate-200"><div class="flex items-center gap-3"><b class="w-8 text-center text-slate-500 text-lg">${l}</b><input type="${t==='PG'?'radio':'checkbox'}" name="k" value="${l}" class="key-selector w-6 h-6 accent-brand-600 cursor-pointer"><div class="flex-1 flex gap-2"><input id="${iId}" class="w-full border p-2 rounded-lg text-sm opt-text focus:ring-2 focus:ring-brand-500 outline-none" placeholder="Jawaban ${l}..." oninput="window.app.refreshPreview('${iId}','${pId}')"><button type="button" onclick="window.app.openMathModal('${iId}')" class="tool-btn"><i class="fa-solid fa-calculator"></i></button><button type="button" onclick="window.app.triggerImageUpload('${mId}')" class="tool-btn"><i class="fa-solid fa-image"></i></button></div></div><input type="hidden" id="${mId}" class="opt-img" onchange="window.app.refreshPreview('${iId}','${pId}')"><div id="${pId}" class="ml-11 p-2 text-sm text-slate-600 min-h-[20px]"></div></div>`; });
        };

        window.app.openMathModal = (tid) => { state.activeInputId = tid; ui.show('modal-math'); };
        window.app.insertMath = (l) => { if(state.activeInputId){ const el=document.getElementById(state.activeInputId); el.value+=l; el.focus(); if(state.activeInputId==='inp-tanya')window.app.refreshPreview('inp-tanya','preview-tanya'); else {const idx=state.activeInputId.split('-')[2]; window.app.refreshPreview(state.activeInputId,`prev-${state.activeInputId.split('-')[0]}-${idx}`);} } };
        window.app.refreshPreview = (sId, pId) => { 
            const txtEl = document.getElementById(sId);
            if(!txtEl) return;
            const txt = txtEl.value;
            let h = txt ? txt.replace(/\n/g,'<br>') : ''; 
            const p = document.getElementById(pId); 
            if(sId==='inp-tanya'){
                const img=ui.el('inp-img-url').value; 
                if(img) h = `<img src="${img}" class="max-h-40 rounded mb-2 block border">` + h;
            } else {
                const parts = sId.split('-'); 
                if (parts.length >= 3) {
                    const prefix = parts[0]; 
                    const id = parts[2];
                    const imgInput = document.getElementById(`${prefix}-img-${id}`);
                    if(imgInput && imgInput.value) { h = `<img src="${imgInput.value}" class="max-h-24 rounded mb-2 block border">` + h; }
                }
            } 
            if(p){ p.innerHTML=h; MathJax.typesetPromise([p]); } 
        };

                // === UPDATED USER LOADING (MANUAL) ===
                window.app.loadUsers = async () => {
            const fJ = ui.el('filter-user-jenjang').value; 
            const fK = ui.el('filter-user-kelas').value; 
            const tb = ui.el('tbody-users'); 
            
            ui.loading(true, "Mengambil data user...");
            state.selectedUsers = [];
            
            let q;

            // Query Firestore TANPA orderBy (aman)
            if (fK) {
                q = query(collection(db, 'data_pengguna'), where('kelas', '==', fK));
            } else {
                q = collection(db, 'data_pengguna');
            }

            const s = await getDocs(q);
            tb.innerHTML = '';

            if (s.empty) {
                tb.innerHTML = `<tr><td colspan="7" class="p-6 text-center text-slate-400">
                    Tidak ditemukan user.
                </td></tr>`;
                ui.loading(false);
                return;
            }

            // === SORTING MANUAL (AMAN 100% tanpa index) ===
            let arr = [];
            s.forEach(d => {
                const dt = d.data();
                if (fJ && dt.kelas && !dt.kelas.startsWith(fJ)) return;
                arr.push({ id: d.id, ...dt });
            });

            arr.sort((a, b) => a.nama.localeCompare(b.nama, 'id')); // SORT ABJAD

            // === RENDER TABEL ===
            arr.forEach(dt => {
                tb.innerHTML += `
                    <tr class="border-b hover:bg-slate-50 transition">
                        <td class="p-4 text-center">
                            <input type="checkbox" value="${dt.id}" onchange="window.app.togUs(this)">
                        </td>
                        <td class="p-4 font-bold text-slate-700">${dt.nama}</td>
                        <td class="p-4 text-slate-500">${dt.email}</td>
                        <td class="p-4"><span class="bg-brand-50 text-brand-700 px-2 py-1 rounded text-xs font-bold uppercase">${dt.role}</span></td>
                        <td class="p-4 font-mono text-sm">${dt.kelas || '-'}</td>
                        <td class="p-4 text-right flex justify-end gap-3">
                            <button onclick="window.app.viewUserDetail('${dt.id}')" class="text-green-600 font-bold text-xs hover:underline">DETAIL</button>
                            <button onclick="window.app.openModalUser('${dt.id}')" class="text-blue-600 font-bold text-xs hover:underline">EDIT</button>
                        </td>
                    </tr>`;
            });

            ui.loading(false);
        };
        window.app.togUs=(e)=>{ if(e.checked)state.selectedUsers.push(e.value); else state.selectedUsers=state.selectedUsers.filter(x=>x!==e.value); };
        window.app.toggleSelectAll=(e)=>{ document.querySelectorAll('#tbody-users input').forEach(c=>{c.checked=e.checked; window.app.togUs(c);}); };
        window.app.openModalUser = async (id) => { 
            ui.el('form-user').reset(); ui.el('user-edit-id').value=id||''; 
            document.getElementById('user-kelas').innerHTML = window.app.generateClassOptions(false);
            if(id){
            const d = (await getDoc(doc(db,'data_pengguna',id))).data();
            ui.el('user-nama').value = d.nama;
            ui.el('user-email').value = d.email;
            ui.el('user-role').value = d.role;
            ui.el('user-kelas').value = d.kelas;
            ui.el('user-nip').value = d.nip || "";
            ui.el('user-mapel').value = d.mapel || "";
            }
            ui.show('modal-user'); 
        };
            window.app.deleteBulkUsers = async () => { if(!state.selectedUsers.length)return Swal.fire('Pilih user','','info'); if((await Swal.fire({title:`Hapus ${state.selectedUsers.length}?`,icon:'warning',showCancelButton:true})).isConfirmed){ for(const i of state.selectedUsers)await deleteDoc(doc(db,'data_pengguna',i)); window.app.loadUsers(); } };
            if(ui.el('form-user')) 
        ui.el('form-user').onsubmit = async (e) => {
            e.preventDefault();
            ui.loading(true);
            const id = ui.el('user-edit-id').value;
            const dt = {
                nama: ui.el('user-nama').value,
                email: ui.el('user-email').value,
                role: ui.el('user-role').value,
                kelas: ui.el('user-kelas').value,
                nip: ui.el('user-nip').value || "",
                mapel: ui.el('user-mapel').value || ""
            };
            try {
                if (id) { await updateDoc(doc(db, 'data_pengguna', id), dt);
                } else {
                    const p = ui.el('user-pass').value;
                    if (!p) throw 'Pass required';
                    await addDoc(collection(db, "data_pengguna"), { ...dt, password: p, status: "pending_auth", timestamp: serverTimestamp() });
                }
                window.app.closeModal('modal-user');
                window.app.loadUsers();
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
            ui.loading(false);
        };
       
        window.app.openModalImport = () => { ui.show('modal-import'); ui.el('file-import-csv').value = ''; ui.el('import-filename').classList.add('hidden'); };
        window.app.handleImportFileSelect = (input) => { const label = ui.el('import-filename'); if(input.files && input.files[0]) { label.innerText = `File terpilih: ${input.files[0].name}`; label.classList.remove('hidden'); } else { label.classList.add('hidden'); } };

        window.app.processImport = async () => {
            const fileInput = ui.el('file-import-csv');
            if(!fileInput.files || !fileInput.files[0]) return Swal.fire('Pilih File', 'Silakan upload file CSV', 'warning');
            ui.loading(true, "Mengimport data massal...");
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const lines = text.split(/\r\n|\n/).filter(l => l.trim().length > 0);
                const BATCH_SIZE = 450; 
                let batches = [];
                let currentBatch = writeBatch(db);
                let opCount = 0;
                let totalCount = 0;
                for(const l of lines){
                    const [n, e_mail, p, r, k] = l.split(',');
                    if(e_mail && e_mail.includes('@')){
                        const newDocRef = doc(collection(db, 'data_pengguna'));
                        currentBatch.set(newDocRef, { nama: n.trim(), email: e_mail.trim(), password: p.trim(), role: r ? r.trim() : 'siswa', kelas: k ? k.trim() : '', status: 'pending_auth', timestamp: serverTimestamp() });
                        opCount++; totalCount++;
                        if(opCount >= BATCH_SIZE){ batches.push(currentBatch.commit()); currentBatch = writeBatch(db); opCount = 0; }
                    }
                }
                if(opCount > 0) batches.push(currentBatch.commit());
                await Promise.all(batches);
                window.app.closeModal('modal-import'); window.app.loadUsers(); ui.loading(false); Swal.fire('Sukses', `Berhasil mengimport ${totalCount} data!`, 'success');
            };
            reader.readAsText(file);
        };

        // === AUTH & ROLE LOGIC ===
        onAuthStateChanged(auth, async(u) => {
            if(u) {
                const p = await getDoc(doc(db, 'data_pengguna', u.uid));
                state.user = u;
                state.profile = p.exists() ? p.data() : { role: 'siswa', nama: 'User', kelas: '-' };
                await window.app.loadSchoolConfig();
                ui.resetPages(); 
                const role = (state.profile.role || '').toLowerCase();
                if(role === 'siswa') {
                    ui.show('view-student-portal');
                    ui.el('student-token-screen').classList.remove('hidden-section');
                    ui.el('student-exam-screen').classList.add('hidden-section'); 
                    ui.el('stu-name').innerText = state.profile.nama;
                    ui.el('stu-class').innerText = state.profile.kelas || 'Tanpa Kelas';
                } else {
                    ui.show('layout-dashboard');
                    ui.el('sidebar-nama').innerText = state.profile.nama;
                    ui.el('user-initial').innerText = state.profile.nama.charAt(0);
                    ui.el('sidebar-role').innerText = role.toUpperCase(); 
                    window.app.nav('page-dashboard'); 
                    const m = ui.el('sidebar-menu'); m.innerHTML='';
                    const add=(n,p)=>m.innerHTML+=`<button onclick="window.app.nav('${p}')" class="w-full text-left px-4 py-3.5 text-slate-600 hover:bg-slate-50 hover:text-brand-600 rounded-xl font-bold text-sm mb-1 transition">${n}</button>`;
                    if(role === 'admin') {
                        add('Dashboard','page-dashboard');
                        add('Atur Jadwal', 'page-atur-jadwal');
                        add('Manajemen Kelas','page-kelas');
                        add('Bank Soal','page-bank-soal');
                        add('Sesi Ujian','page-sesi-ujian');
                        add('Rekap Nilai','page-nilai');
                        add('User','page-users');
                        add('Presensi Kelas','page-presensi');
                        add('Rekap Absensi', 'page-rekap-absensi');
                        add('Jurnal Mengajar', 'page-agenda');
                        add('Nilai Harian', 'page-nilai-harian');
                        add('Leger Nilai', 'page-leger');
                        add('Dashboard Piket', 'page-piket')
                    } else if (role === 'guru') {
                        add('Dashboard', 'page-dashboard');
                        add('Kelas Saya', 'page-kelas'); 
                        add('Bank Soal', 'page-bank-soal');
                        add('Sesi Ujian', 'page-sesi-ujian');
                        add('Rekap Nilai', 'page-nilai');
                        add('Presensi Kelas', 'page-presensi'); 
                        add('Rekap Absensi', 'page-rekap-absensi');
                        add('Jurnal Mengajar', 'page-agenda');
                        add('Kegiatan Kelas', 'page-kegiatan');
                        add('Nilai Harian', 'page-nilai-harian');
                        add('Leger Nilai', 'page-leger');
                        if(ui.el('btn-add-kelas')) ui.el('btn-add-kelas').classList.add('hidden');
                    } else if (role === 'piket') {
                        add('Dashboard Piket', 'page-piket');
                    }
                    
                }
            } else { ui.resetPages(); ui.show('view-login'); }
            ui.loading(false);
        });

                ui.el('login-form').onsubmit = async (e) => {
            e.preventDefault();
            ui.loading(true, "Sedang masuk...");
            
            const email = ui.el('login-email').value.trim();
            const pass = ui.el('login-password').value.trim();
            
            try {
                // Percobaan 1: Login Normal
                await signInWithEmailAndPassword(auth, email, pass);
                // Jika sukses, onAuthStateChanged akan menangani sisanya
            } catch (error) {
                console.error("Login Error:", error.code);

                // Handle Rate Limit
                if (error.code === 'auth/too-many-requests') {
                    ui.loading(false);
                    return Swal.fire({
                        title: 'Jaringan Sibuk',
                        text: 'Terlalu banyak percobaan. Tunggu 1 menit atau gunakan data seluler.',
                        icon: 'warning'
                    });
                }

                // Handle User Belum Ada / Salah Password
                if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') {
                    try {
                        ui.loading(true, "Verifikasi data siswa...");

                        // STRATEGI BARU: BYPASS PERMISSION ERROR
                        // 1. Buat akun Auth dulu agar dianggap 'Authenticated User' oleh Firebase
                        const userCred = await createUserWithEmailAndPassword(auth, email, pass);
                        const user = userCred.user;
                        
                        // 2. Sekarang kita sudah login, jadi BOLEH baca database (sesuai rules standar)
                        const q = query(collection(db, 'data_pengguna'), where('email', '==', email));
                        const snap = await getDocs(q);
                        
                        let isValidStudent = false;

                        if (!snap.empty) {
                            const tempDoc = snap.docs[0];
                            const tempData = tempDoc.data();
                            const dbPass = String(tempData.password).trim();
                            
                            // 3. Cek Password Database vs Input
                            if (dbPass === pass) {
                                isValidStudent = true;
                                ui.loading(true, "Mengaktifkan akun...");
                                
                                // Migrasi Data
                                await setDoc(doc(db, 'data_pengguna', user.uid), { 
                                    ...tempData, 
                                    status: 'aktif', 
                                    migratedAt: serverTimestamp() 
                                });
                                // Hapus data lama
                                await deleteDoc(tempDoc.ref);
                                
                                // Refresh halaman agar profil ter-load sempurna
                                window.location.reload();
                                return;
                            }
                        }

                        // 4. Jika data tidak ditemukan atau password salah: ROLLBACK (Hapus akun yg baru dibuat)
                        if (!isValidStudent) {
                            await user.delete().catch(async () => {
                                // Fallback jika user.delete gagal, kita signout saja
                                await signOut(auth);
                            });
                            
                            ui.loading(false);
                            return Swal.fire({
                                title: 'Gagal Verifikasi',
                                html: `Email terdaftar tapi password salah atau data tidak ditemukan.<br>Pastikan password sesuai data dari guru.`,
                                icon: 'error'
                            });
                        }

                    } catch (regError) {
                        console.error("Auto-reg failed:", regError);
                        
                        // Jika error email-already-in-use disini, berarti akun Auth sebenernya ada, tapi login awal gagal (Password Salah)
                        if (regError.code === 'auth/email-already-in-use') {
                            ui.loading(false);
                            return Swal.fire('Password Salah', 'Akun siswa sudah aktif, tapi password yang dimasukkan salah.', 'error');
                        }
                        
                        // Jika error permission masih muncul (sangat jarang dengan metode ini), berarti rules sangat ketat
                        if (regError.code === 'permission-denied' || regError.message.includes('permission')) {
                            ui.loading(false);
                            return Swal.fire('Akses Ditolak', 'Database terkunci. Hubungi admin untuk cek Security Rules.', 'error');
                        }
                    }
                }
                
                ui.loading(false);
                Swal.fire({
                    title: 'Gagal Masuk',
                    text: 'Periksa kembali penulisan Email dan Password (huruf besar/kecil berpengaruh).',
                    icon: 'error'
                });
            }
        };

        ui.el('btn-dev-regist').onclick=async()=>{const f=await Swal.fire({title:'Dev',html:'<input id="e" class="swal2-input" placeholder="Email"><input id="p" class="swal2-input" placeholder="Pass">',preConfirm:()=>[ui.el('e').value,ui.el('p').value]});if(f.isConfirmed)try{const c=await createUserWithEmailAndPassword(auth,f.value[0],f.value[1]);await setDoc(doc(db,'data_pengguna',c.user.uid),{nama:'Super Admin',email:f.value[0],role:'admin',created_at:serverTimestamp()});location.reload();}catch(e){}};

        window.app.generateSesi = async () => { 
            ui.loading(true); 
            const id = ui.el('sesi-id').value;
            const sp=ui.el('sesi-kelas-spesifik').value; 
            const d={ mapel:ui.el('sesi-mapel').value, materi:ui.el('sesi-materi').value, durasi:Number(ui.el('sesi-durasi').value), jumlah:Number(ui.el('sesi-jml').value), limit:Number(ui.el('sesi-attempt').value), max_curang:Number(ui.el('sesi-max-curang').value), jenjang:ui.el('sesi-jenjang').value, kelas_spesifik:sp }; 
            if(id) { await updateDoc(doc(db,'data_sesiujian',id), d); window.app.closeModal('modal-sesi'); window.app.loadSesi(); ui.toast('Sesi diperbarui'); } else { d.token = Math.random().toString(36).substring(2,8).toUpperCase(); d.status = 'aktif'; d.created_at = serverTimestamp(); await addDoc(collection(db,'data_sesiujian'),d); window.app.closeModal('modal-sesi'); window.app.loadSesi(); Swal.fire('Token',d.token,'success'); }
            ui.loading(false); 
        };

        window.app.openModalSesi = () => { ui.el('form-sesi').reset(); ui.el('sesi-id').value = ''; ui.show('modal-sesi'); };
        window.app.editSesi = async (id) => { ui.loading(true); const d = (await getDoc(doc(db, 'data_sesiujian', id))).data(); ui.el('sesi-id').value = id; ui.el('sesi-mapel').value = d.mapel; ui.el('sesi-materi').value = d.materi; ui.el('sesi-durasi').value = d.durasi; ui.el('sesi-jml').value = d.jumlah; ui.el('sesi-attempt').value = d.limit || 1; ui.el('sesi-max-curang').value = d.max_curang || 3; ui.el('sesi-jenjang').value = d.jenjang; ui.el('sesi-kelas-spesifik').value = d.kelas_spesifik || ''; ui.show('modal-sesi'); ui.loading(false); };
        window.app.deleteSesi = async (id) => { if((await Swal.fire({title:'Hapus Sesi?',text:'Data nilai siswa pada sesi ini mungkin akan terpengaruh.',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'})).isConfirmed){ await deleteDoc(doc(db,'data_sesiujian',id)); window.app.loadSesi(); } };
        window.app.loadSesi = async () => { const tb=ui.el('tbody-sesi'); tb.innerHTML='loading...'; const s=await getDocs(query(collection(db,'data_sesiujian'),orderBy('created_at','desc'))); tb.innerHTML=''; s.forEach(d=>{ const dt=d.data(); tb.innerHTML+=`<tr class="border-b hover:bg-slate-50"><td class="p-4 font-bold text-slate-700">${dt.mapel}</td><td class="p-4 font-mono text-sm">${dt.jenjang||'All'} ${dt.kelas_spesifik?`(${dt.kelas_spesifik})`:''}</td><td class="p-4 text-center"><span class="bg-slate-100 font-mono font-bold px-3 py-1 rounded select-all">${dt.token}</span></td><td class="p-4 text-center font-bold">${dt.durasi}m</td><td class="p-4 text-center"><span class="px-3 py-1 rounded-full text-xs font-bold ${dt.status=='aktif'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}">${dt.status}</span></td><td class="p-4 text-right flex gap-2 justify-end"><button onclick="window.app.toggleSesi('${d.id}','${dt.status}')" class="text-blue-600 text-xs font-bold underline hover:text-blue-800">SWITCH</button><button onclick="window.app.editSesi('${d.id}')" class="w-8 h-8 rounded bg-yellow-50 text-yellow-600 hover:bg-yellow-100"><i class="fa-solid fa-pen"></i></button><button onclick="window.app.deleteSesi('${d.id}')" class="w-8 h-8 rounded bg-red-50 text-red-600 hover:bg-red-100"><i class="fa-solid fa-trash"></i></button></td></tr>`; }); };
        window.app.toggleSesi = async(id,s) => { await updateDoc(doc(db,'data_sesiujian',id),{status:s==='aktif'?'tutup':'aktif'}); window.app.loadSesi(); };
        
        window.app.studentCheckToken = async () => { 
            const t = ui.el('inp-student-token').value.toUpperCase().trim(); 
            if(!t) return Swal.fire('Token Kosong','','warning'); 
            ui.loading(true, "Memeriksa Token..."); 
            try { 
                const q = query(collection(db,'data_sesiujian'), where('token','==',t)); 
                const snap = await getDocs(q); 
                if(snap.empty) throw "Token tidak ditemukan. Mohon periksa kembali."; 
                const sesi = { id: snap.docs[0].id, ...snap.docs[0].data() }; 
                if(sesi.status !== 'aktif') throw "Sesi ujian ini sudah ditutup / non-aktif."; 
                if(!auth.currentUser) throw "Sesi login kadaluarsa. Silakan refresh halaman.";
                const riwayatQ = query(collection(db, 'data_nilaiujian'), where('userId', '==', auth.currentUser.uid)); 
                const riwayatSnap = await getDocs(riwayatQ);
                const attempts = riwayatSnap.docs.filter(doc => doc.data().mapel === sesi.mapel).length;
                if(attempts >= (sesi.limit || 1)) throw `Anda sudah mengerjakan ujian ini ${attempts} kali. Batas maksimal tercapai.`;
                const soalQ = query(collection(db, 'data_soalujian'), where('mapel', '==', sesi.mapel)); 
                const soalSnap = await getDocs(soalQ); 
                if(soalSnap.empty) throw `Soal untuk mata pelajaran "${sesi.mapel}" belum tersedia di sistem.`; 
                state.exam.data = sesi; 
                state.exam.questions = []; 
                soalSnap.forEach(d => state.exam.questions.push({id:d.id, ...d.data()})); 
                state.exam.questions.sort(() => Math.random() - 0.5); 
                if(sesi.jumlah && state.exam.questions.length > sesi.jumlah) state.exam.questions.length = sesi.jumlah; 
                state.exam.answers = {}; state.exam.violations = 0; state.exam.activeQ = 0; state.exam.endTime = Date.now() + (sesi.durasi * 60000); state.exam.maxFraud = sesi.max_curang || 3; 
                ui.loading(false);
                Swal.fire({ title: 'Siap Ujian?', html: `<div class="text-left text-sm bg-slate-50 p-4 rounded-lg border border-slate-200"><p><b>Mata Pelajaran:</b> ${sesi.mapel}</p><p><b>Jumlah Soal:</b> ${state.exam.questions.length}</p><p><b>Durasi Waktu:</b> ${sesi.durasi} Menit</p><div class="mt-3 pt-3 border-t border-slate-200 text-red-600 font-bold text-center"><i class="fa-solid fa-triangle-exclamation"></i> DILARANG PINDAH TAB / KELUAR FULLSCREEN</div></div>`, icon: 'info', showCancelButton: true, confirmButtonText: 'MULAI KERJAKAN', confirmButtonColor: '#2563eb', cancelButtonText: 'Batal' }).then((r) => { if(r.isConfirmed) { document.documentElement.requestFullscreen().catch((err) => { console.log("Fullscreen blocked or not supported", err); }).finally(() => { setTimeout(() => window.app.startExamUI(), 800); }); } }); 
            } catch(e) { console.error(e); ui.loading(false); Swal.fire('Gagal Memulai', e.toString(), 'error'); } 
        };

                window.app.startExamUI = () => {

            // Pindah dari token screen ke exam screen
            ui.el('student-token-screen').classList.add('hidden-section');
            ui.el('student-exam-screen').classList.remove('hidden-section');

            //  SEMBUNYIKAN NAVBAR SAAT MASUK UJIAN 
            document.getElementById('nav-bottom-student').classList.add('hidden');

            // Set data ujian
            ui.el('ex-title').innerText = state.exam.data.mapel;
            ui.el('ex-subtitle').innerText = `${state.profile.nama} - ${state.profile.kelas}`;
            ui.loading(false);

            // Build navigation grid
            const navGrid = ui.el('ex-nav-grid'); 
            navGrid.innerHTML = '';
            state.exam.questions.forEach((_, i) => { 
                navGrid.innerHTML += `
                    <button id="nav-${i}" onclick="window.app.jumpQuestion(${i})"
                    class="w-full aspect-square rounded-lg border font-bold text-sm hover:bg-brand-50 transition bg-white text-slate-600">
                        ${i+1}
                    </button>`;
            });

            // Setup timer
            clearInterval(state.exam.timer);
            state.exam.timer = setInterval(() => {
                const rem = state.exam.endTime - Date.now();
                if(rem <= 0) { 
                    window.app.finishExam(true); 
                } else { 
                    const m = Math.floor(rem / 60000); 
                    const s = Math.floor((rem % 60000) / 1000); 
                    ui.el('ex-timer').innerText = `${m}:${s<10?'0':''}${s}`;
                }
            }, 1000);

            // Load first question
            window.app.jumpQuestion(0);
        };

        window.app.jumpQuestion = (idx) => {
            if(idx < 0 || idx >= state.exam.questions.length) return;
            state.exam.activeQ = idx;
            const q = state.exam.questions[idx];
            ui.el('ex-q-no').innerText = idx + 1;
            let content = q.pertanyaan.replace(/\n/g, '<br>');
            if(q.gambar) content = `<img src="${q.gambar}" class="max-h-60 rounded-lg mb-4 border shadow-sm block">` + content;
            ui.el('ex-q-content').innerHTML = content;
            MathJax.typesetPromise([ui.el('ex-q-content')]);
            const optDiv = ui.el('ex-options'); optDiv.innerHTML = '';
            const savedAns = state.exam.answers[q.id];
            if(q.jenis_soal === 'BENAR_SALAH' && Array.isArray(q.pilihanJawaban)) {
                q.pilihanJawaban.forEach((item, i) => {
                    const val = (savedAns || {})[i];
                    let contentHtml = item.teksOpsi;
                    if(item.gambar) contentHtml = `<img src="${item.gambar}" class="max-h-24 rounded mb-2 block border">` + contentHtml;
                    optDiv.innerHTML += `<div class="p-4 border rounded-xl bg-white hover:bg-slate-50 transition"><div class="mb-2 font-medium">${contentHtml}</div><div class="flex gap-4"><label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="bs-${i}" value="BENAR" ${val==='BENAR'?'checked':''} onchange="window.app.saveAns(${idx}, ${i}, 'BENAR', true)"> Benar</label><label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="bs-${i}" value="SALAH" ${val==='SALAH'?'checked':''} onchange="window.app.saveAns(${idx}, ${i}, 'SALAH', true)"> Salah</label></div></div>`;
                });
            } else if (q.jenis_soal !== 'ESSAY') {
                q.opsi.forEach(o => {
                    const isSel = q.jenis_soal === 'PG_KOMPLEKS' ? (savedAns||[]).includes(o.label) : savedAns === o.label;
                    const inputType = q.jenis_soal === 'PG_KOMPLEKS' ? 'checkbox' : 'radio';
                    optDiv.innerHTML += `<label class="flex items-center gap-3 p-4 border rounded-xl cursor-pointer hover:bg-brand-50 transition ${isSel ? 'bg-brand-50 border-brand-500 ring-1 ring-brand-500' : 'bg-white'}"><div class="w-8 h-8 rounded-full flex items-center justify-center font-bold ${isSel ? 'bg-brand-600 text-white' : 'bg-slate-100 text-slate-500'}">${o.label}</div><input type="${inputType}" name="opt" value="${o.label}" class="hidden" ${isSel?'checked':''} onchange="window.app.saveAns(${idx}, '${o.label}', this.checked)"><div class="text-slate-700 font-medium">${o.img ? `<img src="${o.img}" class="h-12 mb-1">`:''}${o.text}</div></label>`;
                });
            } else { optDiv.innerHTML = `<textarea class="w-full border p-4 rounded-xl h-32 focus:ring-2 outline-none" placeholder="Jawab disini..." onchange="window.app.saveAns(${idx}, this.value)">${savedAns || ''}</textarea>`; }
            MathJax.typesetPromise([optDiv]);
            document.querySelectorAll('#ex-nav-grid button').forEach(b => b.classList.remove('ring-2', 'ring-brand-500', 'border-brand-500'));
            document.getElementById(`nav-${idx}`).classList.add('ring-2', 'ring-brand-500', 'border-brand-500');
        };

        window.app.navQuestion = (dir) => window.app.jumpQuestion(state.exam.activeQ + dir);
        window.app.saveAns = (qIdx, val, isChecked, isBS = false) => {
            const q = state.exam.questions[qIdx]; let ans = state.exam.answers[q.id];
            if(isBS) { ans = ans || {}; ans[val] = isChecked; } else if(q.jenis_soal === 'PG_KOMPLEKS') { ans = ans || []; if(isChecked) ans.push(val); else ans = ans.filter(x => x !== val); } else { ans = val; }
            state.exam.answers[q.id] = ans;
            const btn = document.getElementById(`nav-${qIdx}`); if(btn) { btn.classList.remove('bg-white', 'text-slate-600'); btn.classList.add('bg-green-500', 'text-white', 'border-green-600'); }
            if(q.jenis_soal === 'PG') window.app.jumpQuestion(qIdx); 
        };
        
        window.app.markDoubt = () => { const btn = document.getElementById(`nav-${state.exam.activeQ}`); if(ui.el('ex-doubt').checked) { btn.className = "w-full aspect-square rounded-lg border font-bold text-sm transition bg-yellow-400 text-white border-yellow-500"; } else { btn.className = "w-full aspect-square rounded-lg border font-bold text-sm hover:bg-brand-50 transition bg-white text-slate-600"; } };

        window.app.finishExam = async (auto = false) => {
            if(!auto) { const conf = await Swal.fire({ title: 'Kumpulkan Jawaban?', text: 'Pastikan semua soal sudah terjawab.', icon: 'question', showCancelButton: true, confirmButtonText: 'Ya, Selesai' }); if(!conf.isConfirmed) return; }
            ui.loading(true, "Menyimpan Jawaban...");
            clearInterval(state.exam.timer);
            document.removeEventListener('fullscreenchange', window.app.checkFraud);
            let correct = 0; let details = [];
            state.exam.questions.forEach(q => {
                const ans = state.exam.answers[q.id]; let isCorrect = false;
                if(q.jenis_soal === 'PG' && ans === q.kunci[0]) isCorrect = true;
                else if(q.jenis_soal === 'BENAR_SALAH' && Array.isArray(q.pilihanJawaban)) { let allMatch = true; q.pilihanJawaban.forEach((item, i) => { if((ans||{})[i] !== item.kunci) allMatch = false; }); if(allMatch) isCorrect = true; }
                if(isCorrect) correct++;
                details.push({ id: q.id, ans: ans || null, correct: isCorrect });
            });
            const finalScore = Math.round((correct / state.exam.questions.length) * 100);
            
            await addDoc(collection(db, 'data_nilaiujian'), {
                userId: auth.currentUser.uid,
                nama: state.profile.nama,
                kelas: state.profile.kelas,
                mapel: state.exam.data.mapel,
                token: state.exam.data.token, 
                nilai: finalScore,
                detail: details,
                violations: state.exam.violations,
                tahun_ajaran: state.schoolConfig.tahun,
                semester: state.schoolConfig.semester,
                timestamp: serverTimestamp()
            });
            if(document.fullscreenElement) document.exitFullscreen().catch(()=>{});
            ui.el('student-exam-screen').classList.add('hidden-section');
            ui.el('student-result-screen').classList.remove('hidden-section');
            ui.el('res-score').innerText = finalScore;
            
            // TAMPILKAN KEMBALI NAVBAR SETELAH SELESAI
            document.getElementById('nav-bottom-student').classList.remove('hidden');

            ui.loading(false); 
        };
        
        window.app.calcInput = (val) => { const display = document.getElementById('calc-display'); if(val === 'C') display.value = ''; else if(val === '=') { try { display.value = eval(display.value); } catch { display.value = 'Error'; } } else { display.value += val; } };

        // === UPDATED MASTER KELAS LOGIC FOR TEACHERS & ADMIN ===
        window.app.loadMasterKelas = async () => {
            const tb = ui.el('tbody-kelas');
            tb.innerHTML = '<tr><td colspan="6" class="text-center p-6">Loading Data Kelas...</td></tr>';
            
            const role = state.profile.role;
            const myUid = state.user.uid;
            const myName = state.profile.nama;

            try {
                const kelasSnap = await getDocs(query(collection(db, 'data_master_kelas'), orderBy('nama_kelas', 'asc')));
                const usersSnap = await getDocs(collection(db, 'data_pengguna'));
                const allStudents = [];
                usersSnap.forEach(d => { const data = d.data(); if ((data.role || '').toLowerCase() === 'siswa') { allStudents.push(data); } });
                tb.innerHTML = '';
                if (kelasSnap.empty) { tb.innerHTML = '<tr><td colspan="6" class="text-center p-6 text-slate-400">Belum ada kelas. Silakan tambah.</td></tr>'; return; }

                kelasSnap.forEach(doc => {
                    const d = doc.data();
                    const classId = doc.id;
                    const className = d.nama_kelas;
                    
                    if (role === 'guru') {
                        let isMyClass = false;
                        if (d.wali_kelas_nama === myName) isMyClass = true;
                        if (!isMyClass && d.guru_mapel) { const guruUids = Object.values(d.guru_mapel); if (guruUids.includes(myUid)) isMyClass = true; }
                        if (!isMyClass) return; 
                    }

                    const classStudents = allStudents.filter(s => (s.kelas || '').trim().toLowerCase() === className.trim().toLowerCase());
                    const count = classStudents.length;
                    const accordionId = `acc-${classId}`;

                    let studentListHtml = '';
                    if (classStudents.length > 0) { classStudents.forEach((s, i) => { studentListHtml += `<div class="flex items-center p-2 border-b border-slate-100 last:border-0 hover:bg-slate-50"><span class="w-8 text-center text-slate-400 text-xs font-bold">${i+1}</span><div class="flex-1"><p class="text-sm font-bold text-slate-700">${s.nama}</p><p class="text-xs text-slate-400">${s.email}</p></div></div>`; }); } else { studentListHtml = '<p class="text-center text-slate-400 py-4 text-sm italic">Belum ada siswa di kelas ini.</p>'; }
                    
                    let actionButtons = '';
                    if (role === 'admin') {
                        actionButtons = `<button onclick="window.app.openModalAturGuru('${classId}')" class="bg-yellow-100 text-yellow-700 p-2 rounded-lg text-xs font-bold mr-2 hover:bg-yellow-200" title="Atur Guru Pengampu"><i class="fa-solid fa-chalkboard-user"></i> GURU</button><button onclick="window.app.openRoster('${className}')" class="bg-purple-100 text-purple-600 p-2 rounded-lg text-xs font-bold mr-2 hover:bg-purple-200" title="Atur Siswa"><i class="fa-solid fa-users-gear"></i> SISWA</button><button onclick="window.app.editKelas('${classId}')" class="bg-blue-50 text-blue-600 p-2 rounded-lg hover:bg-blue-100 mr-1"><i class="fa-solid fa-pen"></i></button><button onclick="window.app.deleteKelas('${classId}')" class="bg-red-50 text-red-600 p-2 rounded-lg hover:bg-red-100"><i class="fa-solid fa-trash"></i></button>`;
                    } else {
                        actionButtons = `<button onclick="window.app.toggleAccordion('${accordionId}')" class="bg-brand-50 text-brand-600 px-3 py-1 rounded-lg text-xs font-bold">Lihat Siswa</button>`;
                    }

                    tb.innerHTML += `<tr class="border-b hover:bg-slate-50 transition group cursor-pointer" onclick="window.app.toggleAccordion('${accordionId}')"><td class="p-4 text-center"><button class="w-8 h-8 rounded-full bg-slate-100 hover:bg-brand-100 text-slate-500 hover:text-brand-600 transition flex items-center justify-center transform duration-300" id="btn-${accordionId}"><i class="fa-solid fa-chevron-down transition-transform duration-300"></i></button></td><td class="p-4 font-bold text-slate-700 text-lg">${className}</td><td class="p-4"><span class="bg-slate-100 px-2 py-1 rounded text-xs font-bold">${d.jenjang}</span> <span class="text-xs text-slate-500">${d.jurusan || '-'}</span></td><td class="p-4 text-sm text-slate-600"><i class="fa-solid fa-chalkboard-user mr-2 text-brand-500"></i>${d.wali_kelas_nama || '-'}</td><td class="p-4 text-center"><span class="font-bold text-brand-600 bg-brand-50 px-3 py-1 rounded-lg border border-brand-100">${count}</span></td><td class="p-4 text-right" onclick="event.stopPropagation()">${actionButtons}</td></tr><tr class="bg-slate-50/50 border-b hidden" id="row-${accordionId}"><td colspan="6" class="p-0"><div class="accordion-content bg-white border-l-4 border-brand-500 m-4 rounded-lg shadow-sm" id="${accordionId}"><div class="p-4"><h4 class="font-bold text-xs text-slate-500 uppercase mb-3 border-b pb-2">Daftar Siswa (${count})</h4><div class="max-h-60 overflow-y-auto custom-scrollbar">${studentListHtml}</div></div></div></td></tr>`;
                });
            } catch (e) { console.error(e); tb.innerHTML = '<tr><td colspan="6" class="text-center text-red-500">Gagal memuat data.</td></tr>'; }
        };
        
        window.app.openModalAturGuru = async (classId) => {
            ui.loading(true);
            try {
                const classDoc = await getDoc(doc(db, 'data_master_kelas', classId));
                if (!classDoc.exists()) throw "Kelas tidak ditemukan";
                const classData = classDoc.data();
                const currentMap = classData.guru_mapel || {};
                const teachersSnap = await getDocs(query(collection(db, 'data_pengguna'), where('role', '==', 'guru')));
                const teachers = [];
                teachersSnap.forEach(d => teachers.push({ id: d.id, nama: d.data().nama }));
                teachers.sort((a, b) => a.nama.localeCompare(b.nama));
                const container = ui.el('container-atur-guru'); container.innerHTML = '';
                ui.el('atur-guru-kelas-id').value = classId;
                ui.el('title-atur-guru').innerText = `Guru Pengampu - ${classData.nama_kelas}`;
                const createOptions = (selectedUid) => { let opts = '<option value="">-- Pilih Guru --</option>'; teachers.forEach(t => { opts += `<option value="${t.id}" ${t.id === selectedUid ? 'selected' : ''}>${t.nama}</option>`; }); return opts; };
                STANDARD_MAPEL_LIST.forEach(mapel => { const selectedUid = currentMap[mapel] || ""; container.innerHTML += `<div class="flex items-center gap-4 p-3 bg-slate-50 rounded-lg border border-slate-200"><div class="w-1/3 font-bold text-slate-700 text-sm">${mapel}</div><select class="flex-1 border p-2 rounded-lg text-sm bg-white guru-mapel-select" data-mapel="${mapel}">${createOptions(selectedUid)}</select></div>`; });
                ui.show('modal-atur-guru');
            } catch (e) { Swal.fire('Error', e.message, 'error'); } ui.loading(false);
        };

        window.app.saveGuruMapel = async () => {
            ui.loading(true);
            const classId = ui.el('atur-guru-kelas-id').value;
            const selects = document.querySelectorAll('.guru-mapel-select');
            const newMap = {};
            selects.forEach(sel => { const mapel = sel.getAttribute('data-mapel'); const uid = sel.value; if (uid) newMap[mapel] = uid; });
            try { await updateDoc(doc(db, 'data_master_kelas', classId), { guru_mapel: newMap }); window.app.closeModal('modal-atur-guru'); window.app.loadMasterKelas(); ui.toast('Data guru pengampu tersimpan'); } catch (e) { Swal.fire('Error', 'Gagal menyimpan', 'error'); } ui.loading(false);
        };
        window.app.toggleAccordion = (id) => { const content = document.getElementById(id); const row = document.getElementById(`row-${id}`); const btnIcon = document.querySelector(`#btn-${id} i`); if (row.classList.contains('hidden')) { row.classList.remove('hidden'); setTimeout(() => { content.classList.add('open'); btnIcon.classList.add('rotate-180'); }, 10); } else { content.classList.remove('open'); btnIcon.classList.remove('rotate-180'); setTimeout(() => { row.classList.add('hidden'); }, 300); } };
        window.app.openModalKelas = async () => { ui.el('form-kelas').reset(); ui.el('kelas-id').value = ''; ui.show('modal-kelas'); const sel = ui.el('inp-kelas-wali'); sel.innerHTML = '<option value="">Loading...</option>'; const guruSnap = await getDocs(query(collection(db, 'data_pengguna'), where('role', '==', 'guru'))); sel.innerHTML = '<option value="">-- Pilih Guru --</option>'; guruSnap.forEach(g => { sel.innerHTML += `<option value="${g.data().nama}">${g.data().nama}</option>`; }); };
        ui.el('form-kelas').onsubmit = async (e) => { e.preventDefault(); ui.loading(true); const id = ui.el('kelas-id').value; const data = { nama_kelas: ui.el('inp-kelas-nama').value.toUpperCase(), jenjang: ui.el('inp-kelas-jenjang').value, jurusan: ui.el('inp-kelas-jurusan').value, wali_kelas_nama: ui.el('inp-kelas-wali').value, updated_at: serverTimestamp() }; try { if (id) await updateDoc(doc(db, 'data_master_kelas', id), data); else await addDoc(collection(db, 'data_master_kelas'), data); window.app.closeModal('modal-kelas'); window.app.loadMasterKelas(); ui.toast('Data Kelas Disimpan'); } catch (error) { Swal.fire('Error', error.message, 'error'); } ui.loading(false); };
        window.app.deleteKelas = async (id) => { if ((await Swal.fire({ title: 'Hapus Kelas?', text: 'Data siswa tidak akan terhapus, hanya nama kelasnya.', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' })).isConfirmed) { await deleteDoc(doc(db, 'data_master_kelas', id)); window.app.loadMasterKelas(); } };
        window.app.editKelas = async (id) => { ui.loading(true); const d = (await getDoc(doc(db, 'data_master_kelas', id))).data(); await window.app.openModalKelas(); ui.el('kelas-id').value = id; ui.el('inp-kelas-nama').value = d.nama_kelas; ui.el('inp-kelas-jenjang').value = d.jenjang; ui.el('inp-kelas-jurusan').value = d.jurusan; ui.el('inp-kelas-wali').value = d.wali_kelas_nama; ui.loading(false); };
        window.app.openRoster = async (namaKelas) => { ui.loading(true); ui.el('roster-kelas-title').innerText = `KELAS: ${namaKelas}`; ui.show('modal-roster'); const cAvail = ui.el('list-siswa-avail'); const cReg = ui.el('list-siswa-reg'); cAvail.innerHTML = '<div class="loader mx-auto"></div>'; cReg.innerHTML = '<div class="loader mx-auto"></div>'; try { const snap = await getDocs(collection(db, 'data_pengguna')); cAvail.innerHTML = ''; cReg.innerHTML = ''; const targetClass = namaKelas.trim(); snap.forEach(doc => { const s = doc.data(); const role = (s.role || '').toLowerCase(); if (role === 'siswa') { const uid = doc.id; const userClass = (s.kelas || '').trim(); const item = `<div class="flex justify-between items-center p-3 bg-white border rounded-lg shadow-sm text-sm hover:bg-slate-50 transition group roster-item" data-name="${(s.nama || '').toLowerCase()}"><div><div class="font-bold text-slate-700">${s.nama}</div><div class="text-[10px] text-slate-400 truncate">${userClass || 'Belum ada kelas'} | ${s.email}</div></div>${userClass === targetClass ? `<button onclick="window.app.moveSiswa('${uid}', '')" class="w-8 h-8 bg-red-50 text-red-500 rounded-lg hover:bg-red-200 transition"><i class="fa-solid fa-arrow-left"></i></button>` : `<button onclick="window.app.moveSiswa('${uid}', '${targetClass}')" class="w-8 h-8 bg-green-50 text-green-500 rounded-lg hover:bg-green-200 transition"><i class="fa-solid fa-arrow-right"></i></button>`}</div>`; if (userClass === targetClass) { cReg.innerHTML += item; } else { cAvail.innerHTML += item; } } }); if (cReg.innerHTML === '') cReg.innerHTML = '<p class="text-center text-gray-400 text-xs py-4">Belum ada siswa</p>'; if (cAvail.innerHTML === '') cAvail.innerHTML = '<p class="text-center text-gray-400 text-xs py-4">Tidak ada siswa lain</p>'; } catch (e) { console.error("Roster error:", e); Swal.fire('Error', 'Gagal memuat data siswa', 'error'); } ui.loading(false); };
        window.app.viewUserDetail = async (id) => { const d = await getDoc(doc(db, "data_pengguna", id)); const u = d.data(); Swal.fire({ title: "Detail Pengguna", html: `<div class="text-left space-y-2"><p><b>Nama:</b> ${u.nama}</p><p><b>Email:</b> ${u.email}</p><p><b>Role:</b> ${u.role}</p><p><b>Kelas:</b> ${u.kelas || '-'}</p>${u.role === 'guru' ? `<p><b>Mapel:</b> ${u.mapel || '-'}</p><p><b>NIP:</b> ${u.nip || '-'}</p>` : ''}</div>`, confirmButtonText: "Tutup", }); };
        window.app.moveSiswa = async (uid, targetKelas) => { const row = event.target.closest('.flex'); if(row) row.style.opacity = '0.5'; try { await updateDoc(doc(db, 'data_pengguna', uid), { kelas: targetKelas }); const currentTitle = ui.el('roster-kelas-title').innerText.replace('KELAS: ', ''); window.app.openRoster(currentTitle); ui.toast(targetKelas ? 'Siswa Ditambahkan' : 'Siswa Dikeluarkan'); } catch (e) { Swal.fire('Error', 'Gagal memindahkan siswa', 'error'); } };
        window.app.filterRoster = (type) => { const txt = ui.el(type === 'avail' ? 'search-siswa-avail' : 'search-siswa-reg').value.toLowerCase(); const container = ui.el(type === 'avail' ? 'list-siswa-avail' : 'list-siswa-reg'); const items = container.getElementsByClassName('roster-item'); Array.from(items).forEach(item => { const name = item.getAttribute('data-name'); item.style.display = name.includes(txt) ? 'flex' : 'none'; }); };
        
        // === POPULATE TOKEN DROPDOWN FOR NILAI FILTER ===
        window.app.loadSesiForFilter = async () => {
             const sel = ui.el('filter-nilai-token');
             if(sel.options.length > 1) return; // already loaded
             const snap = await getDocs(query(collection(db, 'data_sesiujian'), orderBy('created_at', 'desc')));
             sel.innerHTML = '<option value="">-- Pilih Token/Ujian --</option>';
             snap.forEach(d => {
                 const dt = d.data();
                 sel.innerHTML += `<option value="${dt.token}">${dt.mapel} (${dt.token}) - ${dt.kelas_spesifik || 'All'}</option>`;
             });
        };

        // === UPDATED LOAD NILAI (MANUAL TRIGGER) ===
                window.app.loadNilai = async () => {
            const fToken = ui.el('filter-nilai-token').value;
            const fJ = ui.el('filter-nilai-jenjang').value;
            const fK = ui.el('filter-nilai-kelas').value;
            const tb = ui.el('tbody-nilai');

            ui.loading(true, "Mengambil data nilai...");
            tb.innerHTML = '';
            state.currentNilaiData = [];

            try {
                // =========================
                // QUERY DASAR
                // =========================
                let q = query(
                    collection(db, 'data_nilaiujian'),
                    orderBy('timestamp', 'desc')
                );

                if (fToken) {
                    q = query(
                        collection(db, 'data_nilaiujian'),
                        where('token', '==', fToken)
                    );
                }

                const s = await getDocs(q);

                if (s.empty) {
                    tb.innerHTML = `
                        <tr>
                            <td colspan="7" class="p-10 text-center text-slate-400">
                                Data nilai tidak ditemukan.
                            </td>
                        </tr>`;
                    ui.loading(false);
                    return;
                }

                let count = 0;

                s.forEach(d => {
                    const dt = d.data();

                    // =========================
                    // FILTER PERIODE
                    // =========================
                    const hasPeriodTag = dt.tahun_ajaran && dt.semester;
                    const isCurrentPeriod = hasPeriodTag
                        ? (dt.tahun_ajaran === state.schoolConfig.tahun &&
                        dt.semester === state.schoolConfig.semester)
                        : false;

                    const isLegacy = !hasPeriodTag;

                    if (!(isCurrentPeriod || isLegacy)) return;

                    // =========================
                    // FILTER JENJANG & KELAS
                    // =========================
                    if (fJ && dt.kelas && !dt.kelas.startsWith(fJ)) return;
                    if (fK && dt.kelas !== fK) return;

                    count++;
                    state.currentNilaiData.push(dt);

                    const tgl = dt.timestamp?.seconds
                        ? new Date(dt.timestamp.seconds * 1000).toLocaleDateString('id-ID')
                        : '-';

                    tb.innerHTML += `
                    <tr class="border-b hover:bg-slate-50">
                        <td class="p-4 text-sm">${tgl}</td>
                        <td class="p-4">
                            <span class="font-mono bg-slate-100 px-2 py-1 rounded text-xs">
                                ${dt.token || '-'}
                            </span>
                        </td>
                        <td class="p-4 font-bold text-slate-700">${dt.nama}</td>
                        <td class="p-4">${dt.kelas || '-'}</td>
                        <td class="p-4">${dt.mapel || '-'}</td>
                        <td class="p-4 font-bold text-center text-lg
                            ${dt.nilai >= 75 ? 'text-green-600' : 'text-red-500'}">
                            ${dt.nilai}
                        </td>
                        <td class="p-4 text-right">
                            <button
                                onclick="window.app.deleteNilai('${d.id}')"
                                class="text-red-400 hover:text-red-600 p-2 rounded-lg hover:bg-red-50 transition"
                                title="Hapus Nilai">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>`;
                });

                if (count === 0) {
                    tb.innerHTML = `
                        <tr>
                            <td colspan="7" class="p-10 text-center text-slate-400">
                                Tidak ada data di periode aktif ini.
                            </td>
                        </tr>`;
                }

            } catch (e) {
                console.error('Gagal load nilai', e);
                tb.innerHTML = `
                    <tr>
                        <td colspan="7" class="p-10 text-center text-red-500">
                            Gagal memuat data nilai.
                        </td>
                    </tr>`;
            }

            ui.loading(false);
        };

        // === HAPUS NILAI ===
        window.app.deleteNilai = async (id) => {
            const result = await Swal.fire({
                title: 'Hapus Nilai?',
                text: "Data nilai siswa ini akan dihapus permanen. Siswa bisa ujian lagi jika batas kesempatan masih ada.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Ya, Hapus',
                cancelButtonText: 'Batal'
            });

            if (result.isConfirmed) {
                ui.loading(true);
                try {
                    await deleteDoc(doc(db, 'data_nilaiujian', id));
                    ui.toast('Data nilai berhasil dihapus');
                    window.app.loadNilai(); // Refresh tabel
                } catch (e) {
                    console.error(e);
                    Swal.fire('Error', 'Gagal menghapus data.', 'error');
                }
                ui.loading(false);
            }
        };

        window.app.exportNilaiToExcel = () => {
            if(!state.currentNilaiData || state.currentNilaiData.length === 0) return Swal.fire('Info', 'Tidak ada data untuk diexport. Silakan cari data terlebih dahulu.', 'info');
            
            const dataToExport = state.currentNilaiData.map(d => ({
                Tanggal: new Date(d.timestamp.seconds*1000).toLocaleDateString(),
                Token: d.token || '-',
                Nama_Siswa: d.nama,
                Kelas: d.kelas,
                Mata_Pelajaran: d.mapel,
                Nilai: d.nilai,
                Pelanggaran: d.violations || 0
            }));

            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Rekap Nilai");
            XLSX.writeFile(wb, "Rekap_Nilai_LMS.xlsx");
        };

        // === PRESENSI KELAS LOGIC ===
                // === PRESENSI KELAS LOGIC ===
        window.app.loadPresensiData = async () => {
            const tgl = ui.el('presensi-tgl').value;
            const kelas = ui.el('presensi-kelas').value;
            const mapel = ui.el('presensi-mapel').value;
            
            if(!tgl || !kelas || !mapel) return Swal.fire('Pilih Filter', 'Mohon pilih Tanggal, Kelas, dan Mapel.', 'warning');
            
            ui.loading(true, "Memuat Presensi...");
            const tb = ui.el('tbody-presensi');
            tb.innerHTML = '';
            
            // Reset state & buttons
            state.currentPresensiId = null;
            const btnHapus = ui.el('btn-hapus-presensi');
            if(btnHapus) btnHapus.classList.add('hidden');
            
            try {
                // 1. Ambil Data Presensi yang SUDAH TERSIMPAN (Jika ada)
                const qPresensi = query(collection(db, 'data_presensi'), where('tanggal', '==', tgl), where('kelas', '==', kelas), where('mapel', '==', mapel));
                const snapPresensi = await getDocs(qPresensi);
                
                let savedDataMap = {}; // Map UID -> {status, keterangan}
                
                if(!snapPresensi.empty) {
                    state.currentPresensiId = snapPresensi.docs[0].id;
                    if(btnHapus) btnHapus.classList.remove('hidden'); // Show delete button if data exists
                    
                    const docData = snapPresensi.docs[0].data();
                    if(docData.data_absensi && Array.isArray(docData.data_absensi)) {
                        docData.data_absensi.forEach(item => {
                            savedDataMap[item.uid] = { status: item.status, keterangan: item.keterangan };
                        });
                    }
                }

                // 2. Ambil Master Data Siswa Terbaru dari Database User (SELALU UPDATE)
                // Ini PENTING agar siswa baru muncul, dan data master tetap jadi acuan utama.
                const qSiswa = query(collection(db, 'data_pengguna'), where('kelas', '==', kelas));
                const snapSiswa = await getDocs(qSiswa);
                
                let finalSiswaList = [];
                
                snapSiswa.forEach(doc => {
                    const u = doc.data();
                    if((u.role||'').toLowerCase() === 'siswa') {
                        // Cek apakah siswa ini sudah pernah diabsen sebelumnya di tanggal ini?
                        const saved = savedDataMap[doc.id];
                        
                        finalSiswaList.push({
                            uid: doc.id,
                            nama: u.nama,
                            // Jika ada data tersimpan, pakai itu. Jika tidak (siswa baru/belum diabsen), default 'H'
                            status: saved ? saved.status : 'H',
                            keterangan: saved ? saved.keterangan : ''
                        });
                    }
                });

                // Sortir Abjad Nama Siswa
                finalSiswaList.sort((a,b) => a.nama.localeCompare(b.nama));

                if(finalSiswaList.length === 0) {
                    tb.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-slate-400">Tidak ada siswa di kelas ini.</td></tr>';
                    ui.el('wrap-btn-simpan-presensi').classList.add('hidden');
                } else {
                    finalSiswaList.forEach((s, idx) => {
                        const statusOptions = ['H', 'S', 'I', 'A'].map(opt => `<label class="cursor-pointer flex items-center gap-1 bg-slate-100 px-2 py-1 rounded hover:bg-slate-200"><input type="radio" name="status-${s.uid}" value="${opt}" ${s.status === opt ? 'checked' : ''} class="accent-brand-600"> <span class="text-xs font-bold">${opt}</span></label>`).join('');
                        tb.innerHTML += `<tr class="border-b presensi-row" data-uid="${s.uid}" data-nama="${s.nama}"><td class="p-4 text-center">${idx+1}</td><td class="p-4 font-bold text-slate-700">${s.nama}</td><td class="p-4"><div class="flex gap-2 justify-center">${statusOptions}</div></td><td class="p-4"><input type="text" class="border p-2 rounded w-full text-xs ket-input" placeholder="Keterangan..." value="${s.keterangan || ''}"></td></tr>`;
                    });
                    ui.el('wrap-btn-simpan-presensi').classList.remove('hidden');
                }

            } catch(e) { console.error(e); Swal.fire('Error', e.message, 'error'); }
            ui.loading(false);
        };

        window.app.savePresensi = async () => {
            const tgl = ui.el('presensi-tgl').value;
            const kelas = ui.el('presensi-kelas').value;
            const mapel = ui.el('presensi-mapel').value;
            ui.loading(true, "Menyimpan...");
            const rows = document.querySelectorAll('.presensi-row');
            const dataAbsensi = [];
            rows.forEach(row => {
                const uid = row.getAttribute('data-uid');
                const nama = row.getAttribute('data-nama');
                const status = row.querySelector(`input[name="status-${uid}"]:checked`)?.value || 'A';
                const ket = row.querySelector('.ket-input').value;
                dataAbsensi.push({ uid, nama, status, keterangan: ket });
            });
            const payload = { tanggal: tgl, kelas: kelas, mapel: mapel, guru_id: auth.currentUser.uid, guru_nama: state.profile.nama, data_absensi: dataAbsensi, tahun_ajaran: state.schoolConfig.tahun, semester: state.schoolConfig.semester, updated_at: serverTimestamp() };
            try {
                if(state.currentPresensiId) { await updateDoc(doc(db, 'data_presensi', state.currentPresensiId), payload); } else { await addDoc(collection(db, 'data_presensi'), payload); }
                Swal.fire('Berhasil', 'Data Presensi Tersimpan', 'success'); window.app.loadPresensiData();
            } catch(e) { Swal.fire('Gagal', e.message, 'error'); } ui.loading(false);
        };

        window.app.deletePresensi = async () => {
            if(!state.currentPresensiId) return;
            const r = await Swal.fire({ title: 'Reset Presensi?', text: "Data kehadiran tanggal ini akan dihapus permanen.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Reset Data' });
            if(r.isConfirmed) {
                ui.loading(true);
                try {
                    await deleteDoc(doc(db, 'data_presensi', state.currentPresensiId));
                    ui.toast('Data berhasil direset');
                    window.app.loadPresensiData();
                } catch(e) { Swal.fire('Error', e.message, 'error'); }
                ui.loading(false);
            }
        };
        
                // === REKAP ABSENSI LOGIC ===
        window.app.loadRekapAbsensi = async () => {
            const kelas = ui.el('rekap-absen-kelas').value;
            const mapel = ui.el('rekap-absen-mapel').value;
            if(!kelas || !mapel) return Swal.fire('Filter', 'Pilih Kelas dan Mapel.', 'warning');
            
            ui.loading(true, "Merekap Data Absensi...");
            
            const thead = ui.el('rekap-header-row'); 
            const tb = ui.el('tbody-rekap-absen');
            tb.innerHTML = '';
            
            try {
                const summary = {}; 
                const uniqueDates = new Set();

                // Ambil daftar siswa agar yang alpha terus tetap muncul
                const userSnap = await getDocs(query(collection(db, 'data_pengguna'), where('kelas', '==', kelas)));
                userSnap.forEach(d => {
                    const u = d.data();
                    if((u.role||'').toLowerCase() === 'siswa') {
                        summary[d.id] = { 
                            nama: u.nama, 
                            dates: {}, 
                            totals: {H:0, S:0, I:0, A:0, TotalPertemuan:0} 
                        };
                    }
                });

                // Ambil data presensi
                const presensiSnap = await getDocs(query(collection(db, 'data_presensi'), where('kelas', '==', kelas), where('mapel', '==', mapel)));
                
                presensiSnap.forEach(doc => {
                    const p = doc.data();
                    // --- FILTER PERIODE ---
                    const isCurrentPeriod = (p.tahun_ajaran === state.schoolConfig.tahun && p.semester === state.schoolConfig.semester);
                    const isLegacy = !p.tahun_ajaran; // Data lama dianggap masuk
                    
                    if(!(isCurrentPeriod || isLegacy)) return; // Skip
                    // ----------------------
                    const tgl = p.tanggal; 
                    uniqueDates.add(tgl);

                    if(p.data_absensi) {
                        p.data_absensi.forEach(s => {
                            if(summary[s.uid]) {
                                summary[s.uid].dates[tgl] = s.status;
                                summary[s.uid].totals[s.status]++;
                                summary[s.uid].totals.TotalPertemuan++;
                            }
                        });
                    }
                });

                const sortedDates = Array.from(uniqueDates).sort(); 
                const sortedStudents = Object.values(summary).sort((a,b) => a.nama.localeCompare(b.nama));
                
                // Simpan struktur baru untuk export
                state.currentRekapAbsen = { students: sortedStudents, dates: sortedDates }; 

                // Render Header Dinamis
                if(thead) {
                    let htmlHeader = `
                        <th class="p-4 w-10 text-center sticky left-0 bg-slate-50 border-r z-10">No</th>
                        <th class="p-4 min-w-[200px] sticky left-10 bg-slate-50 border-r z-10">Nama Siswa</th>
                    `;

                    sortedDates.forEach(dateStr => {
                        const dObj = new Date(dateStr);
                        const label = `${dObj.getDate()}/${dObj.getMonth()+1}`;
                        htmlHeader += `<th class="p-2 text-center text-[10px] w-10 border-r bg-white min-w-[40px]">${label}</th>`;
                    });

                    htmlHeader += `
                        <th class="p-4 text-center text-green-700 bg-green-50 w-10">H</th>
                        <th class="p-4 text-center text-blue-700 bg-blue-50 w-10">S</th>
                        <th class="p-4 text-center text-yellow-700 bg-yellow-50 w-10">I</th>
                        <th class="p-4 text-center text-red-700 bg-red-50 w-10">A</th>
                        <th class="p-4 text-center text-slate-700 bg-slate-100 w-16">%</th>
                    `;
                    
                    thead.innerHTML = htmlHeader;
                }

                if(sortedStudents.length === 0) {
                    const colSpan = 2 + sortedDates.length + 5;
                    tb.innerHTML = `<tr><td colspan="${colSpan}" class="p-10 text-center text-slate-400">Tidak ada data.</td></tr>`;
                } else {
                    sortedStudents.forEach((s, idx) => {
                        const tot = s.totals;
                        const percent = tot.TotalPertemuan > 0 ? Math.round((tot.H / tot.TotalPertemuan) * 100) : 0;
                        
                        let dateCols = '';
                        sortedDates.forEach(d => {
                            const st = s.dates[d] || '-'; 
                            let colorClass = 'text-slate-300'; 
                            
                            if(st === 'H') colorClass = 'text-green-600 font-bold bg-green-50';
                            else if(st === 'S') colorClass = 'text-blue-600 font-bold bg-blue-50';
                            else if(st === 'I') colorClass = 'text-yellow-600 font-bold bg-yellow-50';
                            else if(st === 'A') colorClass = 'text-red-600 font-bold bg-red-50';
                            
                            dateCols += `<td class="p-2 text-center border-r text-xs ${st !== '-' ? colorClass : ''}">${st}</td>`;
                        });

                        tb.innerHTML += `
                        <tr class="border-b hover:bg-slate-50">
                            <td class="p-4 text-center sticky left-0 bg-white border-r">${idx+1}</td>
                            <td class="p-4 font-bold text-slate-700 sticky left-10 bg-white border-r">${s.nama}</td>
                            ${dateCols}
                            <td class="p-4 text-center font-bold text-green-600 bg-green-50/30">${tot.H}</td>
                            <td class="p-4 text-center font-bold text-blue-600 bg-blue-50/30">${tot.S}</td>
                            <td class="p-4 text-center font-bold text-yellow-600 bg-yellow-50/30">${tot.I}</td>
                            <td class="p-4 text-center font-bold text-red-600 bg-red-50/30">${tot.A}</td>
                            <td class="p-4 text-center font-bold text-slate-700 bg-slate-100/50">${percent}%</td>
                        </tr>`;
                    });
                }
            } catch(e) { console.error(e); } ui.loading(false);
        };
        
        window.app.exportRekapAbsensi = () => {
             const data = state.currentRekapAbsen;
             if(!data) return Swal.fire('Data Kosong', 'Tampilkan rekap terlebih dahulu', 'info');
             
             let students = [];
             let dates = [];

             if (Array.isArray(data)) {
                 students = data;
             } else if (data.students && data.dates) {
                 students = data.students;
                 dates = data.dates;
             } else {
                 return Swal.fire('Data Kosong', 'Tampilkan rekap terlebih dahulu', 'info');
             }
             
             if(students.length === 0) return Swal.fire('Data Kosong', 'Tidak ada data siswa', 'info');

             const dataExport = students.map(s => {
                 const row = { Nama: s.nama };
                 if (s.dates) {
                     const dateKeys = dates.length > 0 ? dates : Object.keys(s.dates).sort();
                     dateKeys.forEach(d => {
                         row[d] = s.dates[d] || '-';
                     });
                 }
                 if (s.totals) {
                    row['Hadir'] = s.totals.H;
                    row['Sakit'] = s.totals.S;
                    row['Izin'] = s.totals.I;
                    row['Alpha'] = s.totals.A;
                    row['Pertemuan'] = s.totals.TotalPertemuan;
                    row['Persentase'] = (s.totals.TotalPertemuan > 0 ? Math.round((s.totals.H / s.totals.TotalPertemuan)*100) : 0) + '%';
                 }
                 return row;
             });

             const ws = XLSX.utils.json_to_sheet(dataExport);
             const wb = XLSX.utils.book_new();
             XLSX.utils.book_append_sheet(wb, ws, "Rekap Absensi");
             XLSX.writeFile(wb, "Rekap_Absensi.xlsx");
        };

                // === AGENDA GURU LOGIC (UPDATED TABLE & EXPORT) ===
        
        window.app.loadAgenda = async () => {
             // 1. Pastikan tombol Isi Jurnal memanggil fungsi yang benar
             const btnIsi = Array.from(document.querySelectorAll('button')).find(b => b.innerText && b.innerText.includes('Isi Jurnal'));
             if(btnIsi) btnIsi.onclick = () => window.app.openModalAgenda();

             const fKelas = ui.el('filter-agenda-kelas').value;
             const tb = ui.el('tbody-agenda');
             
             ui.loading(true, "Memuat Jurnal...");
             tb.innerHTML = '';
             state.currentAgendaData = [];

             try {
                 let q;
                 if(state.profile.role === 'admin') {
                     q = collection(db, 'data_agenda_guru');
                 } else {
                     q = query(collection(db, 'data_agenda_guru'), where('guru_id', '==', auth.currentUser.uid));
                 }

                 const snap = await getDocs(q);
                 
                 if(snap.empty) { 
                     tb.innerHTML = '<tr><td colspan="7" class="text-center text-slate-400 p-6">Belum ada jurnal.</td></tr>'; 
                     ui.loading(false);
                     return; 
                 }
                 
                 let docs = [];
                 snap.forEach(d => {
                     const data = d.data();
                     const isCurrentPeriod = (data.tahun_ajaran === state.schoolConfig.tahun && data.semester === state.schoolConfig.semester);
                     const isLegacy = !data.tahun_ajaran;
                     
                     if(isCurrentPeriod || isLegacy) docs.push({id: d.id, ...data});
                 });

                 // Sort by date desc
                 docs.sort((a,b) => {
                     const dateA = new Date(a.created_at ? a.created_at.seconds * 1000 : 0);
                     const dateB = new Date(b.created_at ? b.created_at.seconds * 1000 : 0);
                     return dateB - dateA;
                 });

                 if(fKelas) docs = docs.filter(d => d.kelas === fKelas);
                 state.currentAgendaData = docs;

                 if(docs.length === 0) {
                     tb.innerHTML = '<tr><td colspan="7" class="text-center text-slate-400 p-6">Tidak ada jurnal untuk kelas ini.</td></tr>'; 
                 } else {
                     docs.forEach(ag => {
                         const sum = ag.attendance_summary || {H:0,S:0,I:0,A:0};
                         const buktiHtml = ag.foto ? `<button onclick="Swal.fire({imageUrl: '${ag.foto}', showConfirmButton: false})" class="text-blue-600 hover:text-blue-800"><i class="fa-solid fa-image"></i> Foto</button>` : (ag.link ? `<a href="${ag.link}" target="_blank" class="text-blue-600 hover:text-blue-800"><i class="fa-solid fa-link"></i> Link</a>` : '-');
                         
                         tb.innerHTML += `
                         <tr class="border-b hover:bg-slate-50">
                            <td class="p-4 text-sm whitespace-nowrap">${ag.tanggal}</td>
                            <td class="p-4 font-bold text-slate-700">${ag.kelas}</td>
                            <td class="p-4 text-sm">${ag.mapel} <span class="bg-slate-100 text-xs px-1 rounded ml-1">Jam: ${ag.jam_ke}</span></td>
                            <td class="p-4 text-xs">
                                <b>Materi:</b> ${ag.materi}<br>
                                ${ag.tugas ? `<b>Tugas:</b> ${ag.tugas}` : ''}
                            </td>
                            <td class="p-4 text-center text-xs font-mono">
                                <span class="text-green-600 font-bold">H:${sum.H}</span> <span class="text-blue-600">S:${sum.S}</span> <span class="text-yellow-600">I:${sum.I}</span> <span class="text-red-600">A:${sum.A}</span>
                            </td>
                            <td class="p-4 text-center text-xs font-bold">
                                ${buktiHtml}
                            </td>
                            <td class="p-4 text-right flex justify-end gap-2">
                                <button onclick="window.app.editAgenda('${ag.id}')" class="text-blue-500 hover:bg-blue-50 p-2 rounded-lg transition" title="Edit Jurnal"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="window.app.deleteAgenda('${ag.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded-lg transition" title="Hapus Jurnal"><i class="fa-solid fa-trash"></i></button>
                            </td>
                         </tr>`;
                     });
                 }
             } catch(e) { console.error(e); tb.innerHTML='<tr><td colspan="7" class="text-center text-red-500 p-6">Error loading agenda.</td></tr>'; }
             ui.loading(false);
        };
        
        window.app.exportAgenda = () => {
             if(!state.currentAgendaData || state.currentAgendaData.length === 0) return Swal.fire('Data Kosong', 'Tampilkan data jurnal terlebih dahulu', 'info');
             const dataExport = state.currentAgendaData.map(d => ({
                 Tanggal: d.tanggal, Kelas: d.kelas, Mapel: d.mapel, Jam_Ke: d.jam_ke,
                 Materi: d.materi, Tugas: d.tugas,
                 Hadir: d.attendance_summary?.H||0, Sakit: d.attendance_summary?.S||0, Izin: d.attendance_summary?.I||0, Alpha: d.attendance_summary?.A||0,
                 Guru: d.guru_nama
             }));
             const ws = XLSX.utils.json_to_sheet(dataExport);
             const wb = XLSX.utils.book_new();
             XLSX.utils.book_append_sheet(wb, ws, "Jurnal Mengajar");
             XLSX.writeFile(wb, "Jurnal_Mengajar.xlsx");
        };

        window.app.openModalAgenda = () => { 
            // FIX ERROR: Buat hidden input ID secara otomatis jika belum ada di HTML
            if(!document.getElementById('ag-id')) {
                const h = document.createElement('input'); 
                h.type='hidden'; 
                h.id='ag-id';
                ui.el('form-agenda').appendChild(h);
            }
            if(!document.getElementById('ag-attendance-summary')) {
                 const s = document.createElement('div'); s.id='ag-attendance-summary'; s.className='mt-2 text-xs font-mono';
                 const ref = ui.el('ag-jam')?.parentElement;
                 if(ref) ref.appendChild(s);
            }

            ui.el('form-agenda').reset(); 
            ui.el('ag-id').value = ''; // Reset ID (Mode Tambah)
            state.tempAgendaSumm = null; 
            
            ui.el('ag-attendance-summary').innerHTML = '<span class="text-slate-400">Kehadiran: (Pilih Kelas & Mapel)</span>'; 
            if(ui.el('ag-foto-preview')) ui.el('ag-foto-preview').style.backgroundImage=''; 
            ui.el('ag-foto-base64').value=''; 
            ui.el('ag-tgl').valueAsDate = new Date(); 
            
            // Populate Dropdowns
            const elKelas = document.getElementById('ag-kelas');
            if(window.app.generateClassOptions) elKelas.innerHTML = window.app.generateClassOptions(false);
            
            const elMapel = document.getElementById('ag-mapel'); 
            elMapel.innerHTML='<option value="">-- Pilih --</option>'; 
            STANDARD_MAPEL_LIST.forEach(m => elMapel.innerHTML += `<option value="${m}">${m}</option>`); 
            
            ui.show('modal-agenda'); 
        };
        
        window.app.editAgenda = async (id) => {
            ui.loading(true, "Memuat Jurnal...");
            try {
                const docSnap = await getDoc(doc(db, 'data_agenda_guru', id));
                if(!docSnap.exists()) throw "Data tidak ditemukan";
                const d = docSnap.data();
                
                // Init modal dulu (biar elemen ag-id terbentuk)
                window.app.openModalAgenda();
                
                // Isi Form
                ui.el('ag-id').value = id; // Sekarang aman karena elemen pasti ada
                ui.el('ag-tgl').value = d.tanggal;
                ui.el('ag-kelas').value = d.kelas;
                ui.el('ag-mapel').value = d.mapel;
                ui.el('ag-jam').value = d.jam_ke;
                ui.el('ag-materi').value = d.materi;
                ui.el('ag-tugas').value = d.tugas || '';
                ui.el('ag-link').value = d.link || '';
                
                if(d.foto) {
                    ui.el('ag-foto-base64').value = d.foto;
                    if(ui.el('ag-foto-preview')) ui.el('ag-foto-preview').style.backgroundImage = `url(${d.foto})`;
                }
                const sum = d.attendance_summary || {H:0, S:0, I:0, A:0};
                ui.el('ag-attendance-summary').innerHTML = `<span class="text-green-600 font-bold">H: ${sum.H}</span> <span class="text-blue-600">S: ${sum.S}</span> <span class="text-yellow-600">I: ${sum.I}</span> <span class="text-red-600 font-bold">A: ${sum.A}</span>`;
                state.tempAgendaSumm = sum;
            } catch(e) { 
                console.error(e); 
                Swal.fire('Error', 'Gagal memuat data edit: ' + e.message, 'error'); 
            }
            ui.loading(false);
        };

        window.app.deleteAgenda = async (id) => {
            const r = await Swal.fire({ title: 'Hapus Jurnal?', text: "Data akan dihapus permanen.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hapus' });
            if (r.isConfirmed) {
                ui.loading(true);
                try {
                    await deleteDoc(doc(db, 'data_agenda_guru', id));
                    ui.toast('Jurnal Dihapus');
                    window.app.loadAgenda();
                } catch (e) { Swal.fire('Error', e.message, 'error'); }
                ui.loading(false);
            }
        };

        window.app.calculateAbsensiForAgenda = async () => {
            const tgl = ui.el('ag-tgl').value;
            const kelas = ui.el('ag-kelas').value;
            const mapel = ui.el('ag-mapel').value;
            const summEl = ui.el('ag-attendance-summary');
            
            if(tgl && kelas && mapel) {
                summEl.innerHTML = '<span class="animate-pulse">Cek Presensi...</span>';
                try {
                    const snap = await getDocs(query(collection(db, 'data_presensi'), where('tanggal', '==', tgl), where('kelas', '==', kelas), where('mapel', '==', mapel)));
                    if(!snap.empty) {
                        const d = snap.docs[0].data();
                        let h=0, s=0, i=0, a=0;
                        d.data_absensi.forEach(x => { if(x.status==='H') h++; else if(x.status==='S') s++; else if(x.status==='I') i++; else a++; });
                        summEl.innerHTML = `<span class="text-green-600 font-bold">H: ${h}</span> <span class="text-blue-600">S: ${s}</span> <span class="text-yellow-600">I: ${i}</span> <span class="text-red-600 font-bold">A: ${a}</span>`;
                        state.tempAgendaSumm = {H:h, S:s, I:i, A:a};
                    } else {
                        summEl.innerHTML = '<span class="text-slate-400 italic">Data presensi belum diisi. (Default 0)</span>';
                        state.tempAgendaSumm = null; 
                    }
                } catch(e) { console.error(e); }
            }
        };

        window.app.handleAgendaFoto = (input) => {
             if(input.files && input.files[0]) {
                 const reader = new FileReader();
                 reader.onload = (e) => {
                     const img = new Image(); img.src = e.target.result;
                     img.onload = () => {
                         const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                         const MAX_WIDTH = 800; const scale = MAX_WIDTH / img.width;
                         canvas.width = MAX_WIDTH; canvas.height = img.height * scale;
                         ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                         const compressed = canvas.toDataURL('image/jpeg', 0.7);
                         ui.el('ag-foto-base64').value = compressed;
                         if(ui.el('ag-foto-preview')) ui.el('ag-foto-preview').style.backgroundImage = `url(${compressed})`;
                     };
                 };
                 reader.readAsDataURL(input.files[0]);
             }
        };

        window.app.saveAgenda = async () => {
             ui.loading(true);
             
             // 1. Ambil ID dari hidden input
             const elId = document.getElementById('ag-id');
             const editId = elId ? elId.value : '';
             
             const d = {
                 tanggal: ui.el('ag-tgl').value,
                 kelas: ui.el('ag-kelas').value,
                 mapel: ui.el('ag-mapel').value,
                 jam_ke: ui.el('ag-jam').value,
                 materi: ui.el('ag-materi').value,
                 tugas: ui.el('ag-tugas').value,
                 link: ui.el('ag-link').value,
                 foto: ui.el('ag-foto-base64').value,
                 attendance_summary: state.tempAgendaSumm || {H:0,S:0,I:0,A:0},
                 guru_id: auth.currentUser.uid,
                 guru_nama: state.profile?.nama || 'Guru',
                 tahun_ajaran: state.schoolConfig?.tahun || '2025/2026',
                 semester: state.schoolConfig?.semester || 'Ganjil'
             };
             
             try {
                 if(editId) {
                     // === LOGIKA EDIT (UPDATE) ===
                     d.updated_at = serverTimestamp();
                     await updateDoc(doc(db, 'data_agenda_guru', editId), d);
                     ui.toast('Jurnal Berhasil Diperbarui');
                 } else {
                     // === LOGIKA BARU (CREATE) ===
                     d.created_at = serverTimestamp();
                     await addDoc(collection(db, 'data_agenda_guru'), d);
                     ui.toast('Jurnal Berhasil Disimpan');
                 }

                 window.app.closeModal('modal-agenda');
                 window.app.loadAgenda();
             } catch(e) { 
                 console.error(e);
                 Swal.fire('Gagal Menyimpan', e.message, 'error'); 
             }
             ui.loading(false);
        };

        // === NILAI HARIAN & ACTIVITY POINTS LOGIC ===
        window.app.switchNilaiHarianTab = (tab) => {
            document.getElementById('view-nh-input').classList.add('hidden');
            document.getElementById('view-nh-activity').classList.add('hidden');
            document.getElementById('tab-btn-input').className = "px-6 py-3 font-bold text-sm text-slate-500 hover:text-slate-700 transition";
            document.getElementById('tab-btn-activity').className = "px-6 py-3 font-bold text-sm text-slate-500 hover:text-slate-700 transition";

            if(tab === 'input') {
                document.getElementById('view-nh-input').classList.remove('hidden');
                document.getElementById('tab-btn-input').className = "px-6 py-3 font-bold text-sm text-brand-600 border-b-2 border-brand-600 transition";
            } else {
                document.getElementById('view-nh-activity').classList.remove('hidden');
                document.getElementById('tab-btn-activity').className = "px-6 py-3 font-bold text-sm text-brand-600 border-b-2 border-brand-600 transition";
            }
        };

        window.app.loadSiswaForInput = async () => {
            const kelas = ui.el('nh-kelas').value;
            window.app.loadBankNilai(kelas); 
            const container = ui.el('nh-siswa-container');
            const list = ui.el('nh-list-siswa');
            
            if(!kelas) { container.classList.add('hidden'); return; }
            
            ui.loading(true, "Memuat Siswa...");
            list.innerHTML = '';
            
            try {
                const q = query(collection(db, 'data_pengguna'), where('kelas', '==', kelas));
                const snap = await getDocs(q);
                let students = [];
                snap.forEach(d => {
                    const u = d.data();
                    if((u.role||'').toLowerCase() === 'siswa') {
                        students.push({id: d.id, nama: u.nama});
                    }
                });
                
                students.sort((a,b) => a.nama.localeCompare(b.nama));
                
                if(students.length === 0) {
                    list.innerHTML = '<p class="text-slate-400 col-span-2 text-center">Tidak ada siswa.</p>';
                } else {
                    students.forEach(s => {
                        list.innerHTML += `
                        <div class="flex items-center justify-between bg-white p-3 rounded-lg border border-slate-200">
                            <span class="text-sm font-bold text-slate-700 truncate w-2/3" title="${s.nama}">${s.nama}</span>
                            <input type="number" name="nilai-${s.id}" class="w-20 border p-2 rounded text-center text-sm font-bold focus:ring-2 focus:ring-brand-500 outline-none nh-score-input" placeholder="0">
                        </div>`;
                    });
                }
                container.classList.remove('hidden');
            } catch(e) { console.error(e); }
            ui.loading(false);
        };

        window.app.saveNilaiHarian = async () => {
            const inputs = document.querySelectorAll('.nh-score-input');
            const detailNilai = [];
            const editId = ui.el('nh-id').value; // Cek ID Edit
            
            // Ambil Poin Maksimal dari Form, default 100 jika kosong/nol
            const poinMaks = Number(ui.el('nh-max').value) || 100;

            inputs.forEach(inp => {
                if(inp.value !== '') { // Fix: izinkan nilai 0
                    const uid = inp.name.replace('nilai-', '');
                    const poinAsli = Number(inp.value);
                    
                    // RUMUS KONVERSI: (Poin Asli / Poin Maks) * 100
                    let nilaiSkala100 = Math.round((poinAsli / poinMaks) * 100);
                    
                    // Batasi agar tidak lebih dari 100 (opsional, tapi aman)
                    if (nilaiSkala100 > 100) nilaiSkala100 = 100;

                    detailNilai.push({ 
                        uid: uid,
                        nama: siswa.nama || '-',
                        nilai: poinAsli,       // Simpan Poin Asli (misal 12)
                        nilai_skala: nilaiSkala100 // Simpan Nilai Rapor (misal 80)
                    });
                }
            });

            if(detailNilai.length === 0) return Swal.fire('Kosong', 'Belum ada nilai yang diinput', 'warning');

            const payload = {
                kelas: ui.el('nh-kelas').value,
                mapel: ui.el('nh-mapel').value,
                tanggal: ui.el('nh-tgl').value,
                jenis_tugas: ui.el('nh-jenis').value,
                materi: ui.el('nh-materi').value,
                poin_maks: poinMaks, // Penting disimpan
                guru_id: auth.currentUser.uid,
                detail_nilai: detailNilai,
                tahun_ajaran: state.schoolConfig.tahun,
                semester: state.schoolConfig.semester,
                // timestamp: serverTimestamp() // Hapus ini agar timestamp create tidak tertimpa saat edit
            };

            ui.loading(true);
            try {
                if (editId) {
                    // === MODE UPDATE ===
                    payload.updated_at = serverTimestamp();
                    await updateDoc(doc(db, 'data_nilai_harian', editId), payload);
                    Swal.fire('Sukses', 'Data Nilai Berhasil Diperbarui', 'success');
                    ui.el('nh-id').value = ''; // Reset ID
                } else {
                    // === MODE SIMPAN BARU ===
                    payload.timestamp = serverTimestamp();
                    await addDoc(collection(db, 'data_nilai_harian'), payload);
                    Swal.fire('Sukses', 'Nilai Harian Tersimpan', 'success');
                }

                // Refresh Tabel & Reset Form
                window.app.loadBankNilai(ui.el('nh-kelas').value);
                
                // Reset field form (kecuali kelas/mapel biar ga capek milih lagi)
                ui.el('nh-jenis').value = ''; 
                ui.el('nh-materi').value = '';
                // Jangan reset Poin Maks biar guru ga perlu isi lagi kalau sama
                inputs.forEach(i => i.value = '');
                
            } catch(e) { 
                Swal.fire('Error', e.message, 'error'); 
            }
            ui.loading(false);
        };
        // === FUNGSI EDIT NILAI HARIAN ===
        window.app.editNilaiHarian = async (id) => {
            ui.loading(true, "Memuat data...");
            try {
                // 1. Ambil data dari database
                const docSnap = await getDoc(doc(db, 'data_nilai_harian', id));
                if (!docSnap.exists()) throw "Data tidak ditemukan";
                const data = docSnap.data();

                // 2. Isi Form Utama
                ui.el('nh-id').value = id; // Simpan ID
                ui.el('nh-kelas').value = data.kelas;
                ui.el('nh-mapel').value = data.mapel;
                ui.el('nh-tgl').value = data.tanggal;
                ui.el('nh-jenis').value = data.jenis_tugas;
                ui.el('nh-materi').value = data.materi;
                ui.el('nh-max').value = data.poin_maks;

                // 3. Load Siswa (Tunggu sampai selesai render HTML)
                await window.app.loadSiswaForInput();

                // 4. Isi Nilai per Siswa (Tunggu sebentar agar elemen input ter-render)
                setTimeout(() => {
                    if (data.detail_nilai && Array.isArray(data.detail_nilai)) {
                        data.detail_nilai.forEach(item => {
                            // Cari input berdasarkan UID siswa
                            const inputSiswa = document.querySelector(`input[name="nilai-${item.uid}"]`);
                            if (inputSiswa) {
                                inputSiswa.value = item.nilai;
                            }
                        });
                    }
                }, 500); // Delay sedikit untuk memastikan DOM siap

                // 5. Scroll ke atas
                document.getElementById('view-nh-input').scrollIntoView({ behavior: 'smooth' });
                
            } catch (e) {
                console.error(e);
                Swal.fire('Error', 'Gagal memuat data edit', 'error');
            }
            ui.loading(false);
        };
        // === UPDATED LOAD BANK NILAI (FILTER PERIODE) ===
        window.app.loadBankNilai = async (kelas) => {
            const section = document.getElementById('nh-bank-section');
            const title = document.getElementById('nh-bank-title');
            const tbody = document.getElementById('nh-bank-body');
            const emptyMsg = document.getElementById('nh-bank-empty');

            if (!kelas) { section.classList.add('hidden'); return; }

            section.classList.remove('hidden');
            title.innerText = kelas;
            tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center"><div class="loader mx-auto"></div></td></tr>';

            try {
                const q = query(collection(db, 'data_nilai_harian'), where('kelas', '==', kelas));
                const snap = await getDocs(q);
                
                tbody.innerHTML = '';
                
                let docs = [];
                snap.forEach(d => {
                    const data = d.data();
                    // --- FILTER PERIODE ---
                    const isCurrentPeriod = (data.tahun_ajaran === state.schoolConfig.tahun && data.semester === state.schoolConfig.semester);
                    const isLegacy = !data.tahun_ajaran; 

                    if(isCurrentPeriod || isLegacy) {
                        docs.push({ id: d.id, ...data });
                    }
                });

                if (docs.length === 0) {
                    tbody.innerHTML = ''; // Clear loader
                    emptyMsg.classList.remove('hidden');
                } else {
                    emptyMsg.classList.add('hidden');
                    // Sort Terbaru
                    docs.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

                    docs.forEach(d => {
                        let total = 0;
                        d.detail_nilai.forEach(s => total += s.nilai);
                        const avg = d.detail_nilai.length ? Math.round(total / d.detail_nilai.length) : 0;

                        tbody.innerHTML += `
                        <tr class="hover:bg-slate-50 transition">
                            <td class="p-4 font-mono text-xs">${d.tanggal}</td>
                            <td class="p-4 font-bold text-slate-700">${d.jenis_tugas}</td>
                            <td class="p-4 text-xs">${d.mapel}</td>
                            <td class="p-4 text-xs">${d.materi}</td>
                            <td class="p-4 text-center font-bold text-brand-600">${avg}</td>
                            <td class="p-4 text-right flex justify-end gap-2">
                                <button onclick="window.app.editNilaiHarian('${d.id}')" class="text-blue-500 hover:bg-blue-50 p-2 rounded-lg transition" title="Edit Data"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="window.app.deleteNilaiHarian('${d.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded-lg transition" title="Hapus Tugas"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>`;
                    });
                }
            } catch (e) { console.error(e); tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-500">Gagal memuat data.</td></tr>'; }
        };

        // === FUNGSI HAPUS NILAI HARIAN ===
        window.app.deleteNilaiHarian = async (id) => {
            const r = await Swal.fire({
                title: 'Hapus Data Nilai?',
                text: "Data nilai satu kelas untuk tugas ini akan dihapus permanen.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Ya, Hapus'
            });

            if (r.isConfirmed) {
                ui.loading(true);
                try {
                    await deleteDoc(doc(db, 'data_nilai_harian', id));
                    ui.toast('Data terhapus');
                    // Refresh tabel
                    const curKelas = document.getElementById('nh-kelas').value;
                    window.app.loadBankNilai(curKelas);
                } catch (e) {
                    Swal.fire('Error', e.message, 'error');
                }
                ui.loading(false);
            }
        };

        window.app.loadActivityPoints = async () => {
            const kelas = ui.el('nh-activity-kelas').value;
            const list = ui.el('nh-activity-list');
            if(!kelas) return;

            ui.loading(true);
            list.innerHTML = '';
            
            try {
                const q = query(collection(db, 'data_pengguna'), where('kelas', '==', kelas));
                const snap = await getDocs(q);
                let students = [];
                snap.forEach(d => {
                    const u = d.data();
                    if((u.role||'').toLowerCase() === 'siswa') {
                        students.push({id: d.id, nama: u.nama, points: u.poin_keaktifan || 0});
                    }
                });
                
                students.sort((a,b) => a.nama.localeCompare(b.nama));
                
                students.forEach(s => {
                    list.innerHTML += `
                    <div class="flex items-center justify-between bg-white p-3 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition">
                        <div>
                            <p class="font-bold text-slate-700 text-sm">${s.nama}</p>
                            <p class="text-xs text-slate-400">Total Poin: <span id="point-display-${s.id}" class="font-bold text-brand-600 text-lg ml-1">${s.points}</span></p>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="window.app.updateActivityPoint('${s.id}', 2)" class="bg-green-100 text-green-700 px-3 py-1 rounded-lg text-xs font-bold hover:bg-green-200">+2</button>
                            <button onclick="window.app.updateActivityPoint('${s.id}', 3)" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-lg text-xs font-bold hover:bg-blue-200">+3</button>
                            <button onclick="window.app.updateActivityPoint('${s.id}', 5)" class="bg-purple-100 text-purple-700 px-3 py-1 rounded-lg text-xs font-bold hover:bg-purple-200">+5</button>
                            <button onclick="window.app.updateActivityPoint('${s.id}', -1)" class="bg-red-100 text-red-700 px-3 py-1 rounded-lg text-xs font-bold hover:bg-red-200">-1</button>
                        </div>
                    </div>`;
                });
            } catch(e) { console.error(e); }
            ui.loading(false);
        };

        window.app.updateActivityPoint = async (uid, val) => {
            try {
                const userRef = doc(db, 'data_pengguna', uid);
                // Get current points first to ensure accuracy
                const snap = await getDoc(userRef);
                const current = snap.data().poin_keaktifan || 0;
                const newTotal = current + val;
                
                await updateDoc(userRef, { poin_keaktifan: newTotal });
                
                // Update UI directly without reload
                const display = document.getElementById(`point-display-${uid}`);
                if(display) {
                    display.innerText = newTotal;
                    display.classList.add('scale-125', 'text-green-500'); // simple animation
                    setTimeout(() => display.classList.remove('scale-125', 'text-green-500'), 300);
                }
                ui.toast('Poin diperbarui');
            } catch(e) { Swal.fire('Error', 'Gagal update poin', 'error'); }
        };

        document.addEventListener("DOMContentLoaded", () => {
            const roleSelect = document.getElementById("user-role");
            const kelasSelect = document.getElementById("user-kelas");
            const wrapMapel = document.getElementById("wrap-mapel");
            const wrapNip = document.getElementById("wrap-nip");
            if (!roleSelect) return; 
            const handleRoleChange = () => {
                const role = roleSelect.value;
                if (role === "guru") { wrapMapel.classList.remove("hidden"); wrapNip.classList.remove("hidden"); kelasSelect.parentElement.classList.add("hidden"); } 
                else if (role === "siswa") { kelasSelect.parentElement.classList.remove("hidden"); wrapMapel.classList.add("hidden"); wrapNip.classList.add("hidden"); } 
                else { kelasSelect.parentElement.classList.add("hidden"); wrapMapel.classList.add("hidden"); wrapNip.classList.add("hidden"); }
            };
            roleSelect.addEventListener("change", handleRoleChange);
            handleRoleChange();
        });
        // === JADWAL PELAJARAN LOGIC ===

        // 1. CONFIGURATION (Atur Jam Masuk/Keluar)
        window.app.openModalConfigKBM = async () => {
            ui.loading(true);
            try {
                // Load existing config
                const docSnap = await getDoc(doc(db, 'config_waktu_kbm', 'default'));
                const data = docSnap.exists() ? docSnap.data() : { jumlah_jam: 10, slots: [] };
                
                ui.el('cfg-jml-jam').value = data.jumlah_jam;
                state.tempSlots = data.slots || [];
                window.app.renderConfigInputs();
                ui.show('modal-config-kbm');
            } catch(e) { console.error(e); }
            ui.loading(false);
        };

        window.app.renderConfigInputs = () => {
            const count = Number(ui.el('cfg-jml-jam').value);
            const c = ui.el('cfg-slots-container');
            c.innerHTML = '';
            
            for(let i=1; i<=count; i++) {
                // Ambil nilai lama jika ada
                const saved = state.tempSlots.find(s => s.jam === i) || { mulai: '07:00', selesai: '07:45' };
                c.innerHTML += `
                <div class="flex items-center gap-2 bg-slate-50 p-2 rounded border">
                    <span class="w-8 font-bold text-center text-slate-500">${i}</span>
                    <input type="time" class="border rounded px-2 py-1 text-sm cfg-start" data-id="${i}" value="${saved.mulai}">
                    <span class="text-slate-400">-</span>
                    <input type="time" class="border rounded px-2 py-1 text-sm cfg-end" data-id="${i}" value="${saved.selesai}">
                </div>`;
            }
        };

        window.app.saveConfigKBM = async () => {
            ui.loading(true);
            const count = Number(ui.el('cfg-jml-jam').value);
            const slots = [];
            const starts = document.querySelectorAll('.cfg-start');
            const ends = document.querySelectorAll('.cfg-end');
            
            starts.forEach((el, idx) => {
                slots.push({
                    jam: idx + 1,
                    mulai: el.value,
                    selesai: ends[idx].value
                });
            });

            try {
                await setDoc(doc(db, 'config_waktu_kbm', 'default'), { jumlah_jam: count, slots: slots });
                ui.toast('Konfigurasi Waktu Disimpan');
                window.app.closeModal('modal-config-kbm');
                // Refresh grid jika sedang terbuka
                if(!ui.el('page-atur-jadwal').classList.contains('hidden-section')) window.app.loadJadwalGrid();
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
            ui.loading(false);
        };

        // 2. JADWAL GRID (ADMIN VIEW)
        window.app.loadJadwalGrid = async () => {
            const hari = ui.el('jadwal-hari').value;
            const kelas = ui.el('jadwal-kelas').value;
            const tb = ui.el('tbody-jadwal');
            
            if(!kelas) return;

            ui.loading(true, "Memuat Jadwal...");
            tb.innerHTML = '';

            try {
                // Get Config Waktu
                const cfgSnap = await getDoc(doc(db, 'config_waktu_kbm', 'default'));
                const config = cfgSnap.exists() ? cfgSnap.data() : { jumlah_jam: 10, slots: [] };
                
                // Get Existing Jadwal Data
                const q = query(collection(db, 'data_jadwal_pelajaran'), 
                    where('kelas', '==', kelas), 
                    where('hari', '==', hari)
                );
                const schedSnap = await getDocs(q);
                const schedules = {};
                schedSnap.forEach(d => { schedules[d.data().jam_ke] = { id: d.id, ...d.data() }; });

                // Render Rows
                for(let i=1; i<=config.jumlah_jam; i++) {
                    const time = config.slots.find(s => s.jam === i) || { mulai: '--:--', selesai: '--:--' };
                    const data = schedules[i];
                    
                    let contentCell = '<span class="text-slate-400 italic text-xs">Kosong</span>';
                    let btnAction = `<button onclick="window.app.openEditJadwal(${i}, '${time.mulai} - ${time.selesai}')" class="bg-brand-50 text-brand-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-brand-100">Isi</button>`;

                    if(data) {
                        contentCell = `
                        <div>
                            <div class="font-bold text-brand-700">${data.mapel}</div>
                            <div class="text-xs text-slate-500"><i class="fa-solid fa-user-tie mr-1"></i> ${data.guru_nama}</div>
                        </div>`;
                        btnAction = `<button onclick="window.app.openEditJadwal(${i}, '${time.mulai} - ${time.selesai}', '${data.id}')" class="bg-slate-100 text-slate-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-slate-200">Edit</button>`;
                    }

                    tb.innerHTML += `
                    <tr class="border-b hover:bg-slate-50">
                        <td class="p-4 text-center font-bold text-slate-500">${i}</td>
                        <td class="p-4 text-xs font-mono">${time.mulai} - ${time.selesai}</td>
                        <td class="p-4">${contentCell}</td>
                        <td class="p-4 text-right">${btnAction}</td>
                    </tr>`;
                }

            } catch(e) { console.error(e); }
            ui.loading(false);
        };

        window.app.openEditJadwal = async (jam, waktu, id=null) => {
            ui.el('ej-jam').value = jam;
            state.editingJadwalId = id; // Store ID globally/state
            
            const hari = ui.el('jadwal-hari').value;
            const kelas = ui.el('jadwal-kelas').value;

            ui.el('ej-info').innerText = `${hari}, Jam ke-${jam} (${waktu})`;

            // Load Mapel List
            const elMapel = ui.el('ej-mapel');
            elMapel.innerHTML = '<option value="">-- Pilih Mapel --</option>';
            elMapel.innerHTML += '<option value="ISTIRAHAT">ISTIRAHAT</option>';
            elMapel.innerHTML += '<option value="UPACARA">UPACARA</option>';
            elMapel.innerHTML += '<option value="LITERASI">LITERASI</option>';
            STANDARD_MAPEL_LIST.forEach(m => elMapel.innerHTML += `<option value="${m}">${m}</option>`);

            // Load Guru List
            const elGuru = ui.el('ej-guru');
            elGuru.innerHTML = '<option value="">-- Pilih Guru --</option>';
            // Gunakan cache atau fetch ulang
            const qGuru = query(collection(db, 'data_pengguna'), where('role', '==', 'guru'));
            const gSnap = await getDocs(qGuru);
            gSnap.forEach(d => {
                elGuru.innerHTML += `<option value="${d.id}" data-nama="${d.data().nama}">${d.data().nama}</option>`;
            });

            // If Edit Mode, fill data
            if(id) {
                const docSnap = await getDoc(doc(db, 'data_jadwal_pelajaran', id));
                if(docSnap.exists()) {
                    const d = docSnap.data();
                    elMapel.value = d.mapel;
                    elGuru.value = d.guru_id;
                }
            } else {
                elMapel.value = "";
                elGuru.value = "";
            }

            ui.show('modal-edit-jadwal');
        };

        ui.el('form-edit-jadwal').onsubmit = async (e) => {
            e.preventDefault();
            ui.loading(true);
            const hari = ui.el('jadwal-hari').value;
            const kelas = ui.el('jadwal-kelas').value;
            const jam = Number(ui.el('ej-jam').value);
            const mapel = ui.el('ej-mapel').value;
            
            const guruSelect = ui.el('ej-guru');
            const guruId = guruSelect.value;
            const guruNama = guruSelect.options[guruSelect.selectedIndex].text;

            if(!mapel) { ui.loading(false); return Swal.fire('Error', 'Pilih Mata Pelajaran', 'warning'); }

            // === CEK BENTROK JADWAL GURU ===
            // Hanya cek jika guru dipilih (bukan istirahat/kosong)
            if(guruId) {
                try {
                    // Cari di database: Guru ini, Hari ini, Jam ini
                    const qBentrok = query(collection(db, 'data_jadwal_pelajaran'), 
                        where('guru_id', '==', guruId),
                        where('hari', '==', hari),
                        where('jam_ke', '==', jam)
                    );
                    
                    const snapBentrok = await getDocs(qBentrok);
                    let dataBentrok = null;

                    snapBentrok.forEach(doc => {
                        // Abaikan jika ini adalah data yang sedang kita edit sendiri
                        if(state.editingJadwalId && doc.id === state.editingJadwalId) return;
                        
                        // Jika ketemu data lain, simpan infonya
                        dataBentrok = doc.data();
                    });

                    if(dataBentrok) {
                        ui.loading(false);
                        return Swal.fire({
                            title: 'Jadwal Bentrok!',
                            html: `Guru <b>${guruNama}</b> sudah mengajar di kelas <b class="text-red-600">${dataBentrok.kelas}</b> pada jam ke-${jam}.`,
                            icon: 'error',
                            confirmButtonColor: '#d33'
                        });
                    }
                } catch(err) {
                    console.error("Gagal cek bentrok", err);
                }
            }
            // ================================

            const data = {
                hari, kelas, jam_ke: jam, mapel,
                guru_id: guruId, guru_nama: guruNama
            };

            try {
                if(state.editingJadwalId) {
                    await updateDoc(doc(db, 'data_jadwal_pelajaran', state.editingJadwalId), data);
                } else {
                    await addDoc(collection(db, 'data_jadwal_pelajaran'), data);
                }
                window.app.closeModal('modal-edit-jadwal');
                window.app.loadJadwalGrid();
                ui.toast('Jadwal disimpan');
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
            ui.loading(false);
        };

        window.app.deleteJadwalItem = async () => {
            if(!state.editingJadwalId) return;
            if((await Swal.fire({title:'Hapus Jadwal?',icon:'warning',showCancelButton:true})).isConfirmed) {
                await deleteDoc(doc(db, 'data_jadwal_pelajaran', state.editingJadwalId));
                window.app.closeModal('modal-edit-jadwal');
                window.app.loadJadwalGrid();
                ui.toast('Terhapus');
            }
        };

        // 3. JADWAL GURU DI DASHBOARD
        window.app.loadJadwalGuruHariIni = async () => {
            const container = ui.el('widget-jadwal-guru');
            const list = ui.el('list-jadwal-guru-dashboard');
            
            // Tentukan Hari Ini (Indonesia)
            const days = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
            const today = days[new Date().getDay()];
            ui.el('lbl-hari-ini').innerText = today;

            if(today === 'Minggu') {
                container.classList.remove('hidden');
                list.innerHTML = '<div class="col-span-full text-center p-6 text-slate-400 bg-slate-50 rounded-xl">Hari libur, selamat beristirahat!</div>';
                return;
            }

            try {
                const uid = auth.currentUser.uid;
                
                // Ambil config waktu dulu buat mapping jam -> pukul
                const cfgSnap = await getDoc(doc(db, 'config_waktu_kbm', 'default'));
                const configSlots = cfgSnap.exists() ? cfgSnap.data().slots : [];

                // Query Jadwal
                const q = query(collection(db, 'data_jadwal_pelajaran'), 
                    where('guru_id', '==', uid), 
                    where('hari', '==', today)
                );
                const snap = await getDocs(q);

                if(snap.empty) {
                     container.classList.remove('hidden');
                     list.innerHTML = '<div class="col-span-full text-center p-6 text-slate-400 bg-slate-50 rounded-xl">Tidak ada jadwal mengajar hari ini.</div>';
                     return;
                }

                container.classList.remove('hidden');
                list.innerHTML = '';

                // Urutkan berdasarkan jam_ke
                let jadwalArr = [];
                snap.forEach(d => jadwalArr.push(d.data()));
                jadwalArr.sort((a,b) => a.jam_ke - b.jam_ke);

                jadwalArr.forEach(j => {
                    const time = configSlots.find(s => s.jam === j.jam_ke) || {mulai:'-', selesai:'-'};
                    
                    list.innerHTML += `
                    <div class="bg-slate-50 border border-slate-200 p-4 rounded-xl flex items-center gap-4 hover:shadow-md transition group">
                        <div class="bg-white p-3 rounded-lg border border-slate-200 text-center min-w-[60px]">
                            <div class="text-xs font-bold text-slate-400 uppercase">JAM</div>
                            <div class="text-xl font-extrabold text-brand-600">${j.jam_ke}</div>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <h4 class="font-bold text-slate-800 text-lg">${j.kelas}</h4>
                                <span class="text-xs font-mono bg-slate-200 px-2 py-0.5 rounded text-slate-600">${time.mulai} - ${time.selesai}</span>
                            </div>
                            <p class="text-sm text-slate-500 font-medium">${j.mapel}</p>
                        </div>
                    </div>`;
                });

            } catch(e) { console.error("Load Dashboard Jadwal Error", e); }
        };
        // ==========================================
        // FITUR PIKET KESISWAAN (NEW LOGIC)
        // ==========================================

        // 1. Load Siswa di Dropdown Piket
        window.app.loadSiswaPiket = async () => {
            const kelas = ui.el('piket-kelas').value;
            const selSiswa = ui.el('piket-siswa');
            
            selSiswa.innerHTML = '<option value="">Loading...</option>';
            selSiswa.disabled = true;

            if(!kelas) return;

            try {
                const q = query(collection(db, 'data_pengguna'), where('kelas', '==', kelas));
                const snap = await getDocs(q);
                
                selSiswa.innerHTML = '<option value="">-- Pilih Siswa --</option>';
                let count = 0;
                
                snap.forEach(d => {
                    const u = d.data();
                    if((u.role||'').toLowerCase() === 'siswa') {
                        selSiswa.innerHTML += `<option value="${d.id}" data-nama="${u.nama}">${u.nama}</option>`;
                        count++;
                    }
                });

                if(count === 0) selSiswa.innerHTML = '<option value="">Tidak ada siswa</option>';
                else selSiswa.disabled = false;

            } catch(e) { console.error(e); }
        };

        // 2. Render Dropdown Jenis Pelanggaran
        window.app.renderJenisPelanggaran = () => {
            const cat = ui.el('piket-kategori').value;
            const selJenis = ui.el('piket-jenis');
            
            selJenis.innerHTML = '<option value="">-- Pilih --</option>';
            
            if(!cat || !DATA_PELANGGARAN[cat]) {
                selJenis.disabled = true;
                return;
            }
            
            selJenis.disabled = false;
            DATA_PELANGGARAN[cat].items.forEach(item => {
                selJenis.innerHTML += `<option value="${item.id}" data-poin="${item.poin}" data-label="${item.label}">${item.label} (${item.poin} Poin)</option>`;
            });
        };

        // 3. Simpan Pelanggaran
        window.app.simpanPelanggaran = async () => {
            const uidSiswa = ui.el('piket-siswa').value;
            const namaSiswa = ui.el('piket-siswa').options[ui.el('piket-siswa').selectedIndex]?.text;
            const kelas = ui.el('piket-kelas').value;
            const selJenis = ui.el('piket-jenis');
            const kode = selJenis.value;
            const catatan = ui.el('piket-catatan').value;
            const fotoBukti = ui.el('piket-foto-base64').value;

            if(!uidSiswa || !kode) return Swal.fire('Eits!', 'Lengkapi data siswa dan jenis pelanggaran.', 'warning');

            const poin = Number(selJenis.options[selJenis.selectedIndex].getAttribute('data-poin'));
            const label = selJenis.options[selJenis.selectedIndex].getAttribute('data-label');

            ui.loading(true, "Menyimpan Pelanggaran...");
            try {
                await addDoc(collection(db, 'data_pelanggaran'), {
                    siswa_uid: uidSiswa,
                    siswa_nama: namaSiswa,
                    kelas: kelas,
                    kode_pelanggaran: kode,
                    nama_pelanggaran: label,
                    poin: poin,
                    catatan: catatan,
                    foto: fotoBukti,
                    pencatat_uid: auth.currentUser.uid,
                    pencatat_nama: state.profile.nama,
                    tahun_ajaran: state.schoolConfig.tahun,
                    semester: state.schoolConfig.semester,
                    timestamp: serverTimestamp()
                });

                ui.toast(`Tercatat! Poin +${poin}`);
                // Reset Form (Kecuali kelas biar cepet input lagi)
                ui.el('piket-siswa').value = '';
                ui.el('piket-kategori').value = '';
                ui.el('piket-jenis').innerHTML = '<option value="">-</option>';
                ui.el('piket-jenis').disabled = true;
                ui.el('piket-catatan').value = '';
                
                window.app.clearPiketFoto();
                window.app.loadHistoryPiket(); // Refresh tabel

            } catch(e) { Swal.fire('Error', e.message, 'error'); }
            ui.loading(false);
        };

        // 4. Load History Hari Ini
        window.app.loadHistoryPiket = async () => {
            const tb = ui.el('piket-history-body');
            tb.innerHTML = '<tr><td colspan="5" class="text-center p-4">Loading...</td></tr>';
            
            // Start of today
            const start = new Date();
            start.setHours(0,0,0,0);

            try {
                // Query dasar: Ambil data hari ini
                const q = query(collection(db, 'data_pelanggaran'), where('timestamp', '>=', start));
                const snap = await getDocs(q);
                
                let docs = [];
                snap.forEach(d => {
                    const data = d.data();
                    
                    // --- FILTER PERIODE (BUG FIX) ---
                    // Cek apakah data ini milik periode aktif
                    const isCurrentPeriod = (data.tahun_ajaran === state.schoolConfig.tahun && data.semester === state.schoolConfig.semester);
                    // Data lama tanpa tag periode tetap ditampilkan (backward compatibility)
                    const isLegacy = !data.tahun_ajaran; 

                    if(isCurrentPeriod || isLegacy) {
                        docs.push({id: d.id, ...data});
                    }
                });
                
                // Sort descending time (Terbaru diatas)
                docs.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                tb.innerHTML = '';
                if(docs.length === 0) {
                    tb.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-slate-400">Belum ada pelanggaran hari ini di periode aktif.</td></tr>';
                    return;
                }

                docs.forEach(d => {
                    const time = d.timestamp ? new Date(d.timestamp.seconds*1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '-';
                    
                    // --- LOGIC TOMBOL BUKTI FOTO (UPDATE DISINI) ---
                    const btnBukti = d.foto ? 
                        `<button onclick="Swal.fire({imageUrl: '${d.foto}', showConfirmButton: false, showCloseButton: true, width: 'auto'})" class="ml-2 text-blue-500 hover:text-blue-700 bg-blue-50 px-2 py-1 rounded text-xs border border-blue-100 transition" title="Lihat Bukti"><i class="fa-solid fa-image"></i> Bukti</button>` 
                        : '';

                    tb.innerHTML += `
                    <tr class="border-b hover:bg-slate-50">
                        <td class="px-4 py-2 text-xs font-mono">${time}</td>
                        <td class="px-4 py-2 font-bold text-slate-700">${d.siswa_nama}<br><span class="text-[10px] text-slate-400 font-normal">${d.kelas}</span></td>
                        <td class="px-4 py-2">
                            <div class="flex items-center flex-wrap gap-1">
                                <span class="text-xs font-bold text-red-600 bg-red-50 px-2 py-0.5 rounded">${d.nama_pelanggaran}</span>
                                ${btnBukti} 
                            </div>
                            ${d.catatan ? `<div class="text-[10px] text-slate-500 mt-1 italic">"${d.catatan}"</div>` : ''}
                        </td>
                        <td class="px-4 py-2 text-center font-bold text-lg text-slate-800">${d.poin}</td>
                        <td class="px-4 py-2 text-center">
                            <button onclick="window.app.hapusPelanggaran('${d.id}')" class="text-slate-400 hover:text-red-600 transition"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
                });

            } catch(e) { console.error(e); }
        };

        // 5. Hapus Pelanggaran
        window.app.hapusPelanggaran = async (id) => {
            const r = await Swal.fire({title:'Hapus Data?', text:'Poin siswa akan dikurangi kembali.', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33'});
            if(r.isConfirmed) {
                ui.loading(true);
                await deleteDoc(doc(db, 'data_pelanggaran', id));
                window.app.loadHistoryPiket();
                ui.toast('Data dihapus');
                ui.loading(false);
            }
        };
        // 7. Load Siswa untuk Filter Rekap (Mirip loadSiswaPiket tapi beda target ID)
        window.app.loadSiswaFilterPiket = async () => {
            const kelas = ui.el('filter-piket-kelas').value;
            const selSiswa = ui.el('filter-piket-siswa');
            
            selSiswa.innerHTML = '<option value="">Loading...</option>';
            selSiswa.disabled = true;

            if(!kelas) {
                selSiswa.innerHTML = '<option value="">Semua Siswa</option>';
                return;
            }

            try {
                const q = query(collection(db, 'data_pengguna'), where('kelas', '==', kelas));
                const snap = await getDocs(q);
                
                selSiswa.innerHTML = '<option value="">Semua Siswa</option>';
                let count = 0;
                
                snap.forEach(d => {
                    const u = d.data();
                    if((u.role||'').toLowerCase() === 'siswa') {
                        selSiswa.innerHTML += `<option value="${d.id}">${u.nama}</option>`;
                        count++;
                    }
                });
                selSiswa.disabled = false;
            } catch(e) { console.error(e); }
        };

        // 8. Load Data Rekapitulasi (Pencarian)
        window.app.loadRekapPiketData = async () => {
            const startStr = ui.el('filter-piket-start').value;
            const endStr = ui.el('filter-piket-end').value;
            const fKelas = ui.el('filter-piket-kelas').value;
            const fSiswaUid = ui.el('filter-piket-siswa').value;
            const tb = ui.el('tbody-rekap-piket');
            
            if(!startStr || !endStr) return Swal.fire('Filter Tanggal', 'Harap isi tanggal awal dan akhir.', 'warning');

            ui.loading(true, "Merekap data...");
            tb.innerHTML = '';
            state.currentPiketRekap = [];
            
            const startDate = new Date(startStr); startDate.setHours(0,0,0,0);
            const endDate = new Date(endStr); endDate.setHours(23,59,59,999);

            try {
                const q = query(collection(db, 'data_pelanggaran'), orderBy('timestamp', 'desc'));
                const snap = await getDocs(q);
                
                let totalPoin = 0;
                let found = false; // Ini biang keroknya tadi

                snap.forEach(d => {
                    const data = d.data();
                    const dTime = data.timestamp ? data.timestamp.toDate() : new Date(0);

                    const periodMatch = (data.tahun_ajaran === state.schoolConfig.tahun && data.semester === state.schoolConfig.semester);
                    const isLegacy = !data.tahun_ajaran;

                    const dateMatch  = dTime >= startDate && dTime <= endDate;
                    const kelasMatch = fKelas ? (data.kelas === fKelas) : true;
                    const siswaMatch = fSiswaUid ? (data.siswa_uid === fSiswaUid) : true;

                    if((periodMatch || isLegacy) && dateMatch && kelasMatch && siswaMatch) {
                        
                        // FIX: Set found jadi true biar tabel gak ketimpa pesan kosong
                        found = true; 

                        state.currentPiketRekap.push(data);
                        totalPoin += Number(data.poin) || 0;

                        const timeStr = dTime.toLocaleDateString('id-ID', {
                            day: 'numeric', month: 'short', year: 'numeric',
                            hour: '2-digit', minute: '2-digit'
                        });

                        // TAMBAHAN: Kolom Aksi (Edit & Hapus)
                        tb.innerHTML += `
                        <tr class="border-b hover:bg-slate-50">
                            <td class="px-4 py-2 font-mono text-xs text-slate-500">${timeStr}</td>
                            <td class="px-4 py-2 font-bold text-slate-700">${data.siswa_nama || '-'}</td>
                            <td class="px-4 py-2 text-xs">${data.kelas || '-'}</td>
                            <td class="px-4 py-2">
                                <span class="bg-red-50 text-red-700 px-2 py-1 rounded text-xs font-bold border border-red-100">
                                    ${data.nama_pelanggaran || '-'}
                                </span>
                            </td>
                            <td class="px-4 py-2 text-xs italic text-slate-500">${data.catatan || '-'}</td>
                            <td class="px-4 py-2 text-center font-bold text-slate-800">${data.poin ?? 0}</td>
                            <td class="px-4 py-2 text-xs text-slate-500">${data.pencatat_nama || '-'}</td>
                            
                            <!-- TOMBOL AKSI DISINI -->
                            <td class="px-4 py-2 text-right flex justify-end gap-2">
                                <button onclick="window.app.editPelanggaran('${d.id}', '${data.poin}', '${data.catatan}')" class="text-blue-500 hover:bg-blue-50 p-2 rounded-lg transition" title="Edit"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="window.app.hapusPelanggaran('${d.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded-lg transition" title="Hapus"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>`;
                    }
                });

                ui.el('total-poin-rekap').innerText = totalPoin;

                // Logika ini sekarang aman karena variabel 'found' sudah di-update di atas
                if(!found) {
                    tb.innerHTML = '<tr><td colspan="8" class="p-8 text-center text-slate-400">Tidak ditemukan data pelanggaran pada periode/filter ini.</td></tr>';
                }

            } catch(e) { console.error(e); Swal.fire('Error', e.message, 'error'); }
            ui.loading(false);
        };

        // 9. Export Excel Rekap Piket
        window.app.exportRekapPiket = () => {
            if(!state.currentPiketRekap || state.currentPiketRekap.length === 0) return Swal.fire('Data Kosong', 'Tampilkan data terlebih dahulu sebelum download.', 'warning');
            
            const dataExport = state.currentPiketRekap.map(d => ({
                Tanggal: d.timestamp ? new Date(d.timestamp.seconds*1000).toLocaleString() : '-',
                Nama_Siswa: d.siswa_nama,
                Kelas: d.kelas,
                Jenis_Pelanggaran: d.nama_pelanggaran,
                Kode: d.kode_pelanggaran,
                Poin: d.poin,
                Catatan: d.catatan || '-',
                Petugas_Pencatat: d.pencatat_nama
            }));

            const ws = XLSX.utils.json_to_sheet(dataExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Rekap Pelanggaran");
            
            const start = ui.el('filter-piket-start').value;
            XLSX.writeFile(wb, `Laporan_Pelanggaran_${start}.xlsx`);
        };

        // 6. Cek Poin Siswa (Untuk Tampilan Siswa)
        // 6. Cek Poin Siswa (Updated dengan Filter Periode)
        window.app.checkMyViolations = async () => {
            const card = ui.el('stu-card-pelanggaran');
            const txtPoin = ui.el('stu-poin-pelanggaran');
            const txtStatus = ui.el('stu-status-sanksi');

            try {
                // Pastikan config sekolah sudah ada
                if (!state.schoolConfig) {
                    console.warn('School config belum diload');
                    return;
                }

                const q = query(
                    collection(db, 'data_pelanggaran'),
                    where('siswa_uid', '==', auth.currentUser.uid)
                );

                const snap = await getDocs(q);

                let total = 0;

                snap.forEach(d => {
                    const data = d.data();

                    // =========================
                    // FILTER PERIODE AKTIF
                    // =========================
                    if(!data.tahun_ajaran || (data.tahun_ajaran === state.schoolConfig.tahun && data.semester === state.schoolConfig.semester)) {
                        total += data.poin || 0;
                    }
                });

                if (total > 0) {
                    card.classList.remove('hidden');
                    txtPoin.innerText = total;

                    // =========================
                    // LOGIC STATUS SANKSI
                    // =========================
                    let status = 'AMAN';
                    let color  = 'bg-green-100 text-green-700 border-green-200';

                    if (total >= 150) {
                        status = 'DIKEMBALIKAN KE ORTU';
                        color  = 'bg-black text-white border-black';
                    } else if (total >= 100) {
                        status = 'SKORSING';
                        color  = 'bg-red-600 text-white border-red-700';
                    } else if (total >= 75) {
                        status = 'PANGGILAN ORTU';
                        color  = 'bg-red-100 text-red-700 border-red-200';
                    } else if (total >= 50) {
                        status = 'SURAT PERINGATAN 1';
                        color  = 'bg-orange-100 text-orange-700 border-orange-200';
                    } else if (total >= 25) {
                        status = 'TEGURAN LISAN';
                        color  = 'bg-yellow-100 text-yellow-700 border-yellow-200';
                    }

                    txtStatus.className = `px-3 py-1 rounded-lg text-xs font-bold border ${color}`;
                    txtStatus.innerText = status;
                } else {
                    card.classList.add('hidden');
                }

            } catch (e) {
                console.error('Gagal load pelanggaran siswa', e);
            }
        };
        // Fungsi Edit Pelanggaran (Quick Edit)
        window.app.editPelanggaran = async (id, currentPoin, currentNote) => {
            const { value: formValues } = await Swal.fire({
                title: 'Edit Pelanggaran',
                html:
                    `<label class="text-xs font-bold block text-left mb-1">Poin</label>` +
                    `<input id="swal-poin" class="swal2-input" type="number" value="${currentPoin}" style="margin:0 0 1rem 0;">` +
                    `<label class="text-xs font-bold block text-left mb-1">Catatan</label>` +
                    `<input id="swal-catatan" class="swal2-input" value="${currentNote || ''}" style="margin:0;">`,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Simpan',
                preConfirm: () => {
                    return [
                        document.getElementById('swal-poin').value,
                        document.getElementById('swal-catatan').value
                    ]
                }
            });

            if (formValues) {
                ui.loading(true);
                try {
                    await updateDoc(doc(db, 'data_pelanggaran', id), {
                        poin: Number(formValues[0]),
                        catatan: formValues[1],
                        updated_at: serverTimestamp()
                    });
                    ui.toast('Data diperbarui');
                    window.app.loadRekapPiketData(); // Refresh tabel rekap
                } catch(e) {
                    Swal.fire('Error', e.message, 'error');
                }
                ui.loading(false);
            }
        };
        // === LOGIC FOTO PIKET (BARU) ===
        window.app.handlePiketFoto = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        // Kompresi Gambar pakai Canvas
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 800; // Resize ke max 800px biar ringan
                        const scale = MAX_WIDTH / img.width;
                        
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scale;
                        
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        // Ubah ke JPEG kualitas 60%
                        const compressed = canvas.toDataURL('image/jpeg', 0.6);
                        
                        // Set ke hidden input & tampilkan preview
                        document.getElementById('piket-foto-base64').value = compressed;
                        const prev = document.getElementById('piket-foto-preview');
                        prev.style.backgroundImage = `url(${compressed})`;
                        prev.classList.remove('hidden');
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.app.clearPiketFoto = () => {
            document.getElementById('piket-foto-input').value = '';
            document.getElementById('piket-foto-base64').value = '';
            document.getElementById('piket-foto-preview').classList.add('hidden');
        };

        // ==========================================
        // FITUR PERIODE AKADEMIK (NEW CORE)
        // ==========================================

        // 1. Load Config Sekolah saat Startup
        window.app.loadSchoolConfig = async () => {
            try {
                const docRef = doc(db, 'config_sekolah', 'utama');
                const snap = await getDoc(docRef);
                if (snap.exists()) {
                    state.schoolConfig = snap.data();
                } else {
                    // Kalau belum ada, buat default
                    await setDoc(docRef, state.schoolConfig);
                }
                
                // Update Label di UI Dashboard
                const lbl = document.getElementById('lbl-periode-aktif');
                if(lbl) lbl.innerText = `${state.schoolConfig.tahun} (${state.schoolConfig.semester})`;
                
                console.log("Periode Aktif:", state.schoolConfig);
            } catch (e) {
                console.error("Gagal load config sekolah:", e);
            }
        };

        // 2. Buka Modal Config
        window.app.openSchoolConfig = () => {
            ui.el('cfg-tahun').value = state.schoolConfig.tahun;
            ui.el('cfg-semester').value = state.schoolConfig.semester;
            ui.show('modal-school-config');
        };

        // 3. Simpan Config Baru
        window.app.saveSchoolConfig = async () => {
            const thn = ui.el('cfg-tahun').value;
            const sem = ui.el('cfg-semester').value;
            
            ui.loading(true, "Menyimpan Periode...");
            try {
                const newData = { tahun: thn, semester: sem };
                await setDoc(doc(db, 'config_sekolah', 'utama'), newData);
                state.schoolConfig = newData;
                
                // Update Label UI
                const lbl = document.getElementById('lbl-periode-aktif');
                if(lbl) lbl.innerText = `${thn} (${sem})`;

                window.app.closeModal('modal-school-config');
                Swal.fire('Berhasil', `Periode aktif diubah ke ${thn} - ${sem}`, 'success')
                .then(() => location.reload()); // Reload biar aman semua data terefresh
                
            } catch(e) {
                Swal.fire('Error', e.message, 'error');
            }
            ui.loading(false);
        };
        // ==========================================
        // FITUR KENAIKAN KELAS (PROMOTE)
        // ==========================================
        window.app.openModalPromote = () => {
            // Isi dropdown kelas
            const opts = window.app.generateClassOptions(false);
            ui.el('prm-sumber').innerHTML = opts;
            
            // Tambah opsi "LULUS / ALUMNI" di target
            let targetOpts = opts;
            targetOpts += `<option value="ALUMNI" class="font-bold text-green-600"> LULUS (Jadikan Alumni)</option>`;
            ui.el('prm-tujuan').innerHTML = targetOpts;
            
            ui.show('modal-promote');
        };

        window.app.processPromote = async () => {
            const src = ui.el('prm-sumber').value;
            const dest = ui.el('prm-tujuan').value;

            if(!src || !dest) return Swal.fire('Error', 'Pilih kelas asal dan tujuan.', 'warning');
            if(src === dest) return Swal.fire('Error', 'Kelas asal dan tujuan tidak boleh sama.', 'warning');

            const confirm = await Swal.fire({
                title: 'Yakin memindahkan siswa?',
                text: `Semua siswa dari ${src} akan pindah ke ${dest}.`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#4f46e5',
                confirmButtonText: 'Ya, Proses'
            });

            if(confirm.isConfirmed) {
                ui.loading(true, `Memindahkan siswa ${src} ke ${dest}...`);
                try {
                    // 1. Ambil siswa di kelas sumber
                    const q = query(collection(db, 'data_pengguna'), where('kelas', '==', src));
                    const snap = await getDocs(q);
                    
                    if(snap.empty) throw new Error("Tidak ada siswa di kelas sumber.");

                    // 2. Update Batch (Maks 500 ops per batch di Firestore)
                    const batch = writeBatch(db);
                    let count = 0;

                    snap.forEach(docSnap => {
                        const userRef = doc(db, 'data_pengguna', docSnap.id);
                        // Update kelas baru & catat history kelas lama (opsional, buat tracking)
                        batch.update(userRef, { 
                            kelas: dest,
                            updated_at: serverTimestamp()
                        });
                        count++;
                    });

                    await batch.commit();
                    
                    window.app.closeModal('modal-promote');
                    window.app.loadMasterKelas(); // Refresh tampilan kelas
                    Swal.fire('Sukses', `${count} Siswa berhasil dipindahkan ke ${dest}.`, 'success');

                } catch(e) {
                    Swal.fire('Gagal', e.message, 'error');
                }
                ui.loading(false);
            }
        };
                // === LOGIC UPDATE: PIKET GTK & DATABASE ===

        // 1. Helper: Refresh Kedua Tabel (Siswa & GTK) saat ganti tanggal input
        window.app.refreshPiketTables = () => {
            window.app.loadPiketAbsensiHariIni();
            window.app.loadPiketAbsensiGtkHariIni();
        };

        // 2. Load List GTK untuk Dropdown
        window.app.loadGtkForPiket = async () => {
            const sel = ui.el('absen-gtk-nama');
            if(!sel) return;
            
                    try {
                // Ambil SEMUA user dulu (biar aman sort & filternya)
                const snap = await getDocs(collection(db, 'data_pengguna'));
                
                sel.innerHTML = '<option value="">-- Pilih Nama --</option>';
                let list = [];
                
                snap.forEach(d => {
                    const u = d.data();
                    // Normalisasi role ke huruf kecil & buang spasi
                    const role = (u.role || '').toLowerCase().trim();
                    
                    // FILTER: Masukkan hanya jika BUKAN 'siswa'
                    // (Jadi Guru, Admin, Piket, Staff akan masuk sini)
                    if(role !== 'siswa' && u.nama) {
                        list.push({id: d.id, nama: u.nama});
                    }
                });
                
                // Sort Abjad Nama A-Z
                list.sort((a,b) => a.nama.localeCompare(b.nama));
                
                list.forEach(u => {
                    sel.innerHTML += `<option value="${u.id}" data-nama="${u.nama}">${u.nama}</option>`;
                });
            } catch(e) { console.error(e); }
        };

        // 3. Simpan Absen GTK (Database: data_absensi_gtk)
        window.app.simpanAbsenGtk = async () => {
            const tgl = ui.el('absen-piket-tgl').value;
            const uid = ui.el('absen-gtk-nama').value;
            const nama = ui.el('absen-gtk-nama').options[ui.el('absen-gtk-nama').selectedIndex]?.text;
            const statusEl = document.querySelector('input[name="gtk-status"]:checked');
            const tugasEl = document.querySelector('input[name="gtk-tugas"]:checked');

            if(!tgl) return Swal.fire('Tanggal', 'Isi tanggal dulu.', 'warning');
            if(!uid || !statusEl) return Swal.fire('Data Kurang', 'Pilih nama GTK dan status.', 'warning');

            ui.loading(true);
            try {
                await addDoc(collection(db, 'data_absensi_gtk'), {
                    tanggal: tgl,
                    gtk_uid: uid,
                    gtk_nama: nama,
                    status: statusEl.value, // Sakit, Izin, Alpha, Dinas
                    tugas: tugasEl ? tugasEl.value : 'Tidak Ada',
                    timestamp: serverTimestamp()
                });
                
                ui.toast('Data GTK Disimpan');
                
                // Reset Radio
                document.querySelectorAll('input[name="gtk-status"]').forEach(r => r.checked = false);
                ui.el('absen-gtk-nama').value = '';
                
                window.app.loadPiketAbsensiGtkHariIni(); // Refresh tabel kanan bawah
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
            ui.loading(false);
        };

        // 4. Load Tabel GTK Hari Ini
        window.app.loadPiketAbsensiGtkHariIni = async () => {
            const tgl = ui.el('absen-piket-tgl').value;
            const tb = ui.el('tbody-absen-gtk-today');
            const lbl = ui.el('lbl-date-gtk');
            
            if(lbl) lbl.innerText = tgl;
            tb.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Loading...</td></tr>';

            try {
                const q = query(collection(db, 'data_absensi_gtk'), where('tanggal', '==', tgl));
                const snap = await getDocs(q);
                
                tb.innerHTML = '';
                if(snap.empty) {
                    tb.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400">Belum ada data GTK.</td></tr>';
                    return;
                }

                snap.forEach(d => {
                    const dt = d.data();
                    // Badge Warna Status
                    let color = 'bg-slate-100 text-slate-600';
                    if(dt.status === 'Sakit') color = 'bg-blue-100 text-blue-700';
                    if(dt.status === 'Izin') color = 'bg-yellow-100 text-yellow-700';
                    if(dt.status === 'Alpha') color = 'bg-red-100 text-red-700';
                    if(dt.status === 'Dinas') color = 'bg-purple-100 text-purple-700';

                    const tugasIcon = dt.tugas === 'Ada' 
                        ? '<span class="text-green-600 font-bold text-xs"><i class="fa-solid fa-check"></i> Ada</span>' 
                        : '<span class="text-slate-400 text-xs">-</span>';

                    tb.innerHTML += `
                    <tr class="border-b">
                        <td class="p-3 font-bold text-slate-700">${dt.gtk_nama}</td>
                        <td class="p-3 text-center"><span class="${color} px-2 py-1 rounded text-xs font-bold">${dt.status}</span></td>
                        <td class="p-3 text-center">${tugasIcon}</td>
                        <td class="p-3 text-right">
                            <button onclick="window.app.deleteAbsenGtk('${d.id}')" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
            } catch(e) { console.error(e); }
        };

        window.app.deleteAbsenGtk = async (id) => {
            if((await Swal.fire({title:'Hapus?',icon:'warning',showCancelButton:true})).isConfirmed){
                await deleteDoc(doc(db,'data_absensi_gtk',id));
                window.app.loadPiketAbsensiGtkHariIni();
            }
        };

        // 5. UPDATE: SWITCH TAB (Init Dropdown GTK)
        window.app.switchPiketTab = (tab) => {
            document.querySelectorAll('.piket-tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-piket-${tab}`).classList.add('active');
            
            ui.hide('view-piket-pelanggaran');
            ui.hide('view-piket-absensi');
            
            if(tab === 'pelanggaran') {
                ui.show('view-piket-pelanggaran');
            } else {
                ui.show('view-piket-absensi');
                const pk = ui.el('absen-piket-kelas');
                if(pk.options.length <= 1) pk.innerHTML = window.app.generateClassOptions(false);
                
                // Default tanggal hari ini
                if(!ui.el('absen-piket-tgl').value) ui.el('absen-piket-tgl').valueAsDate = new Date();
                if(!ui.el('rekap-piket-tgl').value) ui.el('rekap-piket-tgl').valueAsDate = new Date(); // Default rekap juga

                // Load Data
                window.app.loadGtkForPiket(); // Load dropdown GTK
                window.app.loadPiketAbsensiHariIni(); // Load tabel siswa
                window.app.loadPiketAbsensiGtkHariIni(); // Load tabel GTK
            }
        };

        // 2. Load Siswa utk Dropdown
        window.app.loadSiswaAbsenPiket = async () => {
            const kelas = ui.el('absen-piket-kelas').value;
            const sel = ui.el('absen-piket-siswa');
            sel.innerHTML = '<option>Loading...</option>'; sel.disabled=true;
            
            try {
                const q = query(collection(db, 'data_pengguna'), where('kelas', '==', kelas));
                const snap = await getDocs(q);
                sel.innerHTML = '<option value="">-- Pilih Siswa --</option>';
                snap.forEach(d => {
                    const u = d.data();
                    if((u.role||'').toLowerCase() === 'siswa') 
                        sel.innerHTML += `<option value="${d.id}" data-nama="${u.nama}">${u.nama}</option>`;
                });
                sel.disabled = false;
            } catch(e) { console.error(e); }
        };

        // 3. Simpan Data Absen Manual (Inputan Piket)
        window.app.simpanAbsenPiket = async () => {
            const tgl = ui.el('absen-piket-tgl').value;
            const uidSiswa = ui.el('absen-piket-siswa').value;
            const namaSiswa = ui.el('absen-piket-siswa').options[ui.el('absen-piket-siswa').selectedIndex]?.text;
            const kelas = ui.el('absen-piket-kelas').value;
            const statusEl = document.querySelector('input[name="absen-status"]:checked');
            
            if(!uidSiswa || !statusEl) return Swal.fire('Lengkapi Data', 'Pilih siswa dan status kehadiran.', 'warning');
            
            ui.loading(true);
            try {
                // Simpan ke koleksi khusus 'data_absensi_piket' agar tidak bentrok dengan presensi guru mapel
                await addDoc(collection(db, 'data_absensi_piket'), {
                    tanggal: tgl,
                    siswa_uid: uidSiswa,
                    siswa_nama: namaSiswa,
                    kelas: kelas,
                    status: statusEl.value, // S, I, A
                    timestamp: serverTimestamp()
                });
                
                ui.toast('Data ditambahkan');
                window.app.loadPiketAbsensiHariIni();
                window.app.generatePreviewRekap(); // Refresh preview
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
            ui.loading(false);
        };

        // 4. Load Data Absen Hari Ini (Tabel Kecil)
        window.app.loadPiketAbsensiHariIni = async () => {
            const tgl = ui.el('absen-piket-tgl').value;
            const tb = ui.el('tbody-absen-piket-today');
            tb.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Loading...</td></tr>';
            
            const q = query(collection(db, 'data_absensi_piket'), where('tanggal', '==', tgl));
            const snap = await getDocs(q);
            
            tb.innerHTML = '';
            if(snap.empty) {
                tb.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400">Belum ada inputan.</td></tr>';
                return;
            }
            
            snap.forEach(d => {
                const dt = d.data();
                let badge = '';
                if(dt.status === 'S') badge = '<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">Sakit</span>';
                if(dt.status === 'I') badge = '<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs font-bold">Izin</span>';
                if(dt.status === 'A') badge = '<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold">Alpha</span>';
                
                tb.innerHTML += `
                <tr class="border-b">
                    <td class="p-3 font-bold text-slate-700">${dt.siswa_nama}</td>
                    <td class="p-3">${dt.kelas}</td>
                    <td class="p-3 text-center">${badge}</td>
                    <td class="p-3 text-right">
                        <button onclick="window.app.hapusAbsenPiket('${d.id}')" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`;
            });
        };

        window.app.hapusAbsenPiket = async (id) => {
            if((await Swal.fire({title:'Hapus?',icon:'warning',showCancelButton:true})).isConfirmed){
                await deleteDoc(doc(db,'data_absensi_piket',id));
                window.app.loadPiketAbsensiHariIni();
                window.app.generatePreviewRekap();
            }
        };

        // === LOGIC UPDATE: PIKET REKAP & GTK ===

        // A. Fungsi Proses Data (Tombol Biru) - REVISI ANTI-ZONK
            window.app.prosesRekapHarian = async () => {
            const tgl = ui.el('rekap-piket-tgl').value;
            if(!tgl) return Swal.fire('Pilih Tanggal', 'Tentukan tanggal rekap dulu bro.', 'warning');

            ui.loading(true, 'Menarik Data Database...');
            const tb = ui.el('tbody-rekap-harian-piket');
            tb.innerHTML = '<tr><td colspan="8" class="p-8 text-center text-slate-500"><div class="loader mx-auto mb-2"></div>Memproses...</td></tr>';

            try {
                // A. PROSES SISWA
                const qAbsen = query(collection(db, 'data_absensi_piket'), where('tanggal', '==', tgl));
                const snapAbsen = await getDocs(qAbsen);
                const mapAbsen = {};
                
                snapAbsen.forEach(d => {
                    const dt = d.data();
                    const kls = (dt.kelas || '').trim();
                    if(!mapAbsen[kls]) mapAbsen[kls] = {S:0, I:0, A:0, details: []};
                    mapAbsen[kls][dt.status]++;
                    mapAbsen[kls].details.push(`${dt.siswa_nama} (${dt.status})`);
                });

                // Hitung total siswa (User DB)
                const snapUser = await getDocs(collection(db, 'data_pengguna'));
                const mapKelas = {};
                snapUser.forEach(d => {
                    const u = d.data();
                    if((u.role||'').toLowerCase() === 'siswa' && u.kelas) {
                        mapKelas[u.kelas.trim()] = (mapKelas[u.kelas.trim()] || 0) + 1;
                    }
                });

                // B. PROSES GTK (FETCH FROM DB)
                const qGtk = query(collection(db, 'data_absensi_gtk'), where('tanggal', '==', tgl));
                const snapGtk = await getDocs(qGtk);
                
                const gtkStats = { Sakit:0, Izin:0, Alpha:0, Dinas:0, details:[] };
                snapGtk.forEach(d => {
                    const dt = d.data();
                    if(gtkStats[dt.status] !== undefined) gtkStats[dt.status]++;
                    gtkStats.details.push({
                        nama: dt.gtk_nama,
                        status: dt.status,
                        tugas: dt.tugas
                    });
                });

                // C. RENDER KE UI REKAP
                // 1. Isi Inputan GTK Otomatis
                const totalGtk = Number(ui.el('gtk-total').value); // Total master dari input manual (biarin aja manual totalnya)
                const tidakHadirGtk = gtkStats.Sakit + gtkStats.Izin + gtkStats.Alpha + gtkStats.Dinas;
                const hadirGtk = totalGtk - tidakHadirGtk;

                ui.el('gtk-hadir').value = hadirGtk < 0 ? 0 : hadirGtk;
                ui.el('gtk-sakit').value = gtkStats.Sakit;
                ui.el('gtk-izin').value = gtkStats.Izin;
                ui.el('gtk-alpha').value = gtkStats.Alpha;
                
                // Simpan data GTK ke state global untuk export
                state.tempRekapGtk = gtkStats; 

                // 2. Render Tabel Siswa
                tb.innerHTML = '';
                state.tempRekapPiket = []; 
                const sortedKelas = Object.keys(mapKelas).sort((a, b) => a.localeCompare(b, 'id', { numeric: true, sensitivity: 'base' }));

                sortedKelas.forEach((k, i) => {
                    const total = mapKelas[k];
                    const dataAbs = mapAbsen[k] || {S:0, I:0, A:0, details: []};
                    const hadir = total - (dataAbs.S + dataAbs.I + dataAbs.A);
                    const persen = total > 0 ? Math.round((hadir/total)*100) : 0;
                    
                    state.tempRekapPiket.push({
                        kelas: k, total, hadir, s: dataAbs.S, i: dataAbs.I, a: dataAbs.A, 
                        persen, details: dataAbs.details
                    });
                    
                    tb.innerHTML += `
                    <tr class="border-b hover:bg-slate-50">
                        <td class="p-3 text-center border-r">${i+1}</td>
                        <td class="p-3 font-bold border-r text-slate-700">${k}</td>
                        <td class="p-3 text-center border-r font-bold">${total}</td>
                        <td class="p-3 text-center text-green-700 bg-green-50 border-r font-bold">${hadir}</td>
                        <td class="p-3 text-center text-blue-700 bg-blue-50 border-r">${dataAbs.S}</td>
                        <td class="p-3 text-center text-yellow-700 bg-yellow-50 border-r">${dataAbs.I}</td>
                        <td class="p-3 text-center text-red-700 bg-red-50 border-r">${dataAbs.A}</td>
                        <td class="p-3 text-center font-bold text-slate-800">${persen}%</td>
                    </tr>`;
                });

                ui.show('area-input-gtk');
                const btnDown = ui.el('btn-download-rekap');
                btnDown.disabled = false;
                btnDown.classList.remove('opacity-50', 'cursor-not-allowed');

            } catch(e) { console.error(e); Swal.fire('Error', e.message, 'error'); }
            ui.loading(false);
        };

        // B. Logic Tambah Baris Input GTK (Dinamis)
        window.app.addRowGtkAbsen = () => {
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-12 gap-2 items-center animate-fade-in gtk-absen-row';
            div.innerHTML = `
                <div class="md:col-span-5">
                    <input type="text" placeholder="Nama Guru / Tendik" class="gtk-nama w-full border p-2 rounded text-sm">
                </div>
                <div class="md:col-span-2">
                    <select class="gtk-status w-full border p-2 rounded text-sm bg-white">
                        <option value="Sakit">Sakit</option>
                        <option value="Izin">Izin</option>
                        <option value="Alpha">Alpha</option>
                        <option value="Dinas">Dinas Luar</option>
                    </select>
                </div>
                <div class="md:col-span-4">
                    <select class="gtk-tugas w-full border p-2 rounded text-sm bg-white">
                        <option value="Ada Tugas"> Ada Tugas</option>
                        <option value="Tidak Ada"> Tidak Ada Tugas</option>
                    </select>
                </div>
                <div class="md:col-span-1 text-center">
                    <button onclick="this.parentElement.parentElement.remove()" class="text-red-500 hover:bg-red-50 p-2 rounded"><i class="fa-solid fa-times"></i></button>
                </div>
            `;
            ui.el('container-gtk-absen').appendChild(div);
        };

        // C. Export Excel Lengkap (Updated)
       window.app.exportLaporanPiket = () => {
            if(!state.tempRekapPiket) return;
            const tgl = ui.el('rekap-piket-tgl').value;
            
            // 1. Ambil Data GTK dari Inputan (Hasil Proses)
            const statGtk = [
                ui.el('gtk-total').value, ui.el('gtk-hadir').value, 
                ui.el('gtk-sakit').value, ui.el('gtk-izin').value, ui.el('gtk-alpha').value
            ];

            // === SHEET 1: REKAPITULASI ===
            const dataSheet1 = [
                ["LAPORAN HARIAN PIKET SEKOLAH"],
                ["Tanggal:", tgl],
                [""],
                ["A. REKAPITULASI KEHADIRAN GTK"],
                ["Total GTK", "Hadir", "Sakit", "Izin", "Alpha"],
                statGtk,
                [""],
                ["B. RINCIAN GTK TIDAK HADIR"],
                ["No", "Nama GTK", "Keterangan", "Status Tugas"]
            ];
            
            // Ambil detail GTK dari state (bukan DOM)
            if(state.tempRekapGtk && state.tempRekapGtk.details.length > 0){
                state.tempRekapGtk.details.forEach((row, i) => {
                    dataSheet1.push([i+1, row.nama, row.status, row.tugas]);
                });
            } else {
                dataSheet1.push(["-", "Nihil (Semua Hadir)", "-", "-"]);
            }

            dataSheet1.push([""], ["C. REKAPITULASI KEHADIRAN SISWA"], ["No", "Kelas", "Jml Siswa", "Hadir", "Sakit", "Izin", "Alpha", "% Kehadiran"]);
            
            state.tempRekapPiket.forEach((d, i) => {
                dataSheet1.push([i+1, d.kelas, d.total, d.hadir, d.s, d.i, d.a, d.persen+'%']);
            });

            // === SHEET 2: DAFTAR NAMA SISWA ===
            const dataSheet2 = [
                ["DAFTAR SISWA TIDAK HADIR"],
                ["Tanggal:", tgl],
                [""],
                ["No", "Kelas", "Nama Siswa", "Keterangan"]
            ];
            
            let no = 1;
            state.tempRekapPiket.forEach(d => {
                if(d.details.length > 0) {
                    d.details.forEach(det => {
                        const parts = det.match(/(.*) \((.*)\)/);
                        const nama = parts ? parts[1] : det;
                        const kode = parts ? parts[2] : '';
                        let ket = '-';
                        if(kode === 'S') ket = 'Sakit';
                        else if(kode === 'I') ket = 'Izin';
                        else if(kode === 'A') ket = 'Alpha';
                        dataSheet2.push([no++, d.kelas, nama, ket]);
                    });
                }
            });

            const wb = XLSX.utils.book_new();
            const ws1 = XLSX.utils.aoa_to_sheet(dataSheet1);
            const ws2 = XLSX.utils.aoa_to_sheet(dataSheet2);
            
            ws1['!cols'] = [{wch:5}, {wch:25}, {wch:15}, {wch:15}, {wch:10}];
            ws2['!cols'] = [{wch:5}, {wch:15}, {wch:35}, {wch:15}];

            XLSX.utils.book_append_sheet(wb, ws1, "Rekapitulasi");
            XLSX.utils.book_append_sheet(wb, ws2, "Rincian Absen Siswa");
            
            XLSX.writeFile(wb, `Laporan_Piket_${tgl}.xlsx`);
        };

        // Tambahkan inisialisasi tanggal hari ini di onload atau switchTab
        // (Pastikan rekap-piket-tgl defaultnya hari ini saat tab dibuka)
    </script>
</body>
</html>
